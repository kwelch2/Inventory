<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Expiring Supplies – GC EMS</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666;--ok:#e7f7ee;--warn:#fff7e6;--bad:#fdecea}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
  h1{margin:0 0 6px}
  .muted{color:var(--muted);font-size:.9rem}
  .toolbar{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
  select,button,input{padding:8px 10px;border:1px solid var(--b);border-radius:10px;background:#fff}
  button{cursor:pointer}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  th{font-weight:600;background:#fafafa}
  tbody tr:last-child td{border-bottom:none}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--b);font-size:.8rem}
  .ok{background:var(--ok)}
  .warn{background:var(--warn)}
  .bad{background:var(--bad)}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .btn{padding:6px 10px;border:1px solid var(--b);border-radius:10px;background:#fafafa}
  .btn.red{border-color:#c00}
  .btn.yellow{border-color:#c90}
  .btn.green{border-color:#090}
  .right{text-align:right}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  /* Modal */
  .modal{display:none;position:fixed;z-index:99;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.35)}
  .modal-content{background:#fff;margin:10% auto;padding:16px;border:1px solid var(--b);width:min(540px,92%);border-radius:12px}
  .close-btn{float:right;font-size:24px;cursor:pointer}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .chipbar{display:flex;gap:6px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Expiring Supplies</h1>
    <div class="muted">Loads Inventory via CSV, computes Days to Expire locally, merges Catalog & Units, supports status updates and quick add.</div>
    <div class="toolbar">
      <label>Window
        <select id="rangeSel">
          <option value="30">30 days</option>
          <option value="60">60 days</option>
          <option value="90" selected>90 days</option>
          <option value="120">120 days</option>
        </select>
      </label>
      <label>Unit
        <select id="unitSel"><option value="ALL">ALL</option></select>
      </label>
      <label>Status
        <select id="statusSel">
          <option value="">All</option>
          <option value="Expired">Expired</option>
          <option value="Replace">Replace</option>
          <option value="Ordered">Ordered</option>
          <option value="OK">OK</option>
        </select>
      </label>
      <input id="searchBox" placeholder="Search item, lot, compartment…"/>
      <button class="btn" id="refreshBtn">Refresh</button>
      <span class="spacer"></span>
      <button class="btn" id="showAddItemModal">+ Add Item</button>
      <span id="count" class="muted"></span>
    </div>
  </div>

  <div id="content" class="card"></div>
</div>

<!-- Add Item Modal -->
<div id="addItemModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h3>Add Item to Inventory</h3>
    <div class="grid2">
      <div>
        <label>Item</label>
        <input id="addItemInput" list="itemsDatalist" placeholder="Start typing name…" />
        <datalist id="itemsDatalist"></datalist>
      </div>
      <div>
        <label>Compartment</label>
        <select id="addCompartmentSelect">
          <option value="">Select…</option>
          <option>Wall</option>
          <option>Bag</option>
          <option>Supply RM</option>
        </select>
      </div>
      <div>
        <label>Expiry Month</label>
        <div id="addExpiryChips" class="chipbar"></div>
      </div>
      <div>
        <label>Quantity</label>
        <input id="addQty" type="number" min="1" step="1" value="1"/>
      </div>
    </div>
    <button id="saveNewItemBtn" class="btn" style="width:100%;margin-top:12px;">Save Item</button>
  </div>
</div>

<script>
/*** ========== CONFIG: EDIT THESE ========== ***/
const CSV_INVENTORY = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=0&single=true&output=csv';
const CSV_CATALOG   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=1603897332&single=true&output=csv';
const CSV_UNITS     = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=767202807&single=true&output=csv';
const WEBAPP_URL    = 'https://script.google.com/macros/s/AKfycbypxL0KxxXMVRieHHuvX98m9Jx6fYJWTdrMLQNkt99Sgt0vNzRDeyGiDz5fILlORP8wFQ/exec';
const TOKEN         = '9mB4zR7kP2fW6vNqE1jH8aLcV5gT_sYx0uI-oZ3pD9bX4wK7eS6hF-EMS';

/*** ========== HELPERS ========== ***/
const $ = s => document.querySelector(s);
const idx = (h, n) => h.indexOf(n);
function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
function parseCSV(text){
  const clean = (text||'').replace(/^\uFEFF/,'').trim();
  if (!clean) return [];
  return clean.split(/\r?\n/).map(line => {
    const m = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
    return m.map(s => s.replace(/^"|"$/g, ''));
  });
}
function parseExpiryDate(s){
  if (!s) return null;
  let t = String(s).trim();

  // Pull date out of parentheses if present:  "NEW-… (10/31/2025 18:00:00)" or "11/1/2025 18:00:00 (Pending)"
  const par = t.match(/\(([^)]+)\)/);
  if (par && par[1]) t = par[1].trim();

  // Strip trailing markers
  t = t.replace(/\s*\((?:Pending|WebApp)\)\s*$/i, '').trim();

  // Epoch ms (12+ digits)
  if (/^\d{12,}$/.test(t)) {
    const d = new Date(Number(t));
    return isNaN(d) ? null : d;
  }

  // Excel serial (numeric)
  if (/^\d+(\.\d+)?$/.test(t)) {
    return excelSerialToDate(t);
  }

  // YYYY-MM or YYYY-MM-DD
  if (/^\d{4}-\d{2}(-\d{2})?$/.test(t)) {
    const [y,m,d='01'] = t.split('-');
    return new Date(Number(y), Number(m)-1, Number(d));
  }

  // M/D/YYYY (with optional time)
  const m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if (m) {
    const [,MM,DD,YYYY,hh='00',mi='00',ss='00'] = m;
    return new Date(Number(YYYY), Number(MM)-1, Number(DD), Number(hh), Number(mi), Number(ss));
  }

  // Fallback to Date.parse
  const d = new Date(t);
  return isNaN(d) ? null : d;
}

function excelSerialToDate(n){
  const s = Number(n);
  if (!isFinite(s)) return null;
  const base = Date.UTC(1899,11,31); // Excel day 1 baseline
  const ms   = (s >= 60 ? s+1 : s) * 86400000; // 1900 leap-year bug compensation
  const d = new Date(base + ms);
  return isNaN(d) ? null : d;
}


function daysFromTodayNoon(d){
  if (!d) return null;
  const now = new Date();
  const baseNow  = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0);
  const baseExp  = new Date(d.getFullYear(),   d.getMonth(),   d.getDate(),   12, 0, 0);
  return Math.ceil((baseExp - baseNow)/86400000);
}

function statusClass(days, status){
  const s = (status||'').toLowerCase();
  if (s.includes('expired')) return 'bad';
  if (s.includes('replace')) return 'bad';
  if (s.includes('ordered')) return 'warn';
  if (days != null){
    if (days < 0) return 'bad';
    if (days <= 30) return 'warn';
  }
  return 'ok';
}
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

/*** ========== STATE ========== ***/
let invHead=[], invRows=[], catHead=[], catRows=[], unitHead=[], unitRows=[];
let unitNameById = new Map();

/*** ========== LOAD & RENDER ========== ***/
async function boot(){
  try{
    const [invText, catText, unitText] = await Promise.all([
      fetch(CSV_INVENTORY).then(r=>r.text()),
      fetch(CSV_CATALOG).then(r=>r.text()),
      fetch(CSV_UNITS).then(r=>r.text())
    ]);
    [invHead, ...invRows] = parseCSV(invText);
    [catHead, ...catRows] = parseCSV(catText);
    [unitHead, ...unitRows] = parseCSV(unitText);

    // Build unit display map
    unitNameById = new Map(unitRows.map(r => [ String(r[idx(unitHead,'Unit')]||'').trim(), String(r[idx(unitHead,'Display')]||'').trim() ]));

    // Fill Unit select (keep existing selection if any)
    const sel = $('#unitSel'); const prev = sel.value || 'ALL';
    const unitIds = Array.from(new Set(invRows.map(r => String(r[idx(invHead,'Unit')]||'').trim()))).filter(x=>x);
    const options = ['ALL', ...unitIds.sort((a,b)=>a.localeCompare(b))]
      .map(u => `<option value="${u}">${u==='ALL' ? 'ALL' : (unitNameById.get(u)||u)}</option>`).join('');
    sel.innerHTML = options; sel.value = options.includes(`value="${prev}"`) ? prev : 'ALL';

    render(); // first render
    wireUI(); // set up events & modal only once
  }catch(e){
    console.error(e);
    $('#content').innerHTML = `<p style="color:#a00;font-weight:700;">Error loading CSVs. Check your publish URLs (Inventory gid must be the Inventory tab).</p>`;
  }
}

function render(){
  const within = parseInt($('#rangeSel').value,10);
  const unit = $('#unitSel').value;
  const q = $('#searchBox').value.toLowerCase();
  const statusFilter = $('#statusSel').value;

  const H = invHead;
  const list = invRows.filter(r=>{
    const itemId = String(r[idx(H,'ItemID')]||'').trim();
    const unitVal = String(r[idx(H,'Unit')]||'').trim();
    const comp = String(r[idx(H,'Compartment')]||'').trim();
    const lot = String(r[idx(H,'Lot')]||'').trim();
    const qty = String(r[idx(H,'Qty')]||'').trim();
    const rawExp = String(r[idx(H,'Expiry')]||'').trim();

        // compute DaysToExpire locally regardless of sheet content
    const d = parseExpiryDate(rawExp) || parseExpiryDate(lot);
    const days = daysFromTodayNoon(d);


    // infer status if the sheet doesn't have one
    const sheetStatus = String(r[idx(H,'Status')]||'').trim();
    const status = sheetStatus || (days==null ? '' : (days < 0 ? 'Expired' : (days<=30?'Replace': (days<=60?'60d':'90d'))));
    r._status = status;

    // within window
    const inWindow = (r._days==null) ? true : (r._days <= within);
    if (!inWindow) return false;

    // unit filter
    if (unit !== 'ALL' && unitVal !== unit) return false;

    // crew/good/replaced suppression? (keep everything; user can set Status filter)
    // status filter
    if (statusFilter && status !== statusFilter) return false;

    // search
    const hay = `${itemId} ${comp} ${lot}`.toLowerCase();
    if (q && !hay.includes(q)) return false;

    return true;
  }).map(r=>{
    // attach names
    const name = ((catRows.find(cr => String(cr[idx(catHead,'ItemID')]||'').trim() === String(r[idx(H,'ItemID')]||'').trim())||[])[idx(catHead,'ItemName')]||'').toString();
    r._itemName = name || r[idx(H,'ItemID')] || '';
    return r;
  });

  // sort: soonest days, then unit display, then item
  list.sort((a,b)=>{
    const ax = a._days ?? 999999, bx = b._days ?? 999999;
    if (ax!==bx) return ax-bx;
    const au = unitNameById.get(String(a[idx(H,'Unit')]||'').trim()) || String(a[idx(H,'Unit')]||'');
    const bu = unitNameById.get(String(b[idx(H,'Unit')]||'').trim()) || String(b[idx(H,'Unit')]||'');
    if (au!==bu) return au.localeCompare(bu);
    return (a._itemName||'').localeCompare(b._itemName||'');
  });

  $('#count').textContent = `${list.length} item(s)`;

  const showUnitCol = (unit === 'ALL');
  const html = `
    <table>
      <thead><tr>
        <th style="width:28%">Item</th>
        ${showUnitCol?'<th>Unit</th>':''}
        <th>Compartment</th>
        <th>Lot / Qty</th>
        <th>Expiry</th>
        <th class="right">Days</th>
        <th>Status</th>
        <th>Actions</th>
      </tr></thead>
      <tbody>
        ${list.map(r=>{
          const itemId = String(r[idx(H,'ItemID')]||'').trim();
          const unitVal = String(r[idx(H,'Unit')]||'').trim();
          const comp = String(r[idx(H,'Compartment')]||'').trim();
          const lot = String(r[idx(H,'Lot')]||'').trim();
          const qty = String(r[idx(H,'Qty')]||'').trim();
          const expD = parseExpiryDate(String(r[idx(H,'Expiry')]||'').trim()) || parseExpiryDate(lot);
          const exp  = expD ? `${expD.getFullYear()}-${String(expD.getMonth()+1).padStart(2,'0')}-${String(expD.getDate()).padStart(2,'0')}` 
                            : String(r[idx(H,'Expiry')]||'').trim();
          const days = r._days;
          const st = r._status;
          const cls = statusClass(days, st);
          const unitDisp = unitNameById.get(unitVal)||unitVal;
          return `
            <tr class="${cls}">
              <td><strong>${escapeHtml(r._itemName)}</strong><br><span class="muted">${escapeHtml(itemId)}</span></td>
              ${showUnitCol?`<td>${escapeHtml(unitDisp)}</td>`:''}
              <td>${escapeHtml(comp)}</td>
              <td>${escapeHtml(lot)}${qty?` <span class="muted">(${escapeHtml(qty)})</span>`:''}</td>
              <td>${escapeHtml(exp)}</td>
              <td class="right">${days??''}</td>
              <td><span class="badge">${escapeHtml(st)}</span></td>
              <td>
                <div class="actions">
                  <button class="btn red" data-action="replace" data-item="${encodeURIComponent(itemId)}" data-unit="${encodeURIComponent(unitVal)}" data-lot="${encodeURIComponent(lot)}">Mark Replace</button>
                  <button class="btn yellow" data-action="ordered" data-item="${encodeURIComponent(itemId)}" data-unit="${encodeURIComponent(unitVal)}" data-lot="${encodeURIComponent(lot)}">Mark Ordered</button>
                  <button class="btn green" data-action="ok" data-item="${encodeURIComponent(itemId)}" data-unit="${encodeURIComponent(unitVal)}" data-lot="${encodeURIComponent(lot)}">Mark OK</button>
                </div>
              </td>
            </tr>`;
        }).join('')}
      </tbody>
    </table>`;
  $('#content').innerHTML = html;

  // wire action buttons
  $('#content').querySelectorAll('button[data-action]').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const action = btn.dataset.action;
      const itemId = decodeURIComponent(btn.dataset.item||'');
      const unitVal = decodeURIComponent(btn.dataset.unit||'');
      const lot = decodeURIComponent(btn.dataset.lot||'');
      const statusMap = { replace:'Replace', ordered:'Ordered', ok:'OK' };
      const newStatus = statusMap[action] || 'OK';
      try{
          // NOTE: Apps Script expects 'crewStatus', not 'status'
      await postUpdate({ itemId, unit: unitVal, lot, crewStatus: newStatus });
      const badge = btn.closest('tr').querySelector('.badge');
        if (badge) badge.textContent = newStatus;
      }catch(err){
        alert('Update failed: ' + (err.message||err));
      }
    });
  });
}

function wireUI(){
  $('#refreshBtn').addEventListener('click', render);
  $('#rangeSel').addEventListener('change', render);
  $('#statusSel').addEventListener('change', render);
  $('#unitSel').addEventListener('change', render);
  $('#searchBox').addEventListener('input', debounce(render, 250));

  // Add Item modal
  const modal = $('#addItemModal');
  $('#showAddItemModal').addEventListener('click', ()=> modal.style.display='block');
  $('.close-btn').addEventListener('click', ()=> modal.style.display='none');
  window.addEventListener('click', (ev)=>{ if(ev.target===modal) modal.style.display='none'; });

  // Catalog datalist
  $('#itemsDatalist').innerHTML = catRows.map(r => `<option value="${escapeHtml(r[idx(catHead,'ItemName')]||'')}">`).join('');

  // Expiry chips (this month, +1, +2, +3)
  const now = new Date(); const chips = [];
  for(let i=0;i<4;i++){
    const d = new Date(now.getFullYear(), now.getMonth()+i, 1);
    const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`;
    const label = d.toLocaleString(undefined, { month:'short', year:'2-digit' });
    chips.push({iso,label});
  }
  const chipBar = $('#addExpiryChips');
  chipBar.innerHTML = chips.map(c=>`<button class="btn" data-exp="${c.iso}">${c.label}</button>`).join('');
  let selectedExp = '';
  chipBar.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', (e)=>{
      selectedExp = b.dataset.exp;
      chipBar.querySelectorAll('button').forEach(x=>x.style.borderColor='#ddd');
      b.style.borderColor='blue';
    });
  });

  // Save new item
  $('#saveNewItemBtn').addEventListener('click', async ()=>{
    const itemName = $('#addItemInput').value.trim();
    let unit = $('#unitSel').value;
    if (!itemName) return alert('Pick an item.');
    if (unit === 'ALL') {
      unit = prompt('Which unit is this for (e.g., 31, 33, 36)?') || '';
      unit = unit.trim();
      if (!unit) return;
    }
    const catRow = catRows.find(r => String(r[idx(catHead,'ItemName')]||'').trim().toLowerCase() === itemName.toLowerCase());
    if (!catRow) return alert('Item name not found in Catalog.');
    const itemId = String(catRow[idx(catHead,'ItemID')]||'').trim();
    const comp = $('#addCompartmentSelect').value.trim();
    const qty  = $('#addQty').value.trim();
    if (!selectedExp) return alert('Select Expiry Month.');
    try{
      await postUpdate({ itemId, unit, compartment: comp, expiry: selectedExp, lot: `NEW-${Date.now()}`, qty });
      modal.style.display='none';
      alert('Item added.');
      // quick refresh
      boot();
    }catch(err){
      alert('Add failed: ' + (err.message||err));
    }
  });
}

/*** ========== SERVER CALLS (Apps Script) ========== ***/
async function postUpdate(payload){
  const body = { token: TOKEN, actionType: 'updateInventory', ...payload };
  const r = await fetch(WEBAPP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const j = await r.json();
  if (!j.ok) throw new Error(j.error || 'server error');
  return j;
}

/*** ========== INIT ========== ***/
boot();
</script>
</body>
</html>
