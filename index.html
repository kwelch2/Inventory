<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Expiring Supplies – GC EMS</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666;--ok:#e7f7ee;--warn:#fff7e6;--bad:#fdecea}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
  h1{margin:0 0 6px}
  .muted{color:var(--muted);font-size:.9rem}
  .toolbar{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
  select,button,input{padding:8px 10px;border:1px solid var(--b);border-radius:10px;background:#fff}
  button{cursor:pointer}
  .grid{display:grid;gap:14px}
  .unit{border:1px solid var(--b);border-radius:12px;overflow:hidden}
  .unit>h3{margin:0;padding:10px 12px;background:#fafafa;border-bottom:1px solid var(--b)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  th{font-weight:600;background:#fafafa}
  tbody tr:last-child td{border-bottom:none}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--b);font-size:.8rem}
  .right{text-align:right}
  .ok{background:var(--ok)}
  .warn{background:var(--warn)}
  .bad{background:var(--bad)}
  .empty{padding:10px 12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Expiring Supplies</h1>
      <div class="muted">Pulled live from Inventory via Apps Script; Catalog & Units merged for names.</div>
      <div class="toolbar">
        <label>Window
          <select id="rangeSel">
            <option value="30">30 days</option>
            <option value="60">60 days</option>
            <option value="90" selected>90 days</option>
            <option value="120">120 days</option>
          </select>
        </label>
        <label>Status filter
          <select id="statusSel">
            <option value="">All</option>
            <option value="OK">OK</option>
            <option value="Needs Action">Needs Action</option>
            <option value="Ordered">Ordered</option>
            <option value="Replace">Replace</option>
            <option value="Expired">Expired</option>
          </select>
        </label>
        <input id="searchBox" placeholder="Search item, lot, compartment…" />
        <button id="refreshBtn">Refresh</button>
        <span id="count" class="muted"></span>
      </div>
    </div>

    <div id="content" class="grid" style="margin-top:12px;"></div>
  </div>

<script>
/*** ─────────────────────────────────────────────────────────────
 *  CONFIG: EDIT THESE TWO CONSTANTS ONLY
 *  1) WEBAPP_URL → your deployed Apps Script web app URL
 *  2) CSV_CATALOG / CSV_UNITS → your existing, working publish-to-web CSV links
 *  ──────────────────────────────────────────────────────────── */
const WEBAPP_URL   = 'https://script.google.com/macros/s/AKfycbypxL0KxxXMVRieHHuvX98m9Jx6fYJWTdrMLQNkt99Sgt0vNzRDeyGiDz5fILlORP8wFQ/exec'; // <-- EDIT
const CSV_CATALOG  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=1603897332&single=true&output=csv'; // <-- keep your working link
const CSV_UNITS    = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=767202807&single=true&output=csv';   // <-- keep your working link

/*** UTILITIES ***/
const $ = q => document.querySelector(q);
const by = (h, n) => h.indexOf(n);
const firstOfMonth = d => new Date(d.getFullYear(), d.getMonth(), 1);
const todayFOM = firstOfMonth(new Date()); // normalize to month start for consistent comparisons
function parseCSV(text){
  // tiny CSV parser that supports quoted fields and commas
  const rows=[]; let cur=[], val='', q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c === '"' ){ if(q && n === '"'){ val+='"'; i++; } else q=!q; continue; }
    if(!q && (c === ',')){ cur.push(val); val=''; continue; }
    if(!q && (c === '\n' || c === '\r')){ if(val!==''||cur.length){ cur.push(val); rows.push(cur); cur=[]; val=''; }
      if(c === '\r' && n === '\n'){ i++; } continue; }
    val += c;
  }
  if(val!==''||cur.length){ cur.push(val); rows.push(cur); }
  return rows;
}
async function fetchText(u){ const r = await fetch(u); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.text(); }
async function fetchJSON(u){ const r = await fetch(u); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }
function safeInt(x){ const n = Number(x); return Number.isFinite(n) ? n : null; }
function normStr(x){ return (x ?? '').toString().trim(); }
function computeDaysToExpire(expStr){
  // Accepts "YYYY-MM-DD" or "M/D/YYYY" or similar; compare first-of-month
  if(!expStr) return null;
  let d;
  if(/^\d{4}-\d{2}-\d{2}/.test(expStr)) d = new Date(expStr);
  else d = new Date(expStr);
  if(isNaN(d)) return null;
  const diffMs = firstOfMonth(d) - todayFOM;
  return Math.ceil(diffMs / 86400000);
}
function statusClass(days, status){
  const s = (status||'').toLowerCase();
  if(s.includes('expired')) return 'bad';
  if(s.includes('replace')) return 'bad';
  if(s.includes('ordered')) return 'warn';
  if(s.includes('needs')) return 'warn';
  if(days != null){
    if(days < 0) return 'bad';
    if(days <= 30) return 'warn';
  }
  return 'ok';
}

/*** DATA LOAD ***/
async function boot(){
  const within = $('#rangeSel').value;
  const statusFilter = $('#statusSel').value;
  const q = $('#searchBox').value.toLowerCase();

  try{
    // 1) Inventory (JSON) — guaranteed correct sheet
    const invJson = await fetchJSON(`${WEBAPP_URL}?action=expiring&within=${encodeURIComponent(within)}`);
    const invRows = (invJson.rows || []).map(o => ({
      ItemID: normStr(o.ItemID),
      Unit: normStr(o.Unit),
      Compartment: normStr(o.Compartment),
      Lot: normStr(o.Lot),
      Qty: normStr(o.Qty),
      Expiry: normStr(o.Expiry),
      DaysToExpire: safeInt(o.DaysToExpire) ?? computeDaysToExpire(o.Expiry),
      Status: normStr(o.Status),
      CrewStatus: normStr(o.CrewStatus)
    }));

    // 2) Catalog & Units (CSV)
    const [catText, unitText] = await Promise.all([ fetchText(CSV_CATALOG), fetchText(CSV_UNITS) ]);
    const cat = parseCSV(catText);  const ch = cat[0]||[];  const cr = cat.slice(1);
    const units = parseCSV(unitText);const uh = units[0]||[];const ur = units.slice(1);

    // 3) Build lookups
    const catNameById = new Map(cr.map(r => [ normStr(r[by(ch,'ItemID')]), normStr(r[by(ch,'ItemName')]) ]));
    const unitDispById = new Map(ur.map(r => [ normStr(r[by(uh,'Unit')]),     normStr(r[by(uh,'Display')])   ]));

    // 4) Enrich rows
    const rows = invRows.map(r => ({
      ...r,
      ItemName: catNameById.get(r.ItemID) || r.ItemID,
      UnitDisplay: unitDispById.get(r.Unit) || r.Unit
    }));

    // 5) Filter (status + search + within window)
    const withinDays = parseInt(within,10);
    const filtered = rows.filter(r => {
      const inWindow = (r.DaysToExpire == null) ? true : r.DaysToExpire <= withinDays;
      const matchesStatus = statusFilter ? (r.Status === statusFilter) : true;
      const s = `${r.ItemName} ${r.ItemID} ${r.UnitDisplay} ${r.Compartment} ${r.Lot}`.toLowerCase();
      const matchesSearch = q ? s.includes(q) : true;
      return inWindow && matchesStatus && matchesSearch;
    });

    // 6) Sort: soonest expiring first, then Unit, then Item
    filtered.sort((a,b)=>{
      const ax = a.DaysToExpire ?? 999999, bx = b.DaysToExpire ?? 999999;
      if(ax!==bx) return ax-bx;
      if(a.UnitDisplay!==b.UnitDisplay) return a.UnitDisplay.localeCompare(b.UnitDisplay);
      return a.ItemName.localeCompare(b.ItemName);
    });

    $('#count').textContent = `${filtered.length} item(s)`;

    // 7) Group by UnitDisplay and render
    const byUnit = new Map();
    for(const r of filtered){
      const k = r.UnitDisplay || '(No Unit)';
      if(!byUnit.has(k)) byUnit.set(k, []);
      byUnit.get(k).push(r);
    }
    render(byUnit);

  }catch(err){
    console.error(err);
    $('#content').innerHTML = `<div class="card" style="border-color:#f00;">
      <h3 style="margin:0 0 6px;color:#a00;">Error loading data</h3>
      <div class="muted">${err.message}</div>
      <div class="muted">Check WEBAPP_URL and your published CSV links for Catalog & Units.</div>
    </div>`;
  }
}

/*** RENDER ***/
function render(byUnit){
  const host = $('#content');
  host.innerHTML = '';
  if(!byUnit.size){
    host.innerHTML = `<div class="card empty">No items match your filters.</div>`;
    return;
  }
  for(const [unit, rows] of byUnit){
    const sec = document.createElement('section');
    sec.className = 'unit';
    sec.innerHTML = `
      <h3>${unit}</h3>
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th style="width:28%">Item</th>
              <th>Compartment</th>
              <th>Lot</th>
              <th class="right">Qty</th>
              <th>Expiry</th>
              <th class="right">Days</th>
              <th>Status</th>
              <th>Crew</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>`;
    const tbody = sec.querySelector('tbody');

    for(const r of rows){
      const cls = statusClass(r.DaysToExpire, r.Status);
      const tr = document.createElement('tr');
      tr.className = cls;
      tr.innerHTML = `
        <td><strong>${escapeHtml(r.ItemName)}</strong><br><span class="muted">${escapeHtml(r.ItemID)}</span></td>
        <td>${escapeHtml(r.Compartment)}</td>
        <td>${escapeHtml(r.Lot)}</td>
        <td class="right">${escapeHtml(r.Qty)}</td>
        <td>${escapeHtml(r.Expiry)}</td>
        <td class="right">${r.DaysToExpire ?? ''}</td>
        <td><span class="badge">${escapeHtml(r.Status)}</span></td>
        <td>${escapeHtml(r.CrewStatus)}</td>
      `;
      tbody.appendChild(tr);
    }
    host.appendChild(sec);
  }
}
function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

/*** HOOKS ***/
$('#refreshBtn').addEventListener('click', boot);
$('#rangeSel').addEventListener('change', boot);
$('#statusSel').addEventListener('change', boot);
$('#searchBox').addEventListener('input', debounce(boot, 250));

function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

// initial load
boot();
</script>
</body>
</html>
