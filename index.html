<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Expiring Supplies – GC EMS</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
  h1{margin:0 0 8px}
  .muted{color:var(--muted);font-size:.9rem}
  .toolbar{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
  select,input,button{padding:8px;border:1px solid #ccc;border-radius:8px}
  button.btn{padding:6px 10px;text-decoration:none;background:#fafafa;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle}
  h2{margin:18px 0 6px}
  .unit-display{text-align:center;padding:10px;border:1px solid var(--b);border-radius:8px; margin-top:16px; font-size:1.2em; font-weight:bold;}
  .status-btns button{width:auto; margin-right:5px; background-color:#f0f0f0; cursor:pointer;}
  .status-btns .active{background-color:#0275d8;color:white;border-color:#0275d8;}
  .red{background:#ffebee} .orange{background:#fff3e0} .yellow{background:#fffde7}
  .modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.4);}
  .modal-content{background-color:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:80%;max-width:500px;border-radius:12px;}
  .close-btn{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer;}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Expiring Supplies</h1>
    <div class="muted">Yellow ≤60d, Orange ≤30d, Red expired.</div>
    <div class="toolbar">
      <label class="muted">Unit</label>
      <select id="unitSel"></select>
      <label class="muted">Sort</label>
      <select id="sortSel">
        <option value="date">By Expiry Date</option>
        <option value="item">By Item</option>
      </select>
      <details>
        <summary class="muted">Advanced</summary>
        <div style="margin-top:6px">
          <label class="muted">Show within</label>
          <select id="rangeSel">
            <option value="90">90 days</option>
            <option value="60">60 days</option>
            <option value="30">30 days</option>
          </select>
        </div>
      </details>
      <span style="flex:1"></span>
      <button id="showAddItemModal" class="btn">Add Expiring Item</button>
    </div>
    <div id="unitDisplay" class="unit-display" style="display:none;"></div>
    <div id="content" style="margin-top:8px"></div>
  </div>
</div>

<div id="addItemModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>Add Missing Expiring Item</h2>
    <label>Item</label>
    <input id="addItemInput" list="itemsDatalist" placeholder="Select item from Catalog...">
    <datalist id="itemsDatalist"></datalist>
    <label>Compartment</label>
    <select id="addCompartmentSelect">
        <option value="">Select Compartment...</option>
        <option>Wall</option>
        <option>Bag</option>
        <option>Supply RM</option>
    </select>
    <label>Expiry Month</label>
    <div id="addExpiryChips" style="display:flex; gap:6px;"></div>
    <button id="saveNewItemBtn" class="btn" style="width:100%; margin-top:16px;">Save Item</button>
  </div>
</div>

<script>
/*** CONFIG — replace these ***/
const CSV_INVENTORY   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=0&single=true&output=csv';
const CSV_CATALOG     = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=1603897332&single=true&output=csv';
const CSV_UNITS       = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=767202807&single=true&output=csv';
const CSV_VENDORPR    = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=1795212434&single=true&output=csv';
const CSV_VENDORS     = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=1079994552&single=true&output=csv';
const CSV_ACTIVITYLOG = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=1791453005&single=true&output=csv';
const WEBAPP_URL      = 'https://script.google.com/macros/s/AKfycbypxL0KxxXMVRieHHuvX98m9Jx6fYJWTdrMLQNkt99Sgt0vNzRDeyGiDz5fILlORP8wFQ/exec';
const TOKEN           = '9mB4zR7kP2fW6vNqE1jH8aLcV5gT_sYx0uI-oZ3pD9bX4wK7eS6hF-EMS';
/*** end config ***/

let invHead=[], invRows=[], catHead=[], catRows=[], unitHead=[], unitRows=[], unitNameById=new Map();
const idx = (h,name) => h.indexOf(name);

function parseCSV(text){
    const clean = (text||'').replace(/^\uFEFF/,'').trim();
    if (!clean) return [];
    return clean.split(/\r?\n/).map(line => {
        const m = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
        return m.map(s => s.replace(/^"|"$/g, ''));
    });
}
function statusClass(s){ return s==='Expired'?'red':s==='30d'?'orange':s==='60d'?'yellow':''; }
function getCrewStatus(h, row){ return String(row[idx(h,'CrewStatus')]||'').trim(); }

function next3MonthChips(){
  const out = []; const now = new Date();
  for (let k=0; k<3; k++){
    const d = new Date(now.getFullYear(), now.getMonth()+k, 1);
    const label = String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear();
    const iso = new Date(d.getFullYear(), d.getMonth()+1, 1).toISOString().slice(0,10);
    out.push({label, iso});
  }
  return out;
}

function fillUnitSelect(){
  const sel = document.getElementById('unitSel');
  let options = '<option value="ALL">-- All Items --</option>';
  unitRows.sort((a, b) => (Number(a[idx(unitHead,'Unit')])||0) - (Number(b[idx(unitHead,'Unit')])||0));
  options += unitRows.map(r => `<option value="${r[idx(unitHead,'Unit')]}">${r[idx(unitHead,'Display')]}</option>`).join('');
  sel.innerHTML = options;
}

async function postUpdate(payload){
  payload.token = TOKEN;
  payload.actionType = 'updateInventory';
  try{
    await fetch(WEBAPP_URL, {method:'POST', mode:'no-cors', body: JSON.stringify(payload)});
  }catch(e){ console.error("Post failed", e); }
}

function render(){
  const unit = document.getElementById('unitSel').value;
  const sortBy = document.getElementById('sortSel').value;
  const within = Number(document.getElementById('rangeSel').value);
  
  const unitDisplay = document.getElementById('unitDisplay');
  unitDisplay.textContent = (unit === 'ALL') ? 'Viewing All Units' : `Viewing ${unitNameById.get(unit) || unit}`;
  unitDisplay.style.display = 'block';

  const H = invHead;
  let list = invRows.filter(r => {
    const expiryDateStr = r[idx(H, 'Expiry')];
    if (!expiryDateStr) return false;
    const expiryDate = new Date(expiryDateStr);
    if (isNaN(expiryDate)) return false;
    const daysToExpire = Math.ceil((expiryDate.getTime() - new Date().getTime()) / (1000 * 3600 * 24));
    if (daysToExpire > within) return false;
    const crewStatus = getCrewStatus(H, r).toLowerCase();
    if (crewStatus === 'replaced' || crewStatus === 'good') return false;
    r.daysToExpire = daysToExpire;
    r.status = daysToExpire <= 0 ? 'Expired' : daysToExpire <= 30 ? '30d' : daysToExpire <= 60 ? '60d' : '90d';
    return true;
  });

  if (sortBy === 'item') {
    list.sort((a,b) => (a[idx(H,'ItemName')]||'').localeCompare(b[idx(H,'ItemName')]||''));
  } else {
    list.sort((a,b) => (new Date(a[idx(H,'Expiry')]) - new Date(b[idx(H,'Expiry')])));
  }

  const filteredList = (unit === 'ALL') ? list : list.filter(r => String(r[idx(H,'Unit')]) === unit);
  
  const cont = document.getElementById('content');
  cont.innerHTML = `
    <table>
      <thead><tr>
        <th>Item</th> ${unit === 'ALL' ? '<th>Unit</th>' : ''}
        <th>Compartment</th><th>Lot / Qty</th><th>Expiry</th><th>Status</th>
      </tr></thead>
      <tbody>
        ${filteredList.map(r=>{
          const itemId = r[idx(H,'ItemID')] || '';
          const u = r[idx(H,'Unit')] || '';
          const comp = r[idx(H,'Compartment')] || '';
          const lot  = r[idx(H,'Lot')] || '';
          const qty  = r[idx(H,'Qty')] || '';
          const crewStatus = getCrewStatus(H, r);
          return `<tr class="${statusClass(r.status)}">
            <td>${r[idx(H,'ItemName')] || itemId}</td>
            ${unit === 'ALL' ? `<td>${unitNameById.get(u) || u}</td>` : ''}
            <td>${comp}</td>
            <td>${lot} <span class="muted">${qty ? `(Qty: ${qty})` : ''}</span></td>
            <td>${r.daysToExpire} days</td>
            <td class="status-btns">
              <button class="btn ${crewStatus.toLowerCase() === 'pending' ? 'active' : ''}" data-act="Pending" data-item="${itemId}" data-unit="${u}" data-lot="${lot}">Pending</button>
              <button class="btn" data-act="Replaced" data-item="${itemId}" data-unit="${u}" data-lot="${lot}">Replaced</button>
              <button class="btn" data-act="Good" data-item="${itemId}" data-unit="${u}" data-lot="${lot}">Good</button>
            </td>
          </tr>`;
        }).join('') || `<tr><td colspan="6">No items need attention.</td></tr>`}
      </tbody>
    </table>`;
  
  cont.querySelectorAll('.status-btns button').forEach(btn => {
    btn.addEventListener('click', async () => {
      await postUpdate({itemId: btn.dataset.item, unit: btn.dataset.unit, lot: btn.dataset.lot, crewStatus: btn.dataset.act});
      render();
    });
  });
}

async function boot(){
  try {
    const [invText, catText, unitText] = await Promise.all([
      fetch(CSV_INVENTORY).then(r=>r.text()), 
      fetch(CSV_CATALOG).then(r=>r.text()), 
      fetch(CSV_UNITS).then(r=>r.text())
    ]);
    
    const invAll = parseCSV(invText); invHead = invAll.shift() || []; invRows = invAll;
    const catAll = parseCSV(catText); catHead = catAll.shift() || []; catRows = catAll;
    const unitAll = parseCSV(unitText); unitHead = unitAll.shift() || []; unitRows = unitAll;

    const nameById = new Map(catRows.map(r => [r[idx(catHead,'ItemID')], r[idx(catHead,'ItemName')]]));
    if (!invHead.includes('ItemName')) invHead.push('ItemName');
    invRows.forEach(r => { r[idx(invHead,'ItemName')] = nameById.get(r[idx(invHead,'ItemID')]) || 'Unknown Item'; });
    
    unitNameById = new Map(unitRows.map(r => [r[idx(unitHead,'Unit')], r[idx(unitHead,'Display')]]));

    fillUnitSelect();
    render();

    document.getElementById('unitSel').addEventListener('change', render);
    document.getElementById('sortSel').addEventListener('change', render);
    document.getElementById('rangeSel').addEventListener('change', render);

    // --- Logic for the Add Item Modal ---
    const modal = document.getElementById('addItemModal');
    document.getElementById('showAddItemModal').addEventListener('click', () => modal.style.display = 'block');
    document.querySelector('.close-btn').addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', (event) => { if (event.target == modal) modal.style.display = 'none'; });

    document.getElementById('itemsDatalist').innerHTML = catRows.map(r => `<option value="${r[idx(catHead,'ItemName')]}">`).join('');
    
    const addExpiryChips = document.getElementById('addExpiryChips');
    addExpiryChips.innerHTML = next3MonthChips().map(ch => `<button class="btn" data-exp="${ch.iso}">${ch.label}</button>`).join('');
    
    let selectedNewExpiry = '';
    addExpiryChips.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        selectedNewExpiry = btn.dataset.exp;
        addExpiryChips.querySelectorAll('button').forEach(b => b.style.borderColor = '#ccc');
        btn.style.borderColor = 'blue';
      });
    });

    document.getElementById('saveNewItemBtn').addEventListener('click', async () => {
      const itemName = document.getElementById('addItemInput').value;
      const compartment = document.getElementById('addCompartmentSelect').value;
      let unit = document.getElementById('unitSel').value;
      if (unit === 'ALL') {
          unit = prompt('When viewing "All Items", please specify which unit this new item is for (e.g., 31, 33):');
      }
      
      const catItem = catRows.find(r => r[idx(catHead,'ItemName')] === itemName);
      
      if (!catItem || !compartment || !selectedNewExpiry || !unit) { 
        alert('Please fill out all fields, including specifying a unit.'); 
        return; 
      }
      
      await postUpdate({itemId: catItem[idx(catHead,'ItemID')], unit, compartment, expiry: selectedNewExpiry, lot: `NEW-${Date.now()}`});
      
      modal.style.display = 'none';
      alert(`'${itemName}' was added. The page will now refresh.`);
      location.reload();
    });
  } catch(e) {
    document.getElementById('content').innerHTML = `<p style="color:red;font-weight:bold;">Error: Could not load data. Please ensure the Google Sheets are shared correctly and check the console (F12) for details.</p>`;
    console.error(e);
  }
}

boot();
</script>
</body>
</html>