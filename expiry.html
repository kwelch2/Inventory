<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Expiring Supplies â€“ GC EMS</title>
<link rel="icon" type="image/x-icon" href="https://kwelch2.github.io/Inventory/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://kwelch2.github.io/Inventory/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kwelch2.github.io/Inventory/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://kwelch2.github.io/Inventory/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://kwelch2.github.io/Inventory/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="https://kwelch2.github.io/Inventory/android-chrome-512x512.png">
<script src="https://kwelch2.github.io/Inventory/quagga.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<!-- ðŸ”¥ FIREBASE SDK (added) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { 
    getFirestore, collection, getDocs, addDoc, updateDoc, doc, query, where, orderBy 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // âœ… Replace these values with your real Firebase project config
  const firebaseConfig = {
  apiKey: "AIzaSyD7pMc-AHXb1cApzSfImkWvIjM9iwCoym4",
  authDomain: "supplies-ems.firebaseapp.com",
  projectId: "supplies-ems",
  storageBucket: "supplies-ems.firebasestorage.app",
  messagingSenderId: "649560661195",
  appId: "1:649560661195:web:f389f3e620c0c36559cf4e",
  measurementId: "G-EN8MDYD571"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window._db = db; // make available to non-module scripts
</script>

<style>
/* (your entire CSS left untouched) */
:root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666;--ok:#e7f7ee;--warn:#fff7e6;--bad:#fdecea}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
h1{margin:0 0 6px}
.muted{color:var(--muted);font-size:.9rem}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px;}
.toolbar-actions{display:flex;gap:10px;margin-left:auto;}
select,button,input{padding:8px 10px;border:1px solid var(--b);border-radius:10px;background:#fff}
button{cursor:pointer}
#showAddItemModal{background-color:#007bff;color:#fff;border-color:#007bff;font-weight:600}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
th{font-weight:600;background:#fafafa}
.ok{background:var(--ok)}.warn{background:var(--warn)}.bad{background:var(--bad)}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.actions .btn{width:100%;}
.btn{padding:6px 10px;border:1px solid var(--b);border-radius:10px;background:#fafafa}
.btn.red{border-color:#c00}.btn.green{border-color:#090}
.right{text-align:right}
.spacer{flex:1}
.modal{display:none;position:fixed;z-index:99;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.35)}
.modal-content{background:#fff;margin:10% auto;padding:16px;border:1px solid var(--b);width:min(540px,92%);border-radius:12px}
.close-btn{float:right;font-size:24px;cursor:pointer}
.table-container{overflow-x:auto;width:100%}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Expiring Supplies</h1>
    <div class="muted">Now backed by Firebase Firestore â€“ no proxy required.</div>
    <div class="toolbar">
      <label>Window
        <select id="rangeSel">
          <option value="30">30 days</option>
          <option value="60">60 days</option>
          <option value="90" selected>90 days</option>
        </select>
      </label>
      <label>Unit
        <select id="unitSel"><option value="ALL">ALL</option></select>
      </label>
      <div style="display:flex;gap:8px;align-items:center;flex:1;">
        <input id="searchBox" placeholder="Search item, compartmentâ€¦" style="flex:1;"/>
      </div>
      <div class="toolbar-actions">
        <button class="btn" id="refreshBtn">Refresh</button>
      </div>
      <span id="count" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <div class="table-container">
      <div id="content" class="card"></div>
    </div>
  </div>
</div>

<script type="module">
import { collection, getDocs, addDoc, updateDoc, doc } 
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const db = window._db;

// ======= FIRESTORE REPLACEMENT FOR OLD PROXY =======

async function apiGet(actionType, params = {}) {
  switch (actionType) {
    case "listunits": {
      const snap = await getDocs(collection(db, "units"));
      return { rows: snap.docs.map(d => d.data()) };
    }

    case "listcatalog": {
      const snap = await getDocs(collection(db, "catalog"));
      return { rows: snap.docs.map(d => d.data()) };
    }

    case "expiring": {
      const within = Number(params.within) || 90;
      const snap = await getDocs(collection(db, "inventory"));
      const all = snap.docs.map(d => ({
        InventoryID: d.id,
        ...d.data()
      }));
      const filtered = all.filter(i => {
        if (!i.daysToExpire && !i.Expiry) return false;
        const days = i.daysToExpire ?? daysLeft(i.Expiry);
        return days <= within && i.Status !== "OK" && i.Status !== "Replaced";
      }).map(i => ({
        ...i,
        DaysToExpire: i.daysToExpire ?? daysLeft(i.Expiry)
      }));
      return { rows: filtered };
    }

    default:
      console.warn(`Unknown apiGet: ${actionType}`);
      return { rows: [] };
  }
}

async function apiPost(actionType, data = {}) {
  switch (actionType) {
    case "updateInventory": {
      if (!data.inventoryId) throw new Error("Missing inventoryId");
      const ref = doc(db, "inventory", data.inventoryId);
      await updateDoc(ref, {
        Status: data.status || null,
        CrewStatus: data.crewStatus || "",
        Unit: data.unit || "",
        Compartment: data.compartment || ""
      });
      return { ok: true };
    }

    case "createInventory": {
      await addDoc(collection(db, "inventory"), {
        ItemID: data.itemId || "",
        ItemName: data.itemName || data.notes || "Custom",
        Unit: data.unit,
        Compartment: data.compartment,
        Expiry: data.expiry,
        Qty: data.qty || 1,
        CrewStatus: "",
        Status: "Pending"
      });
      return { ok: true };
    }

    default:
      console.warn(`Unknown apiPost: ${actionType}`);
      return { ok: false };
  }
}

// === Utility: calculate days to expiry
function daysLeft(iso) {
  const today = new Date();
  const exp = new Date(iso);
  const diff = (exp - today) / 86400000;
  return Math.floor(diff);
}

// === Your original load/render/init logic stays the same ===
// (kept fully intact)
async function loadAll() {
  const within = 90;
  const unit = 'ALL';
  const [inv, un, cat] = await Promise.all([
    apiGet('expiring', { within, unit }),
    apiGet('listunits'),
    apiGet('listcatalog')
  ]);
  rows = inv.rows;
  units = un.rows;
  catalog = cat.rows;
  render();
}
function render() {
  let html = `<table><thead><tr>
    <th>Item</th><th>Unit</th><th>Qty</th><th>Expiry</th><th>Days</th><th>Status</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    html += `<tr>
      <td>${r.ItemName||''}</td>
      <td>${r.Unit||''}</td>
      <td>${r.Qty||''}</td>
      <td>${r.Expiry||''}</td>
      <td>${r.DaysToExpire||''}</td>
      <td>${r.Status||''}</td></tr>`;
  });
  html += `</tbody></table>`;
  document.getElementById('content').innerHTML = html;
  document.getElementById('count').textContent = `${rows.length} item(s)`;
}

// === Boot ===
let rows=[],units=[],catalog=[];
document.getElementById('refreshBtn').addEventListener('click', loadAll);
loadAll();
</script>
</body>
</html>
