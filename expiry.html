<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Expiring Supplies â€“ GC EMS</title>
<link rel="icon" type="image/x-icon" href="https://kwelch2.github.io/Inventory/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://kwelch2.github.io/Inventory/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kwelch2.github.io/Inventory/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://kwelch2.github.io/Inventory/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://kwelch2.github.io/Inventory/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="https://kwelch2.github.io/Inventory/android-chrome-512x512.png">
<script src="https://kwelch2.github.io/Inventory/quagga.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<style>
:root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666;--ok:#e7f7ee;--warn:#fff7e6;--bad:#fdecea}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
h1{margin:0 0 6px}
.muted{color:var(--muted);font-size:.9rem}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px;}
.toolbar-actions{display:flex;gap:10px;margin-left:auto;}
select,button,input{padding:8px 10px;border:1px solid var(--b);border-radius:10px;background:#fff}
button{cursor:pointer}
#showAddItemModal{background-color:#007bff;color:#fff;border-color:#007bff;font-weight:600;}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
th{font-weight:600;background:#fafafa}
.ok{background:var(--ok)}.warn{background:var(--warn)}.bad{background:var(--bad)}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.btn{padding:6px 10px;border:1px solid var(--b);border-radius:10px;background:#fafafa}
.btn.red{border-color:#c00}.btn.green{border-color:#090}
.btn.pending.is-active{background:#ffeb3b!important;color:#000;font-weight:600;border-color:#fdd835;}
.modal{display:none;position:fixed;z-index:99;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.35)}
.modal-content{background:#fff;margin:10% auto;padding:16px;border:1px solid var(--b);width:min(540px,92%);border-radius:12px}
.close-btn{float:right;font-size:24px;cursor:pointer}
.table-container{overflow-x:auto;width:100%}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Expiring Supplies</h1>
    <div class="muted">Live from Firestore â€“ filtered by expiry window</div>
    <div class="toolbar">
      <label>Window
        <select id="rangeSel">
          <option value="30">30 days</option>
          <option value="60">60 days</option>
          <option value="90" selected>90 days</option>
        </select>
      </label>
      <label>Unit
        <select id="unitSel"><option value="ALL">ALL</option></select>
      </label>
      <div style="flex:1;display:flex;gap:8px;align-items:center;">
        <input id="searchBox" placeholder="Search item, compartmentâ€¦" style="flex:1;"/>
      </div>
      <div class="toolbar-actions">
        <button class="btn" id="refreshBtn">Refresh</button>
      </div>
      <span id="count" class="muted"></span>
    </div>
  </div>
  <div class="card">
    <div class="table-container">
      <div id="content" class="card"></div>
    </div>
  </div>
</div>

<script type="module">
// ==================== FIREBASE SDK SETUP ====================
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// Your Firebase Config (no secret keys!)
const firebaseConfig = {
  apiKey: "YOUR_PUBLIC_KEY_HERE",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ==================== LOAD DATA ====================
let rows = [];

async function loadAll() {
  rows = [];
  const snap = await getDocs(query(collection(db, "inventory")));
  snap.forEach(doc => {
    const r = doc.data();
    rows.push(r);
  });

  // ðŸ”§ Normalize Firestore fields to legacy names
  rows = rows.map(r => ({
    InventoryID: r.inventoryId || '',
    ItemName: r.itemName || r.notes || '(unknown)',
    Unit: r.unitId || '',
    Compartment: r.compartment || '',
    Qty: r.qty ?? '',
    Expiry: r.expiryDate ? r.expiryDate.substring(0,10) : '',
    Status: r.status || '',
    CrewStatus: r.crewStatus || '',
    DaysToExpire: r.daysToExpire ?? '',
    Notes: r.notes || ''
  }));

  render();
}

// ==================== RENDER ====================
function rowClass(days, status){
  if ((status||'').toLowerCase() === 'pending') return 'warn';
  if (days != null){
    if (days < 0) return 'bad';
    if (days <= 30) return 'warn';
  }
  return 'ok';
}

function render(){
  const q = ($('#searchBox').value||'').toLowerCase();
  let list = rows.filter(r=>{
    const hay = `${r.ItemName} ${r.Compartment}`.toLowerCase();
    return !q || hay.includes(q);
  });

  list = list.sort((a,b)=> (a.DaysToExpire??1e9)-(b.DaysToExpire??1e9));

  $('#count').textContent = `${list.length} item(s)`;

  const html = `<table><thead><tr>
    <th>Item</th>
    <th>Unit</th>
    <th>Compartment</th>
    <th>Qty</th>
    <th>Expiry</th>
    <th>Days</th>
    <th>Status</th>
  </tr></thead><tbody>
  ${list.map(r=>{
    const cls = rowClass(r.DaysToExpire, r.Status);
    return `<tr class="${cls}">
      <td>${r.ItemName}</td>
      <td>${r.Unit}</td>
      <td>${r.Compartment}</td>
      <td>${r.Qty}</td>
      <td>${r.Expiry}</td>
      <td>${r.DaysToExpire}</td>
      <td>${r.Status}</td>
    </tr>`;
  }).join('')}
  </tbody></table>`;

  $('#content').innerHTML = html;
}

const $ = s => document.querySelector(s);
$('#refreshBtn').addEventListener('click', loadAll);
$('#searchBox').addEventListener('input', () => render());

// Load on startup
loadAll();
</script>
</body>
</html>
