<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>EMS Supplies â€” Admin Dashboard</title>
  <script src="https://kwelch2.github.io/Inventory/quagga.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50' font-size='50'%3EðŸš‘%3C/text%3E%3C/svg%3E">
  <style>
    :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666;--ink:#111;--accent:#0a66ff;--bad:#b00020;--ok:#137333}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--b);position:sticky;top:0;background:var(--bg);padding-bottom:8px;z-index:5}
    .tab{padding:10px 14px;border:1px solid var(--b);border-bottom:none;border-top-left-radius:10px;border-top-right-radius:10px;background:#eee;color:#333;cursor:pointer}
    .tab.active{background:var(--card);color:#000;border-bottom:1px solid var(--card)}
    .panel{display:none;background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;margin-top:-1px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .panel.active{display:block}
    h1{margin:0 0 10px}
    h2{margin:.2rem 0 .8rem}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-top:1px solid var(--b);text-align:left;vertical-align:top}
    th{background:#fafafa}
    input,select{padding:8px;border:1px solid var(--b);border-radius:8px}
    .btn{padding:8px 10px;border:1px solid var(--b);border-radius:10px;background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.ghost{background:transparent}
    .muted{color:var(--muted)}
    .vendor-basket{border:1px dashed var(--b);border-radius:10px;padding:10px;margin:10px 0}
    .tag{display:inline-block;font-size:.8rem;padding:3px 6px;border:1px solid var(--b);border-radius:999px;background:#fff}
    .danger{color:var(--bad)}
    .success{color:var(--ok)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .banner{display:flex;gap:8px;align-items:center;padding:10px;border:1px solid var(--b);border-radius:10px;background:#fff;margin:10px 0}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--b)}
    .pill.ok{border-color:#cde8d1;background:#eef7f0}
    .pill.bad{border-color:#f3c1c1;background:#fdecec}
    .toast{position:fixed;right:12px;bottom:12px;max-width:420px;background:#222;color:#fff;padding:10px 12px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.2);display:none}
    .toast.show{display:block}
    .kvd{font-size:12px;color:#555}
    code.badge{background:#f5f5f5;border:1px solid var(--b);padding:2px 6px;border-radius:6px}
    #interactive.viewport {
      position: relative;
      width: 100%;
      height: 300px;
      border: 1px solid #ccc;
      background: #000;
      display: none;
    }
    #interactive.viewport video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .drawingBuffer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>EMS Supplies â€” Admin Dashboard</h1>

  <div class="banner" id="diag">
    <strong>Connectivity</strong>
    <span id="statusIcon" class="pill bad">Checkingâ€¦</span>
    <span class="muted">BASE:</span><code class="mono" id="baseEcho"></code>
    <span class="spacer"></span>
    <button class="btn" id="btnTestApi">Test API</button>
    <button class="btn ghost" id="btnProbe">Probe Data</button>
  </div>

  <div class="tabs" id="tabs"></div>

  <section id="panel-catalog" class="panel">
  <h2>Catalog Manager <span class="kvd" id="kvCatalog"></span></h2>

  <div class="row">
    <input id="catName" placeholder="Item name"/>
    <input id="catCategory" placeholder="Category"/>
    <button class="btn primary" id="catAddBtn">Add / Upsert</button>
    <span class="muted">Uses <span class="mono">upsertcatalog</span></span>
    <span class="spacer"></span>
    <div style="display:flex; gap: 8px; align-items:center;">
      <button class="btn" id="startScanBtn" title="Scan Barcode to Search">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M3 6h2v12H3V6zm3 0h2v12H6V6zm3 0h2v12H9V6zm3-2h2v16h-2V4zm3 2h2v12h-2V6zm3 0h2v12h-2V6z'/%3E%3C/svg%3E" alt="Barcode Scanner" style="height:20px;width:20px;">
      </button>
      <input id="catSearch" placeholder="Search itemsâ€¦" style="min-width:240px"/>
    </div>
  </div>

  <div id="interactive" class="viewport"></div>
  <div id="catalogTable" style="margin-top:10px"></div>
</section>

  <div id="catalogDialog" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; border:1px solid #ddd; border-radius:12px; width:min(720px,90vw); padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2)">
      <h3 style="margin:.2rem 0 1rem">Edit Catalog Item</h3>
      <div class="row" style="gap:10px">
        <input id="dlgItemID"  placeholder="ItemID" readonly title="ItemID is immutable" style="flex:1; background:#f9f9f9"/>
        <input id="dlgItemName" placeholder="Item Name" style="flex:2"/>
      </div>
      <div class="row" style="gap:10px; margin-top:8px">
        <input id="dlgItemNameAlt" placeholder="Alt Name (ItemNameAlt)" style="flex:2"/>
        <input id="dlgItemRef" placeholder="Item # (ItemRef#)" style="flex:1"/>
      </div>
      <div class="row" style="gap:10px; margin-top:8px">
        <input id="dlgCategory" placeholder="Category" style="flex:1"/>
        <input id="dlgUnit" placeholder="Unit" style="flex:1"/>
        <input id="dlgPackSize" type="number" min="1" placeholder="PackSize" style="flex:1"/>
      </div>
      <div class="row" style="gap:10px; margin-top:8px">
        <input id="dlgBarcode" placeholder="Scan or type barcode" style="flex:2"/>
        <button class="btn" id="dlgScanBtn" title="Add another barcode">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M3 6h2v12H3V6zm3 0h2v12H6V6zm3 0h2v12H9V6zm3-2h2v16h-2V4zm3 2h2v12h-2V6zm3 0h2v12h-2V6z'/%3E%3C/svg%3E" alt="Barcode Scanner" style="height:20px;width:20px;">
        </button>
      </div>
      <div class="row" style="gap:8px; margin-top:14px">
        <button class="btn primary" id="dlgSaveBtn">Save</button>
        <button class="btn" id="dlgCancelBtn">Cancel</button>
        <span class="spacer"></span>
        <span class="muted">Saves with <span class="mono">upsertcatalog</span></span>
      </div>
    </div>
  </div>
  <section id="panel-pricing" class="panel">
    <h2>Vendor Pricing <span class="kvd" id="kvPricing"></span></h2>
    <div class="row">
      <select id="vpItem"></select>
      <select id="vpVendor"></select>
      <input id="vpSku" placeholder="Vendor SKU / order #"/>
      <input id="vpPack" type="number" min="1" value="1" placeholder="Pack size"/>
      <input id="vpPrice" type="number" step="0.01" placeholder="Unit price"/>
      <button class="btn" id="vpAddBtn">Upsert Price</button>
      <button class="btn ghost" id="vpRefreshBtn">Refresh</button>
    </div>
    <div id="pricingTable" style="margin-top:10px"></div>
  </section>

  <section id="panel-planner" class="panel">
    <h2>Order Planner <span class="kvd" id="kvPlan"></span></h2>
    <div class="row">
      <select id="reqItem"></select>
      <input id="reqQty" type="number" min="1" value="1" placeholder="Qty"/>
      <button class="btn" id="reqAddBtn">Add to Plan</button>
      <button class="btn" id="resolveBtn">Resolve Best Prices</button>
      <span class="spacer"></span>
      <button class="btn ghost" id="planClearBtn">Clear Plan</button>
    </div>
    <div id="planTable" style="margin-top:10px"></div>
    <h3>Vendor Baskets</h3>
    <div id="vendorGroups"></div>
  </section>

  <section id="panel-orders" class="panel">
    <h2>Orders <span class="kvd" id="kvOrders"></span></h2>
    <div class="row">
      <button class="btn ghost" id="ordersRefreshBtn">Refresh</button>
      <label class="row" style="gap:6px"><input type="checkbox" id="toggleHistory"/> <span class="muted">Show history (Received)</span></label>
      <span class="muted">Quick actions use <span class="mono">updateorderstatus</span></span>
    </div>
    <div id="ordersTable"></div>
  </section>

  <section id="panel-log" class="panel">
    <h2>Activity Log <span class="kvd" id="kvLog"></span></h2>
    <div class="row">
      <button class="btn ghost" id="logRefreshBtn">Refresh</button>
      <span class="muted">Add <code class="badge">listactivity</code> POST mirror on the server to enable this.</span>
    </div>
    <div id="logTable"><p class="muted">Hook this to <span class="mono">listactivity</span> and click Refresh.</p></div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
/*************************
 * CONFIG â€” match Apps Script
 *************************/
const BASE = 'https://ems-inventory-proxy.kylewelch33.workers.dev';

const state = {
  catalog: [],
  vendors: [],
  pricingAll: [],
  plan: [], // [{itemId, qty, selectedVendor, vendorSku, unitPrice}]
  orders: [],
  log: []
};

// Fast lookup maps
let catalogById = new Map();
let vendorsById = new Map();
let catalogSearch = ''; // current search text
let isScannerActive = false;
let quaggaHandler = null;


function getId(obj, ...keys){
  for (const k of keys){
    if (obj && obj[k] != null && obj[k] !== '') return String(obj[k]).trim();
  }
  return '';
}

/************* UI: Tabs *************/
const tabs = [
  { id:'catalog', label:'Catalog Manager' },
  { id:'pricing', label:'Vendor Pricing' },
  { id:'planner', label:'Order Planner' },
  { id:'orders',  label:'Orders' },
  { id:'log',     label:'Activity Log' }
];

function mountTabs(){
  const el = document.getElementById('tabs');
  el.innerHTML = tabs.map((t,i)=>`<button class="tab ${i===0?'active':''}" data-tab="${t.id}">${t.label}</button>`).join('');
  el.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('.tab');
    if(!btn) return;
    const id = btn.dataset.tab;
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b===btn));
    document.querySelectorAll('.panel').forEach(p=>p.classList.toggle('active', p.id===`panel-${id}`));
  });
  document.getElementById('panel-catalog').classList.add('active');
}

/************* Helpers *************/
const $ = id => document.getElementById(id);
const fmt = n => (Number(n||0)).toFixed(2);
const genId = () => (crypto && crypto.randomUUID ? crypto.randomUUID() : `ID-${Math.random().toString(36).slice(2)}-${Date.now()}`);

function nameOf(itemId){
  const id = String(itemId||'').trim();
  const row = catalogById.get(id);
  return row?.ItemName || 'Unknown';
}
function vendorOf(vendorId){
  const id = String(vendorId||'').trim();
  const row = vendorsById.get(id);
  return row?.VendorName || 'Vendor';
}
function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 5200); }

/************* API *************/
async function POST(actionType, payload={}){
  const body = { actionType, ...payload };
  const resp = await fetch(BASE, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    credentials:'include',
    body: JSON.stringify(body)
  });
  const text = await resp.text();
  let data; try{ data = JSON.parse(text); }catch{ data = { ok:false, error:'Non-JSON response', raw:text }; }
  if(!resp.ok || data.ok===false){
    const err = new Error(data.error || `POST ${actionType} failed`); err.code = resp.status; err.data = data; throw err;
  }
  return data;
}
async function GET(action, params={}){
  const q = new URLSearchParams({ action, ...params, _ts: Date.now() }).toString();
  const resp = await fetch(`${BASE}?${q}`, { credentials:'include' });
  const text = await resp.text();
  let data; try{ data = JSON.parse(text); }catch{ data = { ok:false, error:'Non-JSON response', raw:text }; }
  if(!resp.ok || data.ok===false){ const err = new Error(data.error || `GET ${action} failed`); err.code = resp.status; err.data = data; throw err; }
  return data;
}

// Try POST first (no CORS), then fallback to GET if server lacks POST mirror
async function apiLoad({ postAction, getAction, params }){
  try{
    const res = await POST(postAction, params||{});
    return res;
  }catch(err){
    const msg = String(err?.data?.error||'').toLowerCase();
    if (msg.includes('unknown_action') || err.code===405) {
      try{ const res = await GET(getAction, params||{}); toast(`Fallback GET ${getAction} ok`); return res; }
      catch(e2){ throw e2; }
    }
    throw err;
  }
}

/************* Renderers *************/
function renderCatalog(){
  const q = (catalogSearch||'').trim().toLowerCase();
  const list = q
    ? state.catalog.filter(i => {
        const hay = [
          i.ItemName, i.ItemNameAlt, i.Category, i.Unit,
          i['ItemRef#'], i.ItemID
        ].map(v => String(v||'').toLowerCase());
        return hay.some(s => s.includes(q));
      })
    : state.catalog;

  $('kvCatalog').textContent = `(${state.catalog.length}${q?` â€¢ ${list.length} match${list.length===1?'':'es'}`:''})`;

  const rows = list.map(i=>`<tr>
    <td>${i.ItemName||''}</td>
    <td>${i.ItemNameAlt||''}</td>
    <td>${i['ItemRef#']||''}</td>
    <td>${i.Category||''}</td>
    <td>
      <button class="btn" data-edit="${i.ItemID}">Edit</button>
      <button class="btn ghost" data-barcode="${i.ItemID}">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M3 6h2v12H3V6zm3 0h2v12H6V6zm3 0h2v12H9V6zm3-2h2v16h-2V4zm3 2h2v12h-2V6zm3 0h2v12h-2V6z'/%3E%3C/svg%3E" alt="Barcode Scanner" style="height:20px;width:20px;">
      </button>
    </td>
  </tr>`).join('');

  $('catalogTable').innerHTML = rows
    ? `<table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Alt Name</th>
            <th>Item #</th>
            <th>Category</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`
    : '<p class="muted">No items found.</p>';

  // row actions (event delegation)
  $('catalogTable').onclick = (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const id = btn.dataset.edit || btn.dataset.barcode;
    if(!id) return;
    if (btn.dataset.edit) openCatalogDialog(id);
    if (btn.dataset.barcode) handleBarcode(id);
  };
}

function renderVendors(){
  const opts = state.vendors.map(v=>`<option value="${v.VendorID}">${v.VendorName}</option>`).join('');
  $('vpVendor').innerHTML = `<option value="">Vendorâ€¦</option>${opts}`;
}

function hydrateItemSelects(){
  const opts = state.catalog.map(i=>`<option value="${i.ItemID}">${i.ItemName}</option>`).join('');
  $('vpItem').innerHTML = `<option value="">Select itemâ€¦</option>${opts}`;
  $('reqItem').innerHTML = `<option value="">Select itemâ€¦</option>${opts}`;
}

function renderPricingTable(){
  const rows = state.pricingAll.slice(0,400).map(p=>`<tr>
    <td>${nameOf(p.ItemID)}</td>
    <td>${vendorOf(p.VendorID)}</td>
    <td>${p.VendorItemNumber||''}</td>
    <td>${p.PackSize||1}</td>
    <td>$${fmt(p.UnitPrice)}</td>
    <td>${p.Preferred?'<span class="tag">Preferred</span>':''}</td>
  </tr>`).join('');
  $('kvPricing').textContent = `(${state.pricingAll.length})`;
  $('pricingTable').innerHTML = rows ? `<table><thead><tr><th>Item</th><th>Vendor</th><th>Vendor SKU</th><th>Pack</th><th>Unit Price</th><th></th></tr></thead><tbody>${rows}</tbody></table>`
                                     : '<p class="muted">No vendor pricing rows.</p>';
}

function renderPlan(){
  $('kvPlan').textContent = `(${state.plan.length})`;
  if(!state.plan.length){ $('planTable').innerHTML = '<p class="muted">No items planned yet.</p>'; return; }
  const rows = state.plan.map(r=>`<tr>
    <td>${nameOf(r.itemId)}</td>
    <td>${r.qty}</td>
    <td>${r.selectedVendor? vendorOf(r.selectedVendor):'<span class="muted">â€”</span>'}</td>
    <td>${r.vendorSku||''}</td>
    <td>${r.unitPrice? '$'+fmt(r.unitPrice):''}</td>
  </tr>`).join('');
  $('planTable').innerHTML = `<table><thead><tr><th>Item</th><th>Qty</th><th>Vendor</th><th>Vendor SKU</th><th>Price</th></tr></thead><tbody>${rows}</tbody></table>`;
}
function openCatalogDialog(itemId){
  const i = state.catalog.find(r => String(r.ItemID)===String(itemId));
  if(!i){ toast('Item not found'); return; }
  $('dlgItemID').value     = i.ItemID || '';
  $('dlgItemName').value   = i.ItemName || '';
  $('dlgItemNameAlt').value= i.ItemNameAlt || '';
  $('dlgItemRef').value    = i['ItemRef#'] || '';
  $('dlgCategory').value   = i.Category || '';
  $('dlgUnit').value       = i.Unit || '';
  $('dlgPackSize').value   = Number(i.PackSize||1);
  $('catalogDialog').style.display = 'flex';
}

$('dlgCancelBtn').onclick = ()=>{ $('catalogDialog').style.display = 'none'; };

$('dlgSaveBtn').onclick = async ()=>{
  const btn = $('dlgSaveBtn');
  btn.disabled = true;

  const item = {
    ItemID: genId(),
    ItemName: $('dlgItemName').value.trim(),
    ItemNameAlt: $('dlgItemNameAlt').value.trim(),
    ['ItemRef#']: $('dlgItemRef').value.trim(),
    Category: $('dlgCategory').value.trim(),
    Unit: $('dlgUnit').value.trim(),
    PackSize: Number($('dlgPackSize').value || 1)
  };

  if (!item.ItemID || !item.ItemName) {
    alert('Item Name is required');
    btn.disabled = false;
    return;
  }

  const bc = $('dlgBarcode').value.trim();

  try {
    // 1) Save catalog item
    await POST('upsertcatalog', { item });

    // 2) (optional) Save/attach barcode if present
    if (bc) {
      await POST('upsertbarcode', { barcode: bc, itemId: item.ItemID });
    }

    toast('Catalog item updated');
    $('catalogDialog').style.display = 'none';
    await loadCatalog();

  } catch (err) {
    toast(`Save failed: ${err.message}`);
  } finally {
    btn.disabled = false;
  }
};

function startScanner(onDetected) {
  if (isScannerActive) return;
  isScannerActive = true;

  const viewport = $('interactive');
  viewport.style.display = 'block';

  if (quaggaHandler && typeof Quagga.offDetected === 'function') {
    Quagga.offDetected(quaggaHandler);
    quaggaHandler = null;
  }

  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: viewport, // the #interactive div
      constraints: { facingMode: "environment" }
    },
    decoder: {
      readers: ["code_128_reader","ean_reader","ean_8_reader","upc_reader","upc_e_reader"]
    }
  }, function(err) {
    if (err) {
      console.error(err);
      toast("Scanner error: " + err.message);
      stopScanner();
      return;
    }
    Quagga.start();
  });

  quaggaHandler = function(result) {
    const code = result.codeResult?.code;
    if (code) {
      toast("Scanned: " + code);
      if (onDetected) onDetected(code);
      stopScanner();
    }
  };

  if (typeof Quagga.onDetected === 'function') {
    Quagga.onDetected(quaggaHandler);
  }
}

function stopScanner() {
  try {
    if (typeof Quagga.stop === 'function') {
      Quagga.stop();
    }
  } catch(err){
    console.warn('Quagga.stop failed', err);
  }
  if (quaggaHandler && typeof Quagga.offDetected === 'function') {
    Quagga.offDetected(quaggaHandler);
  }
  quaggaHandler = null;
  $('interactive').style.display = 'none';
  isScannerActive = false;
}

// Catalog table barcode button
function handleBarcode(itemId){
  const item = state.catalog.find(r => String(r.ItemID)===String(itemId));
  if(!item){ toast('Item not found'); return; }

  startScanner(code => {
    // Save barcode to this item
    $('dlgBarcode').value = code;
    openCatalogDialog(itemId);
  });
}


function renderVendorGroups(){
  const groups = {};
  state.plan.filter(r=>r.selectedVendor).forEach(r=>{ (groups[r.selectedVendor]??=[]).push(r); });

  const sorted = Object.entries(groups)
    .map(([vendorId,rows])=>({ vendorId, rows, vendorName: vendorOf(vendorId) }))
    .sort((a,b)=> a.vendorName.localeCompare(b.vendorName));

  const html = sorted.map(({vendorId, rows, vendorName})=>{
    const subtotal = rows.reduce((s,r)=> s + (Number(r.unitPrice||0)*Number(r.qty||0)), 0);
    const lines = rows
      .slice()
      .sort((a,b)=> nameOf(a.itemId).localeCompare(nameOf(b.itemId)))
      .map(r=>`<tr><td>${nameOf(r.itemId)}</td><td>${r.vendorSku||''}</td><td>${r.qty}</td><td>$${fmt(r.unitPrice)}</td><td>$${fmt(r.unitPrice*r.qty)}</td></tr>`)
      .join('');
    return `<div class="vendor-basket">
      <div class="row"><strong>${vendorName}</strong><span class="muted">Subtotal $${fmt(subtotal)}</span>
      <span class="spacer"></span>
      <button class="btn primary" onclick="quickMarkOrdered('${vendorId}')">Mark Ordered</button></div>
      <table><thead><tr><th>Item</th><th>Vendor SKU</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody>${lines}</tbody></table>
    </div>`;
  }).join('') || '<p class="muted">Resolve prices to build vendor baskets.</p>';

  $('vendorGroups').innerHTML = html;
}

function renderOrders(){
  const showHistory = $('toggleHistory').checked;
  const list = (state.orders||[]);
  const visible = list.filter(o => showHistory ? true : (String(o.Status||'').toLowerCase() !== 'received'));
  const rows = visible.map(o=>`<tr>
    <td class="mono">${o.OrderID||o.OrderId||''}</td>
    <td>${o.ItemID? nameOf(o.ItemID) : (o.VendorID? vendorOf(o.VendorID):'')}</td>
    <td>${o.Status||''}</td>
    <td>${o.Timestamp||o.CreatedAt||''}</td>
    <td>
      <button class="btn" onclick="setOrderStatus('${o.OrderID}','Planned')">Planned</button>
      <button class="btn" onclick="setOrderStatus('${o.OrderID}','Ordered')">Ordered</button>
      <button class="btn" onclick="setOrderStatus('${o.OrderID}','Received')">Received</button>
    </td>
  </tr>`).join('');
  $('kvOrders').textContent = `(${list.length}${showHistory?' incl. hist.':''})`;
  const caption = showHistory ? 'All Orders (including Received)' : 'Open & Pending Orders';
  $('ordersTable').innerHTML = rows ? `<table><caption style="text-align:left;margin-bottom:6px" class="muted">${caption}</caption><thead><tr><th>OrderID</th><th>Item/Vendor</th><th>Status</th><th>Timestamp</th><th>Quick Actions</th></tr></thead><tbody>${rows}</tbody></table>`
                                   : `<p class="muted">No orders ${showHistory?'in history or open.':'open/pending.'}</p>`;
}

function renderLog(){
  $('kvLog').textContent = `(${state.log.length})`;
  if(!state.log.length){ $('logTable').innerHTML = '<p class="muted">No log rows (yet). Add a POST mirror for <span class="mono">listactivity</span> and click Refresh.</p>'; return; }
  const rows = state.log.map(a=>`<tr>
    <td>${a.Timestamp||a.When||''}</td><td>${a.UserAgent||a.Who||''}</td>
    <td>${a.Action||''}</td><td>${a.Unit||a.EntityType||''}</td>
    <td class="mono muted">${a.ItemID||a.EntityID||''}</td>
    <td class="mono muted">${a.Notes||''}</td>
  </tr>`).join('');
  $('logTable').innerHTML = `<table><thead><tr><th>When</th><th>User</th><th>Action</th><th>Scope</th><th>ID</th><th>Notes</th></tr></thead><tbody>${rows}</tbody></table>`;
}

/************* Actions *************/
$('catAddBtn').onclick = async ()=>{
  const name = $('catName').value.trim();
  if(!name){ alert('Item name required'); return; }
  const item = {
    ItemID: genId(),
    ItemName: name,
    Category: $('catCategory').value.trim(),
    Unit: $('catUnit').value.trim(),
    PackSize: Number($('catPack').value||1)
  };
  try{
    await POST('upsertcatalog', { item });
    toast('Catalog item saved');
    $('catName').value=''; $('catCategory').value=''; $('catUnit').value=''; $('catPack').value=1;
    await loadCatalog(); hydrateItemSelects();
  }catch(err){ toast(`Save failed: ${err.message}`); }
};

// Ensure new pricing rows have unique PricingID and LastChecked
$('vpAddBtn').onclick = async ()=>{
  const row = {
    PricingID: genId(),
    ItemID: $('vpItem').value,
    VendorID: $('vpVendor').value,
    VendorItemNumber: $('vpSku').value.trim(),
    PackSize: Number($('vpPack').value||1),
    UnitPrice: Number($('vpPrice').value||0),
    LastChecked: new Date().toISOString().slice(0,10), // YYYY-MM-DD
    Preferred: false
  };
  if(!row.ItemID || !row.VendorID){ alert('Select item and vendor'); return; }
  try{
    await POST('upsertvendorprice', { row });
    toast('Vendor price saved');
    $('vpSku').value=''; $('vpPack').value=1; $('vpPrice').value='';
    await loadPricing();
  }catch(err){ toast(`Save failed: ${err.message}`); }
};
$('vpRefreshBtn').onclick = ()=>loadPricing().catch(err=>toast(err.message));

$('reqAddBtn').onclick = ()=>{
  const itemId = $('reqItem').value, qty = Number($('reqQty').value||0);
  if(!itemId || qty<1) return;
  state.plan.push({ itemId, qty });
  renderPlan(); renderVendorGroups();
};
$('resolveBtn').onclick = ()=>{
  state.plan = state.plan.map(row=>{
    const candidates = state.pricingAll.filter(p=>String(p.ItemID)===String(row.itemId));
    if(!candidates.length) return row;
    const preferred = candidates.find(c=>String(c.Preferred).toLowerCase()==='true' || c.Preferred===true);
    const best = preferred || candidates.map(p=>({p, cmp:(Number(p.UnitPrice)||0)/Math.max(1,Number(p.PackSize||1))}))
                                      .sort((a,b)=>a.cmp-b.cmp)[0].p;
    return { ...row,
      selectedVendor: best.VendorID,
      vendorSku: (best.VendorItemNumber||''),
      unitPrice: Number(best.UnitPrice)||0
    };
  });
  renderPlan(); renderVendorGroups();
};
$('planClearBtn').onclick = ()=>{ state.plan = []; renderPlan(); renderVendorGroups(); };

async function quickMarkOrdered(vendorId){
  const lines = state.plan.filter(r=>r.selectedVendor===vendorId);
  try{
    for(const r of lines){
      const res = await POST('createrequest', { itemId: r.itemId, qty: r.qty, notes: `Auto from planner | Vendor:${vendorOf(vendorId)} | SKU:${r.vendorSku}` });
      await POST('updateorderstatus', { orderId: res.orderId, status: 'Ordered' });
    }
    await loadOrders();
    toast(`Marked ${lines.length} line(s) Ordered for ${vendorOf(vendorId)}`);
  }catch(err){ toast(`Order error: ${err.message}`); }
}

async function setOrderStatus(orderId, status){
  try{ await POST('updateorderstatus', { orderId, status }); await loadOrders(); toast(`Order ${orderId}: ${status}`); }
  catch(err){ toast(`Status failed: ${err.message}`); }
}

/************* Loaders *************/
async function loadCatalog(){
  try{
    const res = await apiLoad({ postAction:'listcatalog', getAction:'listcatalog' });
    state.catalog = (res.rows||[]).map(r=>{
      const ItemID = getId(r, 'ItemID','ItemId','itemId');
      return { ...r, ItemID };
    });
    catalogById = new Map(state.catalog.map(r => [String(r.ItemID).trim(), r]));
    renderCatalog(); hydrateItemSelects();
    if (state.pricingAll?.length) renderPricingTable();
  }catch(err){ toast(`Catalog load: ${err.message}`); console.error('Catalog load error', err); }
}

async function loadVendors(){
  try{
    const res = await apiLoad({ postAction:'listvendors', getAction:'listvendors' });
    state.vendors = (res.rows||[]).map(r=>{
      const VendorID = getId(r, 'VendorID','VendorId','vendorId');
      return { ...r, VendorID };
    });
    vendorsById = new Map(state.vendors.map(r => [String(r.VendorID).trim(), r]));
    renderVendors();
    if (state.pricingAll?.length) renderPricingTable();
  }catch(err){ toast(`Vendors load: ${err.message}`); console.error('Vendors load error', err); }
}

async function loadPricing(itemId){
  try{
    const params = itemId ? { itemId } : {};
    const res = await apiLoad({ postAction:'listvendorpricing', getAction:'listvendorpricing', params });
    state.pricingAll = (res.rows||[]).map(p=>{
      const ItemID   = getId(p, 'ItemID','ItemId','itemId');
      const VendorID = getId(p, 'VendorID','VendorId','vendorId');
      const VendorItemNumber = p.VendorItemNumber ?? p.VendorSKU ?? p.vendorSku ?? '';
      const PackSize = Number(p.PackSize ?? 1);
      const UnitPrice = Number(p.UnitPrice ?? 0);
      const Preferred = (String(p.Preferred).toLowerCase()==='true' || p.Preferred===true);
      const PricingID = getId(p, 'PricingID','PricingId','pricingId');
      const LastChecked = p.LastChecked ?? '';
      return { ...p, ItemID, VendorID, VendorItemNumber, PackSize, UnitPrice, Preferred, PricingID, LastChecked };
    });
    renderPricingTable();
  }catch(err){ toast(`Pricing load: ${err.message}`); console.error('Pricing load error', err); }
}

async function loadOrders(){
  try{
    const res = await apiLoad({ postAction:'getrequestpagedata', getAction:'getrequestpagedata' });
    state.orders = (res.orders || res.Orders || []);
    renderOrders();
  }catch(err){ toast(`Orders load: ${err.message}`); console.error('Orders load error', err); }
}

async function loadLog(){
  try{
    const res = await apiLoad({ postAction:'listactivity', getAction:'listactivity' });
    state.log = res.rows || [];
    renderLog();
  }catch(err){ toast(`Log load: ${err.message}`); console.error('Log load error', err); }
}


/************* Diagnostics *************/
function reportConnectivity(ok, msg=''){
  const el = $('statusIcon');
  if(ok){ el.textContent='Connected'; el.classList.remove('bad'); el.classList.add('ok'); el.classList.add('pill','ok'); }
  else { el.textContent='Problem'; el.classList.remove('ok'); el.classList.add('bad'); el.classList.add('pill','bad'); if(msg) toast(msg); }
}

$('btnTestApi').onclick = async ()=>{
  try{ const r = await POST('pingpost'); toast('API OK'); reportConnectivity(true); console.debug('pingpost:', r); }
  catch(err){ reportConnectivity(false, err.message); }
};
$('btnProbe').onclick = async ()=>{
  const out = { };
  try{ out.catalog = await apiLoad({ postAction:'listcatalog', getAction:'listcatalog' }); }catch(e){ out.catalog = { error: String(e.message) }; }
  try{ out.vendors = await apiLoad({ postAction:'listvendors', getAction:'listvendors' }); }catch(e){ out.vendors = { error: String(e.message) }; }
  try{ out.pricing = await apiLoad({ postAction:'listvendorpricing', getAction:'listvendorpricing' }); }catch(e){ out.pricing = { error: String(e.message) }; }
  try{ out.orders  = await apiLoad({ postAction:'getrequestpagedata', getAction:'getrequestpagedata' }); }catch(e){ out.orders = { error: String(e.message) }; }
  try{ out.activity= await apiLoad({ postAction:'listactivity', getAction:'listactivity' }); }catch(e){ out.activity = { error: String(e.message) }; }
  console.table({
    catalog: out.catalog?.rows?.length ?? out.catalog?.error ?? 'n/a',
    vendors: out.vendors?.rows?.length ?? out.vendors?.error ?? 'n/a',
    pricing: out.pricing?.rows?.length ?? out.pricing?.error ?? 'n/a',
    orders:  (out.orders?.orders||out.orders?.Orders||[])?.length ?? out.orders?.error ?? 'n/a',
    activity: out.activity?.rows?.length ?? out.activity?.error ?? 'n/a'
  });
  toast('Probe complete â€” open console for counts');
};

async function boot(){
  mountTabs();
  $('baseEcho').textContent = BASE;
  POST('pingpost', { hello:'boot' })
    .then(()=>reportConnectivity(true))
    .catch(()=>reportConnectivity(false));
  await Promise.allSettled([loadCatalog(), loadVendors(), loadPricing()]);
  await Promise.allSettled([loadOrders(), loadLog()]);
  // second pass to ensure names resolve after maps are built
  setTimeout(()=>{ renderPricingTable(); renderPlan(); renderVendorGroups(); }, 0);
  // Hook refresh buttons
  $('ordersRefreshBtn').onclick = ()=>loadOrders().catch(err=>toast(err.message));
  $('toggleHistory').onchange = ()=>renderOrders();
  $('logRefreshBtn').onclick = ()=>loadLog().catch(err=>toast(err.message));
  // Search box for Catalog
  $('catSearch').addEventListener('input', (e)=>{
    catalogSearch = e.target.value || '';
    renderCatalog();
  });

}
boot();
// Scanner buttons
$('startScanBtn').onclick = () => {
  startScanner(code => {
    $('catSearch').value = code;
    catalogSearch = code;
    renderCatalog();
  });
};

$('dlgScanBtn').onclick = () => {
  startScanner(code => {
    $('dlgBarcode').value = code;
  });
};


// ---- Global error hardening (ignore noisy extension message) ----
window.addEventListener('unhandledrejection', (ev)=>{
  const msg = (ev && ev.reason && (ev.reason.message||ev.reason.toString())) || 'Unhandled promise rejection';
  if (/listener indicated an asynchronous response/i.test(msg)) return;
  console.error('[unhandledrejection]', ev.reason);
  if (typeof toast==='function') toast(msg);
  ev.preventDefault();
});
window.addEventListener('error', (ev)=>{
  const msg = (ev && ev.message) || 'Script error';
  if (/listener indicated an asynchronous response/i.test(msg)) return;
  console.error('[error]', msg, ev.error);
  if (typeof toast==='function') toast(msg);
});
</script>
</body>
</html>