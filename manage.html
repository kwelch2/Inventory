<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EMS Admin – Catalog & Vendor Pricing</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .tabs{display:flex;gap:8px;margin:10px 0 12px}
  .tab{padding:8px 12px;border:1px solid var(--b);border-radius:999px;background:#fafafa;cursor:pointer}
  .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;margin:8px 0 6px;font-weight:600}
  input,select,button,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .actions button{width:auto;margin-right:6px}
  .muted{color:var(--muted);font-size:.9rem}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--b)}
  .ok{color:green} .err{color:#b00020}
  .hidden{display:none}
  .section{margin-top:16px}
</style>
</head>
<body>
<div class="wrap">
  <h1>EMS Admin</h1>
  <div class="tabs">
    <div class="tab" data-tab="catalog">Catalog</div>
    <div class="tab" data-tab="pricing">Vendor Pricing</div>
  </div>

  <div class="card" id="catalog">
    <div class="row">
      <div>
        <label>Search Catalog</label>
        <input id="catSearch" placeholder="Search by name or ItemID">
      </div>
      <div>
        <label class="muted">Counts</label>
        <div id="catCounts" class="muted"></div>
      </div>
    </div>

    <div class="section">
      <h3>Add / Edit Item</h3>
      <div class="row">
        <div><label>ItemID</label><input id="cItemID" placeholder="NC-ADULT"></div>
        <div><label>ItemName</label><input id="cItemName" placeholder="Nasal Cannula – Adult"></div>
      </div>
      <div class="row">
        <div><label>Category</label><input id="cCategory"></div>
        <div><label>Default Unit of Issue</label><input id="cUOI" placeholder="BX (50) / EA"></div>
      </div>
      <div class="row">
        <div><label>Min PAR</label><input id="cMinPAR" placeholder="e.g., 6 EA"></div>
        <div><label>Notes</label><input id="cNotes"></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="btnUpsertItem">Save Item</button>
        <button id="btnDeleteItem">Delete Item</button>
        <span id="catMsg" class="muted"></span>
      </div>
    </div>

    <div class="section">
      <h3>Catalog (filtered)</h3>
      <table id="catTable"><thead><tr>
        <th>ItemID</th><th>ItemName</th><th>Category</th><th>UOI</th><th>MinPAR</th><th>Notes</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="card hidden" id="pricing">
    <div class="row">
      <div>
        <label>Pick Item</label>
        <input id="pItemSearch" list="items" placeholder="Type to search…">
        <datalist id="items"></datalist>
      </div>
      <div>
        <label class="muted">Tip</label>
        <div class="muted">Preferred marks the chosen vendor for this item. Cheapest price will be highlighted.</div>
      </div>
    </div>

    <div class="section">
      <h3>Add / Edit Vendor Price</h3>
      <div class="row">
        <div><label>ItemID</label><input id="pItemID" readonly></div>
        <div><label>Vendor</label><select id="pVendor"></select></div>
      </div>
      <div class="row">
        <div><label>Vendor Item #</label><input id="pVendorItem"></div>
        <div><label>Pack Size</label><input id="pPack"></div>
      </div>
      <div class="row">
        <div><label>Unit Price</label><input id="pPrice" placeholder="e.g., 11.17"></div>
        <div><label>Last Checked</label><input id="pChecked" type="date"></div>
      </div>
      <div class="row">
        <div><label>Preferred</label><select id="pPreferred"><option value="">No</option><option value="TRUE">Yes</option></select></div>
        <div><label>Notes</label><input id="pNotes"></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="btnUpsertPrice">Save Price</button>
        <button id="btnDeletePrice">Delete Price</button>
        <button id="btnSetPreferred">Set Preferred</button>
        <span id="pMsg" class="muted"></span>
      </div>
    </div>

    <div class="section">
      <h3>Prices for Item</h3>
      <table id="pTable"><thead><tr>
        <th>Vendor</th><th>Vendor Item #</th><th>Pack</th><th>Unit Price</th><th>Last Checked</th><th>Preferred</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
/*** EDIT THESE ****/
const CSV_CATALOG  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pubhtml?gid=1603897332&single=true&output=csv';
const CSV_VENDORPR = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pubhtml?gid=1795212434&single=true&output=csv';
const CSV_VENDORS  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pubhtml?gid=1079994552&single=true&output=csv';
const API_URL      = 'https://ems-inventory-proxy.kylewelch33.workers.dev';
/*******************/

let catHead=[], catRows=[], vendors=[], vpHead=[], vpRows=[];

function parseCSV(text){
  // strip BOM, trim, drop empty lines
  const clean = (text || '').replace(/^\uFEFF/, '').trim();
  if (!clean) return [];
  const lines = clean.split(/\r?\n/).filter(l => l.trim() !== '');
  return lines.map(line => {
    const m = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
    return m.map(s => s.replace(/^"|"$/g,''));
  });
}

function toObj(head, row){
  const o = {};
  for (let i=0; i<head.length; i++) {
    o[head[i]] = (row && row[i] != null) ? row[i] : '';
  }
  return o;
}

function objToTable(tbody, rows, cols, rowClick){
  tbody.innerHTML = rows.map(r=>`<tr>${cols.map(c=>`<td>${r[c]||''}</td>`).join('')}</tr>`).join('') || '<tr><td colspan="'+cols.length+'">No rows</td></tr>';
  if (rowClick) Array.from(tbody.querySelectorAll('tr')).forEach((tr,i)=> tr.addEventListener('click', ()=> rowClick(rows[i])));
}

async function callApi(actionType, payload={}){
  const resp = await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body: JSON.stringify({ actionType, ...payload })
  });
  const text = await resp.text();
  let data;
  try { data = JSON.parse(text); }
  catch { throw new Error(`Non-JSON response: ${text.slice(0,200)}`); }
  if(!resp.ok || data.ok === false){
    const err = new Error(data?.error || `Action ${actionType} failed`);
    err.data = data;
    throw err;
  }
  return data;
}

async function boot(){
  // Load CSVs
  const [catText, vpText, vText] = await Promise.all([
    fetch(CSV_CATALOG).then(r=>r.text()),
    fetch(CSV_VENDORPR).then(r=>r.text()),
    fetch(CSV_VENDORS).then(r=>r.text())
  ]);

  const c = parseCSV(catText); catHead = c.shift(); catRows = c.map(r=>toObj(catHead,r));
  const p = parseCSV(vpText);  vpHead  = p.shift(); vpRows  = p.map(r=>toObj(vpHead,r));
  const v = parseCSV(vText);   const vHead=v.shift(); vendors = v.map(r=>toObj(vHead,r));

  // Prep UI lists
  const items = [...new Set(catRows.map(x=>x.ItemName).filter(Boolean))].sort();
  document.getElementById('items').innerHTML = items.map(n=>`<option value="${n}">`).join('');
  document.getElementById('pVendor').innerHTML = vendors.map(v=>`<option value="${v.VendorID}">${v.VendorName||v.VendorID}</option>`).join('');

  // Render catalog
  renderCatalog();
}
function renderCatalog(){
  const q = (document.getElementById('catSearch').value || '').toLowerCase();

  // guard against missing keys/blank rows
  const rows = catRows.filter(r => {
    if (!r || typeof r !== 'object') return false;
    const name = (r.ItemName || '').toString().toLowerCase();
    const id   = (r.ItemID   || '').toString().toLowerCase();
    // keep rows that have *either* id or name
    if (!name && !id) return false;
    return !q || name.includes(q) || id.includes(q);
  });

  document.getElementById('catCounts').textContent = `${rows.length} items (of ${catRows.length})`;

  objToTable(
    document.querySelector('#catTable tbody'),
    rows,
    ['ItemID','ItemName','Category','DefaultUnitOfIssue','MinPAR','Notes'],
    (r) => {
      document.getElementById('cItemID').value   = r.ItemID || '';
      document.getElementById('cItemName').value = r.ItemName || '';
      document.getElementById('cCategory').value = r.Category || '';
      document.getElementById('cUOI').value      = r.DefaultUnitOfIssue || '';
      document.getElementById('cMinPAR').value   = r.MinPAR || '';
      document.getElementById('cNotes').value    = r.Notes || '';

      // prefill pricing tab
      document.getElementById('pItemID').value     = r.ItemID || '';
      document.getElementById('pItemSearch').value = r.ItemName || '';
      renderPricesFor(r.ItemID || '');
    }
  );
}

function renderPricesFor(itemId){
  const rows = vpRows.filter(r => r && r.ItemID === itemId);

  let cheapest = null, min = Infinity;
  rows.forEach(r => {
    const n = Number(r && r.UnitPrice || '');
    if (!isNaN(n) && n < min){ min = n; cheapest = r; }
  });

  const tbody = document.querySelector('#pTable tbody');
  tbody.innerHTML = rows.map(r=>{
    const isCheapest = cheapest && r === cheapest;
    return `<tr>
      <td>${r.VendorID || ''}</td>
      <td>${r.VendorItemNumber || ''}</td>
      <td>${r.PackSize || ''}</td>
      <td>${r.UnitPrice || ''} ${isCheapest ? '<span class="pill">cheapest</span>' : ''}</td>
      <td>${r.LastChecked || ''}</td>
      <td>${String(r.Preferred || '')}</td>
    </tr>`;
  }).join('') || '<tr><td colspan="6">No vendor prices yet</td></tr>';
}

/*** Catalog actions ***/
document.getElementById('catSearch').addEventListener('input', renderCatalog);
document.getElementById('btnUpsertItem').addEventListener('click', async ()=>{
  const item = {
    ItemID: document.getElementById('cItemID').value.trim(),
    ItemName: document.getElementById('cItemName').value.trim(),
    Category: document.getElementById('cCategory').value.trim(),
    DefaultUnitOfIssue: document.getElementById('cUOI').value.trim(),
    MinPAR: document.getElementById('cMinPAR').value.trim(),
    Notes: document.getElementById('cNotes').value.trim(),
  };
  const msg = document.getElementById('catMsg');
  if (!item.ItemID || !item.ItemName){ msg.textContent='ItemID and ItemName are required'; return; }
  msg.textContent='Saving…';
  try {
    await callApi('upsertCatalog', { item });
    msg.innerHTML='<span class="ok">Saved</span>';
  } catch(err){
    console.error(err);
    msg.innerHTML='<span class="err">Save failed</span>';
  }
});
document.getElementById('btnDeleteItem').addEventListener('click', async ()=>{
  const id = document.getElementById('cItemID').value.trim();
  if (!id) return;
  const msg = document.getElementById('catMsg');
  msg.textContent='Deleting…';
  try {
    await callApi('deleteCatalog', { itemId:id });
    msg.innerHTML='<span class="ok">Deleted</span>';
  } catch(err){
    console.error(err);
    msg.innerHTML='<span class="err">Delete failed</span>';
  }
});

/*** Pricing actions ***/
document.getElementById('pItemSearch').addEventListener('change', ()=>{
  const name = document.getElementById('pItemSearch').value;
  const found = catRows.find(r=>r.ItemName===name);
  if (found){ document.getElementById('pItemID').value = found.ItemID; renderPricesFor(found.ItemID); }
});
document.getElementById('btnUpsertPrice').addEventListener('click', async ()=>{
  const row = {
    ItemID: document.getElementById('pItemID').value.trim(),
    VendorID: document.getElementById('pVendor').value.trim(),
    VendorItemNumber: document.getElementById('pVendorItem').value.trim(),
    PackSize: document.getElementById('pPack').value.trim(),
    UnitPrice: document.getElementById('pPrice').value.trim(),
    LastChecked: document.getElementById('pChecked').value,
    Preferred: document.getElementById('pPreferred').value
  };
  const msg = document.getElementById('pMsg');
  if (!row.ItemID || !row.VendorID){ msg.textContent='Item and Vendor required'; return; }
  msg.textContent='Saving…';
  try {
    await callApi('upsertVendorPrice', { row });
    msg.innerHTML='<span class="ok">Saved</span>';
  } catch(err){
    console.error(err);
    msg.innerHTML='<span class="err">Save failed</span>';
  }
});
document.getElementById('btnDeletePrice').addEventListener('click', async ()=>{
  const ItemID = document.getElementById('pItemID').value.trim();
  const VendorID = document.getElementById('pVendor').value.trim();
  const VendorItemNumber = document.getElementById('pVendorItem').value.trim();
  const msg = document.getElementById('pMsg');
  if (!ItemID || !VendorID){ msg.textContent='Item and Vendor required'; return; }
  msg.textContent='Deleting…';
  try {
    await callApi('deleteVendorPrice', { ItemID, VendorID, VendorItemNumber });
    msg.innerHTML='<span class="ok">Deleted</span>';
  } catch(err){
    console.error(err);
    msg.innerHTML='<span class="err">Delete failed</span>';
  }
});
document.getElementById('btnSetPreferred').addEventListener('click', async ()=>{
  const itemId = document.getElementById('pItemID').value.trim();
  const vendorId = document.getElementById('pVendor').value.trim();
  const msg = document.getElementById('pMsg');
  if (!itemId || !vendorId){ msg.textContent='Pick item & vendor'; return; }
  msg.textContent='Setting…';
  try {
    await callApi('setPreferred', { itemId, vendorId });
    msg.innerHTML='<span class="ok">Preferred set</span>';
  } catch(err){
    console.error(err);
    msg.innerHTML='<span class="err">Set failed</span>';
  }
});

document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click', ()=>{
  document.getElementById('catalog').classList.toggle('hidden', b.dataset.tab!=='catalog');
  document.getElementById('pricing').classList.toggle('hidden', b.dataset.tab!=='pricing');
}));
boot();
</script>
</body>
</html>
