<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Supply Request – GC EMS</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
  h1,h2{margin:0 0 8px}
  label{display:block;margin:10px 0 6px;font-weight:600}
  input,button,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
  button.btn{width:auto;padding:6px 10px;cursor:pointer}
  .muted{color:var(--muted);font-size:.9rem}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  .status-btns button{width:auto;margin-right:5px}
  .status-btns .active{background:#0275d8;color:#fff;border-color:#0275d8}
  .vendor-table{font-size:.9em;margin-top:8px;background:#fafafa}
  .vendor-table th,.vendor-table td{padding:4px}
  summary{cursor:pointer;font-weight:bold}
  .toolbar{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>

<div id="password-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:2000;">
    <div style="background:white; padding:2rem; border-radius:8px; text-align:center;">
        <h3>Enter Passcode</h3>
        <input type="password" id="passcodeInput" style="margin-bottom:1rem;"/>
        <button id="passwordSubmit">Submit</button>
        <p id="password-error" style="color:red; display:none;">Incorrect Passcode</p>
    </div>
</div>

<div class="wrap" style="display:none;">
    <div class="card" style="margin-top:16px;">
    <h2>Pending Requests</h2>
    <table id="pendingTable">
      <thead><tr><th>Item / Vendor Pricing</th><th>Qty</th><th>Status</th><th>Notes</th></tr></thead>
      <tbody><tr><td colspan="4">Loading...</td></tr></tbody>
    </table>
  </div>

<div class="card" style="margin-top:16px;">
  <details id="requestPane">
    <summary style="font-size:1.25em;font-weight:bold;">New Request</summary>
    <div style="margin-top:12px">
      <label for="itemSearch">Item from Catalog</label>
      <input id="itemSearch" list="itemsDatalist" placeholder="Search for an item...">
      <datalist id="itemsDatalist"></datalist>

      <div style="margin:8px 0;">
        <input type="checkbox" id="isOther" style="width:auto;">
        <label for="isOther" style="display:inline;font-weight:normal;">Or, request an item not in the list</label>
      </div>

      <input id="otherItem" placeholder="Enter unlisted item name..." style="display:none;">

      <label for="qty">Quantity (Optional)</label>
      <input id="qty" type="text" placeholder="e.g., 1 Box or 5 EA">

      <label for="notes">Notes (Optional)</label>
      <input id="notes" placeholder="e.g., For Unit 31">

      <button id="submitBtn" style="margin-top:12px;">Submit Request</button>
      <div id="msg" class="muted" style="margin-top:8px;"></div>
      </div>
     </details>
  </div>

  <div class="card" style="margin-top:16px;">
    <details id="historyPane">
      <summary style="font-size:1.5em;font-weight:bold;">View Order History</summary>
      <div class="toolbar">
        <button class="btn hist" data-days="30">Last 30 Days</button>
        <button class="btn hist" data-days="60">Last 60 Days</button>
        <button class="btn hist" data-days="90">Last 90 Days</button>
        <input id="historySearch" placeholder="Search history..." style="width:auto;flex:1;">
      </div>
      <table id="historyTable">
        <thead><tr><th>Item</th><th>Received</th><th>Notes</th></tr></thead>
        <tbody><tr><td colspan="3">Select a date range to view history.</td></tr></tbody>
      </table>
    </details>
  </div>
</div>

<script type="module">
    // --- NEW PASSWORD LOGIC ---
    const SHARED_PASSCODE = "ems1"; // Change this to your desired password
    const passwordModal = document.getElementById('password-modal');
    const passwordInput = document.getElementById('passcodeInput');
    const passwordSubmit = document.getElementById('passwordSubmit');
    const passwordError = document.getElementById('password-error');
    const mainWrap = document.querySelector('.wrap');

    function checkAuth() {
        if (sessionStorage.getItem('isAuthenticated') === 'true') {
            passwordModal.style.display = 'none';
            mainWrap.style.display = 'block';
            boot(); // Initialize the main application logic
        } else {
            mainWrap.style.display = 'none';
            passwordModal.style.display = 'flex';
        }
    }

    passwordSubmit.addEventListener('click', () => {
        if (passwordInput.value === SHARED_PASSCODE) {
            sessionStorage.setItem('isAuthenticated', 'true');
            checkAuth();
        } else {
            passwordError.style.display = 'block';
        }
    });

    // --- YOUR EXISTING SCRIPT (converted to Firebase) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD7pMc-AHXb1cApzSfImkWvIjM9iwCoym4",
        authDomain: "supplies-ems.firebaseapp.com",
        projectId: "supplies-ems"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const state = {
        catalog: [],
        requests: [],
        vendorPricing: [],
        vendors: [],
        catalogMap: new Map(),
        vendorMap: new Map()
    };

    const $ = (sel) => document.querySelector(sel);
    const escapeHtml = (s = "") => String(s).replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
    const money = (v) => { const n = Number(v); return Number.isFinite(n) ? `$${n.toFixed(2)}` : "N/A"; };
    const toDate = (maybeTs) => {
        if (!maybeTs) return null;
        if (maybeTs.seconds) return new Date(maybeTs.seconds * 1000);
        const d = new Date(maybeTs);
        return isNaN(d) ? null : d;
    };

    let currentHistoryDays = 30;
    let currentHistoryQuery = "";

    async function loadAllData() {
        $('#pendingTable tbody').innerHTML = '<tr><td colspan="4">Loading…</td></tr>';
        try {
            const [catSnap, reqSnap, priceSnap, vendorSnap] = await Promise.all([
                getDocs(collection(db, "catalog")),
                getDocs(collection(db, "requests")),
                getDocs(collection(db, "vendorPricing")),
                getDocs(collection(db, "vendors"))
            ]);
            state.catalog = catSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
            state.requests = reqSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
            state.vendorPricing = priceSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
            state.vendors = vendorSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
            state.catalogMap = new Map(state.catalog.map((c) => [c.id, c]));
            state.vendorMap = new Map(state.vendors.map((v) => [v.id, v]));
            populateCatalogDatalist();
            renderPending();
            renderHistory(currentHistoryDays, currentHistoryQuery);
        } catch (err) {
            console.error("Failed to load Firestore data", err);
            $('#pendingTable tbody').innerHTML = '<tr><td colspan="4" style="color:#a00;font-weight:700;">Error loading data from Firestore. Check rules.</td></tr>';
        }
    }

    function populateCatalogDatalist() {
        const options = state.catalog.map(item => `<option value="${escapeHtml(item.itemName)}"></option>`).join("");
        $('#itemsDatalist').innerHTML = options;
    }

    function formatRequestName(request) {
        const catalogItem = request.catalogId ? state.catalogMap.get(request.catalogId) : null;
        return { primary: request.otherItemName || catalogItem?.itemName || "Other Item" };
    }

    function renderPending() {
        const tbody = $('#pendingTable tbody');
        const pending = state.requests.filter((r) => !['received', 'completed', 'closed'].includes(String(r.status || 'open').toLowerCase()));
        if (!pending.length) {
            tbody.innerHTML = '<tr><td colspan="4">No pending requests.</td></tr>';
            return;
        }
        tbody.innerHTML = pending.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).map((request) => {
            const { primary } = formatRequestName(request);
            const pricing = (request.catalogId ? state.vendorPricing.filter((vp) => vp.catalogId === request.catalogId) : []).sort((a, b) => (parseFloat(a.unitPrice) || Infinity) - (parseFloat(b.unitPrice) || Infinity));
            const pricingHTML = pricing.length ? pricing.map(vp => `<tr><td>${state.vendorMap.get(vp.vendorId)?.name || ''}</td><td>${money(vp.unitPrice)}</td><td>${vp.vendorItemNo || ''}</td></tr>`).join("") : '<tr><td colspan="3">No pricing info</td></tr>';
            return `
              <tr>
                <td><details><summary>${escapeHtml(primary)}</summary><table class="vendor-table"><thead><tr><th>Vendor</th><th>Price</th><th>Item#</th></tr></thead><tbody>${pricingHTML}</tbody></table></details></td>
                <td>${escapeHtml(request.qty || '')}</td>
                <td>${escapeHtml(request.status || 'open')}</td>
                <td>${escapeHtml(request.notes || '')}</td>
              </tr>`;
        }).join("");
    }

    function renderHistory(days = 30, queryText = "") {
        currentHistoryDays = Number.isFinite(+days) ? +days : 30;
        currentHistoryQuery = queryText;
        const tbody = $('#historyTable tbody');
        const now = new Date();
        const cutoff = new Date(now.getTime() - currentHistoryDays * 24 * 60 * 60 * 1000);
        const received = state.requests.filter((r) => {
            const status = String(r.status || '').toLowerCase();
            if (!['received', 'completed'].includes(status)) return false;
            const ts = toDate(r.receivedAt || r.updatedAt || r.createdAt);
            return ts && ts >= cutoff;
        });
        const filtered = received.filter((req) => {
            if (!queryText) return true;
            const { primary } = formatRequestName(req);
            return `${primary} ${req.notes || ''}`.toLowerCase().includes(queryText.toLowerCase());
        });
        if (!filtered.length) {
            tbody.innerHTML = `<tr><td colspan="3">No history in the last ${currentHistoryDays} days.</td></tr>`;
            return;
        }
        tbody.innerHTML = filtered.sort((a, b) => (toDate(b.receivedAt || b.updatedAt) || 0) - (toDate(a.receivedAt || a.updatedAt) || 0)).map((req) => {
            const { primary } = formatRequestName(req);
            const ts = toDate(req.receivedAt || req.updatedAt || req.createdAt);
            return `<tr><td>${escapeHtml(primary)}</td><td>${ts ? ts.toLocaleDateString() : ''}</td><td>${escapeHtml(req.notes || '')}</td></tr>`;
        }).join("");
    }

    function setupForm() {
        $('#isOther').addEventListener('change', () => {
            const on = $('#isOther').checked;
            $('#itemSearch').style.display = on ? 'none' : 'block';
            $('#otherItem').style.display = on ? 'block' : 'none';
        });

        $('#submitBtn').addEventListener('click', async () => {
            const msg = $('#msg');
            const onOther = $('#isOther').checked;
            const itemName = $('#itemSearch').value.trim();
            const otherName = $('#otherItem').value.trim();
            
            const data = {
                qty: $('#qty').value.trim() || '',
                notes: $('#notes').value.trim() || '',
                status: 'Open',
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                requesterEmail: 'Public Request'
            };

            if (onOther) {
                if (!otherName) { msg.textContent = 'Please enter the item name.'; return; }
                data.otherItemName = otherName;
                data.catalogId = null;
            } else {
                const catalogItem = state.catalog.find(item => item.itemName.toLowerCase() === itemName.toLowerCase());
                if (!catalogItem) { msg.textContent = 'Please select a valid item or check "other".'; return; }
                data.catalogId = catalogItem.id;
            }

            msg.textContent = 'Submitting…';
            try {
                await addDoc(collection(db, 'requests'), data);
                msg.textContent = 'Request submitted successfully!';
                $('#itemSearch').value = '';
                $('#otherItem').value = '';
                $('#qty').value = '';
                $('#notes').value = '';
                await loadAllData(); 
            } catch (err) {
                console.error('Failed to submit request', err);
                msg.textContent = 'An error occurred submitting the request.';
            }
        });
    }

    function setupHistoryControls() {
        document.querySelectorAll('button.hist').forEach(btn => btn.addEventListener('click', () => renderHistory(Number(btn.dataset.days), currentHistoryQuery)));
        $('#historySearch').addEventListener('input', (e) => renderHistory(currentHistoryDays, e.target.value));
        $('#historyPane').addEventListener('toggle', (e) => { if (e.target.open) renderHistory(currentHistoryDays, currentHistoryQuery); });
    }

    async function boot() {
        await loadAllData();
        setupForm();
        setupHistoryControls();
    }
    
    checkAuth();
</script>
</body>
</html>