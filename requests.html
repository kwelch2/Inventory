<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Supply Request â€“ GC EMS</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
  h1,h2{margin:0 0 8px}
  label{display:block;margin:10px 0 6px;font-weight:600}
  input,button,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
  button.btn, a.btn{width:auto;padding:6px 10px;}
  .muted{color:var(--muted);font-size:.9rem}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top;}
  .status-btns button{width:auto; margin-right:5px;}
  .status-btns .active{background-color:#4CAF50;color:white;border-color:#4CAF50;}
  .vendor-table{font-size:0.9em; margin-top:8px;}
  .vendor-table th, .vendor-table td {padding:4px;}
  summary {cursor:pointer;}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Supply Request</h1>
    <label for="itemSearch">Item from Catalog</label>
    <input id="itemSearch" list="itemsDatalist" placeholder="Search for an item...">
    <datalist id="itemsDatalist"></datalist>
    <div style="margin: 8px 0;">
        <input type="checkbox" id="isOther" style="width:auto;">
        <label for="isOther" style="display:inline;font-weight:normal;">Or, request an item not in the list</label>
    </div>
    <input id="otherItem" placeholder="Enter unlisted item name..." style="display:none;">
    <label for="qty">Quantity (Optional)</label>
    <input id="qty" type="text" placeholder="e.g., 1 Box or 5 EA">
    <label for="notes">Notes (Optional)</label>
    <input id="notes" placeholder="e.g., For Unit 31">
    <button id="submitBtn" style="margin-top:12px;">Submit Request</button>
    <div id="msg" class="muted" style="margin-top:8px;"></div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h2>Pending Requests</h2>
    <table id="pendingTable">
        <thead><tr><th>Item / Vendor Pricing</th><th>Qty</th><th>Status</th><th>Notes</th></tr></thead>
        <tbody><tr><td colspan="4">Loading...</td></tr></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px;">
    <details>
        <summary style="font-size:1.5em;font-weight:bold;">View Order History</summary>
        <div class="toolbar" style="margin-top:12px;">
            <button class="btn" data-days="30">Last 30 Days</button>
            <button class="btn" data-days="60">Last 60 Days</button>
            <button class="btn" data-days="90">Last 90 Days</button>
            <input id="historySearch" placeholder="Search history..." style="width:auto;flex:1;">
        </div>
        <table id="historyTable">
            <thead><tr><th>Item</th><th>Received</th><th>Notes</th></tr></thead>
            <tbody><tr><td colspan="3">Select a date range to view history.</td></tr></tbody>
        </table>
    </details>
  </div>
</div>

<script>
/*** CONFIG ***/
const CSV_CATALOG   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=1603897332&single=true&output=csv';
const CSV_ORDERS    = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=708973021&single=true&output=csv';
const CSV_VENDORPR  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=1795212434&single=true&output=csv';
const WEBAPP_URL    = 'https://script.google.com/macros/s/AKfycbypxL0KxxXMVRieHHuvX98m9Jx6fYJWTdrMLQNkt99Sgt0vNzRDeyGiDz5fILlORP8wFQ/exec';
const TOKEN         = '9mB4zR7kP2fW6vNqE1jH8aLcV5gT_sYx0uI-oZ3pD9bX4wK7eS6hF-EMS';
/*** end config ***/

let catHead=[], catRows=[], orderHead=[], orderRows=[], vpHead=[], vpRows=[];
const idx = (h,name) => h.indexOf(name);

function parseCSV(text){
    const clean = (text||'').replace(/^\uFEFF/,'').trim();
    if (!clean) return [];
    return clean.split(/\r?\n/).map(line => {
        const m = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
        return m.map(s => s.replace(/^"|"$/g, ''));
    });
}

function renderPending(){
    const nameById = new Map(catRows.map(r => [r[idx(catHead,'ItemID')], {name: r[idx(catHead,'ItemName')], alt: r[idx(catHead,'ItemNameAlt')]}]));
    const pending = orderRows.filter(r => ['Requested', 'Ordered'].includes(r[idx(orderHead,'Status')]));
    
    const tbody = document.querySelector('#pendingTable tbody');
    tbody.innerHTML = pending.map(r => {
        const itemId = r[idx(orderHead,'ItemID')] || '';
        const orderId = r[idx(orderHead,'OrderID')] || '';
        let itemInfo = nameById.get(itemId);
        let itemName = itemInfo ? itemInfo.name : itemId;
        const itemAltName = itemInfo ? itemInfo.alt : '';
        const notes = r[idx(orderHead,'Notes')] || '';
        const currentStatus = r[idx(orderHead,'Status')] || '';

        if (notes.startsWith('REQUESTED OTHER ITEM:')) {
            itemName = `<em>${notes.replace('REQUESTED OTHER ITEM: ', '').split('--')[0]}</em>`;
        }

        const vendorPrices = vpRows.filter(vp => vp[idx(vpHead, 'ItemID')] === itemId).sort((a,b) => a[idx(vpHead,'UnitPrice')] - b[idx(vpHead,'UnitPrice')]);

        return `<tr>
            <td>
                <details>
                    <summary><strong>${itemName}</strong> <span class="muted">${itemAltName || ''}</span></summary>
                    <table class="vendor-table">
                        <thead><tr><th>Vendor</th><th>Price</th><th>Item#</th></tr></thead>
                        <tbody>
                            ${vendorPrices.map(vp => `<tr>
                                <td>${vp[idx(vpHead,'VendorID')]}</td>
                                <td>$${vp[idx(vpHead,'UnitPrice')]}</td>
                                <td>${vp[idx(vpHead,'VendorItemNumber')]}</td>
                            </tr>`).join('') || '<tr><td colspan="3">No pricing info</td></tr>'}
                        </tbody>
                    </table>
                </details>
            </td>
            <td>${r[idx(orderHead,'Qty')] || ''}</td>
            <td class="status-btns">
                <button class="btn ${currentStatus === 'Requested' ? 'active' : ''}" data-orderid="${orderId}" data-status="Requested">Pending</button>
                <button class="btn ${currentStatus === 'Ordered' ? 'active' : ''}" data-orderid="${orderId}" data-status="Ordered">Ordered</button>
                <button class="btn" data-orderid="${orderId}" data-status="Received">Received</button>
            </td>
            <td>${notes}</td>
        </tr>`;
    }).join('') || '<tr><td colspan="4">No pending requests.</td></tr>';
    
    tbody.querySelectorAll('.status-btns button').forEach(btn => {
        btn.addEventListener('click', async () => {
            const orderId = btn.dataset.orderid;
            const status = btn.dataset.status;
            await fetch(WEBAPP_URL, {method:'POST', mode:'no-cors', body: JSON.stringify({token: TOKEN, actionType: 'updateOrderStatus', orderId, status})});
            // Optimistic update
            const orderRow = orderRows.find(r => r[idx(orderHead,'OrderID')] === orderId);
            if (orderRow) orderRow[idx(orderHead,'Status')] = status;
            renderPending();
        });
    });
}

function renderHistory(days, query = '') {
    const nameById = new Map(catRows.map(r => [r[idx(catHead,'ItemID')], r[idx(catHead,'ItemName')]]));
    const received = orderRows.filter(r => r[idx(orderHead,'Status')] === 'Received');
    
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - days);

    const filtered = received.filter(r => {
        const ts = new Date(r[idx(orderHead,'Timestamp')]);
        const itemName = nameById.get(r[idx(orderHead,'ItemID')]) || '';
        return ts >= cutoff && (!query || itemName.toLowerCase().includes(query.toLowerCase()));
    });

    const tbody = document.querySelector('#historyTable tbody');
    tbody.innerHTML = filtered.map(r => `<tr>
        <td>${nameById.get(r[idx(orderHead,'ItemID')]) || 'Other'}</td>
        <td>${new Date(r[idx(orderHead,'Timestamp')]).toLocaleDateString()}</td>
        <td>${r[idx(orderHead,'Notes')] || ''}</td>
    </tr>`).join('') || `<tr><td colspan="3">No history in the last ${days} days.</td></tr>`;
}

async function boot() {
    const [catText, orderText, vpText] = await Promise.all([
        fetch(CSV_CATALOG).then(r=>r.text()),
        fetch(CSV_ORDERS).then(r=>r.text()),
        fetch(CSV_VENDORPR).then(r=>r.text())
    ]);

    const catAll = parseCSV(catText); catHead = catAll.shift() || []; catRows = catAll;
    const orderAll = parseCSV(orderText); orderHead = orderAll.shift() || []; orderRows = orderAll;
    const vpAll = parseCSV(vpText); vpHead = vpAll.shift() || []; vpRows = vpAll;
    
    document.getElementById('itemsDatalist').innerHTML = catRows.map(r => `<option value="${r[idx(catHead,'ItemName')]}">${r[idx(catHead,'ItemNameAlt')] || ''}</option>`).join('');
    
    renderPending();

    document.querySelectorAll('.toolbar button[data-days]').forEach(btn => btn.addEventListener('click', () => renderHistory(btn.dataset.days)));
    document.getElementById('historySearch').addEventListener('input', (e) => {
        const selectedDays = document.querySelector('.toolbar button.active')?.dataset.days || 30;
        renderHistory(selectedDays, e.target.value);
    });

    // ... (rest of boot function for request form)
}
boot();
</script>
</body>
</html>