<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Supply Request – GC EMS</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
  h1,h2{margin:0 0 8px}
  label{display:block;margin:10px 0 6px;font-weight:600}
  input,button,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
  button.btn{width:auto;padding:6px 10px;cursor:pointer}
  .muted{color:var(--muted);font-size:.9rem}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  .status-btns button{width:auto;margin-right:5px}
  .status-btns .active{background:#0275d8;color:#fff;border-color:#0275d8}
  .vendor-table{font-size:.9em;margin-top:8px;background:#fafafa}
  .vendor-table th,.vendor-table td{padding:4px}
  summary{cursor:pointer;font-weight:bold}
  .toolbar{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;align-items:center}
  .nav-links { float: right; font-size: 0.9rem; }
  .nav-links a { color: #007bff; text-decoration: none; margin-left: 1rem; }
</style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="expiry3.html">Expiring</a>
            <a href="master.html">Admin</a>
        </div>
        <h1>Supply Requests</h1>
    </div>

    <div class="card" style="margin-top:16px;">
        <h2>Pending Requests</h2>
        <table id="pendingTable">
          <thead><tr><th>Item / Vendor Pricing</th><th>Qty</th><th>Status</th><th>Notes</th></tr></thead>
          <tbody><tr><td colspan="4">Loading...</td></tr></tbody>
        </table>
    </div>

    <div class="card" style="margin-top:16px;">
      <details id="requestPane">
        <summary style="font-size:1.25em;font-weight:bold;">New Request</summary>
        <div style="margin-top:12px">
          <label for="itemSearch">Item from Catalog</label>
          <input id="itemSearch" list="itemsDatalist" placeholder="Search for an item...">
          <datalist id="itemsDatalist"></datalist>

          <div style="margin:8px 0;">
            <input type="checkbox" id="isOther" style="width:auto;">
            <label for="isOther" style="display:inline;font-weight:normal;">Or, request an item not in the list</label>
          </div>

          <input id="otherItem" placeholder="Enter unlisted item name..." style="display:none;">

          <label for="qty">Quantity (Optional)</label>
          <input id="qty" type="text" placeholder="e.g., 1 Box or 5 EA">

          <label for="notes">Notes (Optional)</label>
          <input id="notes" placeholder="e.g., For Unit 31">

          <button id="submitBtn" style="margin-top:12px;">Submit Request</button>
          <div id="msg" class="muted" style="margin-top:8px;"></div>
          </div>
         </details>
    </div>

    <div class="card" style="margin-top:16px;">
        <details id="historyPane">
          <summary style="font-size:1.5em;font-weight:bold;">View Order History</summary>
          <div class="toolbar">
            <button class="btn hist" data-days="30">Last 30 Days</button>
            <button class="btn hist" data-days="60">Last 60 Days</button>
            <button class="btn hist" data-days="90">Last 90 Days</button>
            <input id="historySearch" placeholder="Search history..." style="width:auto;flex:1;">
          </div>
          <table id="historyTable">
            <thead><tr><th>Item</th><th>Received</th><th>Notes</th></tr></thead>
            <tbody><tr><td colspan="3">Select a date range to view history.</td></tr></tbody>
          </table>
        </details>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, serverTimestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD7pMc-AHXb1cApzSfImkWvIjM9iwCoym4",
    authDomain: "supplies-ems.firebaseapp.com",
    projectId: "supplies-ems"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const state = {
    catalog: [],
    requests: [],
    vendorPricing: [],
    vendors: [],
    catalogMap: new Map(),
    vendorMap: new Map()
  };

  const $ = (sel) => document.querySelector(sel);
  const escapeHtml = (s = "") => String(s).replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
  const money = (v) => { const n = Number(v); return Number.isFinite(n) ? `$${n.toFixed(2)}` : "N/A"; };
  const toDate = (maybeTs) => {
    if (!maybeTs) return null;
    if (maybeTs.seconds) return new Date(maybeTs.seconds * 1000);
    const d = new Date(String(maybeTs));
    return isNaN(d) ? null : d;
  };

  let currentHistoryDays = 30;
  let currentHistoryQuery = "";

  async function loadAllData() {
    $('#pendingTable tbody').innerHTML = '<tr><td colspan="4">Loading…</td></tr>';
    try {
      const [catSnap, reqSnap, priceSnap, vendorSnap] = await Promise.all([
        getDocs(collection(db, "catalog")),
        getDocs(collection(db, "requests")),
        getDocs(collection(db, "vendorPricing")),
        getDocs(collection(db, "vendors"))
      ]);
      state.catalog = catSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
      state.requests = reqSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
      state.vendorPricing = priceSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
      state.vendors = vendorSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
      state.catalogMap = new Map(state.catalog.map((c) => [c.id, c]));
      state.vendorMap = new Map(state.vendors.map((v) => [v.id, v]));
      populateCatalogDatalist();
      renderPending();
      renderHistory(currentHistoryDays, currentHistoryQuery);
    } catch (err) {
      console.error("Failed to load Firestore data", err);
      $('#pendingTable tbody').innerHTML = '<tr><td colspan="4" style="color:#a00;font-weight:700;">Error: Could not load data. Please check Firestore security rules.</td></tr>';
    }
  }

  function populateCatalogDatalist() {
    const sorted = [...state.catalog].sort((a, b) => (a.itemName || "").localeCompare(b.itemName || ""));
    const options = [];
    sorted.forEach((item) => {
      const primary = item.itemName || "";
      const alt = item.itemNameAlt || "";
      if (primary) options.push(`<option value="${escapeHtml(primary)}"></option>`);
      if (alt && alt.toLowerCase() !== primary.toLowerCase()) {
        options.push(`<option value="${escapeHtml(alt)}"></option>`);
      }
    });
    $('#itemsDatalist').innerHTML = options.join("");
  }

  function formatRequestName(request) {
    const catalogItem = request.catalogId ? state.catalogMap.get(request.catalogId) : null;
    const primary = request.otherItemName || catalogItem?.itemName || catalogItem?.itemNameAlt || "Other Item";
    const alt = catalogItem?.itemNameAlt && catalogItem?.itemNameAlt !== primary ? catalogItem.itemNameAlt : "";
    return { primary, alt };
  }

  function renderPending() {
    const tbody = $('#pendingTable tbody');
    const pending = state.requests.filter((r) => !['received', 'fulfilled', 'complete', 'completed', 'closed'].includes(String(r.status || 'open').toLowerCase()));
    if (!pending.length) {
      tbody.innerHTML = '<tr><td colspan="4">No pending requests.</td></tr>';
      return;
    }
    tbody.innerHTML = pending.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).map((request) => {
      const { primary, alt } = formatRequestName(request);
      const pricing = (request.catalogId ? state.vendorPricing.filter((vp) => vp.catalogId === request.catalogId) : []).sort((a, b) => (parseFloat(a.unitPrice) || Infinity) - (parseFloat(b.unitPrice) || Infinity));
      const pricingHTML = pricing.length ? pricing.map(vp => `<tr><td>${escapeHtml(state.vendorMap.get(vp.vendorId)?.name || vp.vendorId || '')}</td><td>${money(vp.unitPrice)}</td><td>${escapeHtml(vp.vendorItemNo || '')}</td></tr>`).join("") : '<tr><td colspan="3">No pricing info</td></tr>';
      return `
        <tr>
          <td>
            <details>
              <summary>${escapeHtml(primary)} ${alt ? `<span class="muted">${escapeHtml(alt)}</span>` : ''}</summary>
              <table class="vendor-table">
                <thead><tr><th>Vendor</th><th>Price</th><th>Item#</th></tr></thead>
                <tbody>${pricingHTML}</tbody>
              </table>
            </details>
          </td>
          <td>${escapeHtml(request.qty || '')}</td>
          <td class="status-btns">
            <button class="btn ${String(request.status || 'open').toLowerCase() === 'open' ? 'active' : ''}" data-request-id="${request.id}" data-status="open">Pending</button>
            <button class="btn ${String(request.status || '').toLowerCase() === 'ordered' ? 'active' : ''}" data-request-id="${request.id}" data-status="ordered">Ordered</button>
            <button class="btn ${String(request.status || '').toLowerCase() === 'received' ? 'active' : ''}" data-request-id="${request.id}" data-status="received">Received</button>
          </td>
          <td>${escapeHtml(request.notes || '')}</td>
        </tr>`;
    }).join("");

    tbody.querySelectorAll('.status-btns button').forEach((btn) => {
      btn.addEventListener('click', async () => {
        alert("Status can only be changed from the Admin page.");
      });
    });
  }

  function renderHistory(days = 30, queryText = "") {
    currentHistoryDays = Number.isFinite(+days) ? +days : 30;
    currentHistoryQuery = queryText;
    const tbody = $('#historyTable tbody');
    const now = new Date();
    const cutoff = new Date(now.getTime() - currentHistoryDays * 24 * 60 * 60 * 1000);
    cutoff.setHours(0, 0, 0, 0);

    const received = state.requests.filter((r) => {
      const status = String(r.status || '').toLowerCase();
      if (!['received', 'fulfilled', 'complete', 'completed'].includes(status)) return false;
      const ts = toDate(r.receivedAt || r.updatedAt || r.createdAt);
      return ts && ts >= cutoff;
    });

    const filtered = received.filter((req) => {
      if (!queryText) return true;
      const { primary } = formatRequestName(req);
      const haystack = `${primary} ${req.notes || ''}`.toLowerCase();
      return haystack.includes(queryText.toLowerCase());
    });

    if (!filtered.length) {
      tbody.innerHTML = `<tr><td colspan="3">No history in the last ${currentHistoryDays} days.</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.sort((a, b) => (toDate(a.receivedAt || a.updatedAt || a.createdAt) || 0) - (toDate(b.receivedAt || b.updatedAt || b.createdAt) || 0)).map((req) => {
      const { primary } = formatRequestName(req);
      const ts = toDate(req.receivedAt || req.updatedAt || req.createdAt);
      return `
        <tr>
          <td>${escapeHtml(primary)}</td>
          <td>${ts ? ts.toLocaleDateString() : ''}</td>
          <td>${escapeHtml(req.notes || '')}</td>
        </tr>`;
    }).join("");
  }
  
  function setupForm() {
    $('#isOther').addEventListener('change', () => {
      const on = $('#isOther').checked;
      $('#itemSearch').style.display = on ? 'none' : 'block';
      $('#otherItem').style.display = on ? 'block' : 'none';
    });

    $('#submitBtn').addEventListener('click', async () => {
      const msg = $('#msg');
      msg.textContent = '';

      const onOther = $('#isOther').checked;
      const itemName = $('#itemSearch').value.trim();
      const otherName = $('#otherItem').value.trim();
      
      const data = {
        qty: $('#qty').value.trim() || '',
        notes: $('#notes').value.trim() || '',
        status: 'Open',
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        requesterEmail: 'Public Request'
      };

      if (onOther) {
        if (!otherName) { msg.textContent = 'Please enter the item name.'; return; }
        data.otherItemName = otherName;
        data.catalogId = null;
      } else {
        const catalogItem = state.catalog.find((item) => (item.itemName || '').toLowerCase() === itemName.toLowerCase() || (item.itemNameAlt || '').toLowerCase() === itemName.toLowerCase());
        if (!catalogItem) { msg.textContent = 'Please select a valid item from the list or choose "other".'; return; }
        data.catalogId = catalogItem.id;
      }

      msg.textContent = 'Submitting…';
      try {
        await addDoc(collection(db, 'requests'), data);
        msg.textContent = 'Request submitted successfully!';
        $('#itemSearch').value = '';
        $('#otherItem').value = '';
        $('#qty').value = '';
        $('#notes').value = '';
        await loadAllData();
      } catch (err) {
        console.error('Failed to submit request', err);
        msg.textContent = 'An error occurred submitting the request.';
      }
    });
  }

  function setupHistoryControls() {
    document.querySelectorAll('button.hist').forEach((btn) => {
      btn.addEventListener('click', () => {
        renderHistory(Number(btn.dataset.days) || 30, currentHistoryQuery);
      });
    });
    $('#historySearch').addEventListener('input', (e) => {
      renderHistory(currentHistoryDays, e.target.value);
    });
    $('#historyPane').addEventListener('toggle', (e) => {
      if (e.target.open) {
        renderHistory(currentHistoryDays, currentHistoryQuery);
      }
    });
  }

  async function boot() {
    await loadAllData();
    setupForm();
    setupHistoryControls();
  }
  
  boot();
</script>
</body>
</html>