<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Supply Request – GC EMS</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
  h1,h2{margin:0 0 8px}
  label{display:block;margin:10px 0 6px;font-weight:600}
  input,button,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
  button.btn{width:auto;padding:6px 10px;cursor:pointer}
  .btn.primary{background-color: #007bff;color: #fff;border-color: #007bff;font-weight: 600;}
  .muted{color:var(--muted);font-size:.9rem}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  .vendor-table{font-size:.9em;margin-top:8px;background:#fafafa}
  .vendor-table th,.vendor-table td{padding:4px}
  summary{cursor:pointer;font-weight:bold}
  .toolbar{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;align-items:center}
  .nav-links { float: right; font-size: 0.9rem; }
  .nav-links a { color: #007bff; text-decoration: none; margin-left: 1rem; }
  .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.4)}
  .modal-content{background-color:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:80%;max-width:500px;border-radius:12px}
  .modal-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:10px;border-bottom:1px solid #ddd;margin-bottom:1rem}
  .close-btn{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
  .close-btn:hover,.close-btn:focus{color:black;text-decoration:none;cursor:pointer}
  .status-open { background-color: #ffc107; color: #000; padding: 2px 5px; border-radius: 4px;}
  .status-backordered, .status-pending { background-color: #fd7e14; color: #fff; padding: 2px 5px; border-radius: 4px;}
  .status-ordered { background-color: #28a745; color: #fff; padding: 2px 5px; border-radius: 4px;}
</style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="expiry3.html">Expiring</a>
            <a href="master.html">Admin</a>
        </div>
        <h1>Supply Requests</h1>
    </div>

    <div class="card" style="margin-top:16px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Pending Requests</h2>
            <button id="showRequestModalBtn" class="btn primary">New Request</button>
        </div>
        <table id="pendingTable">
          <thead><tr><th>Item / Vendor Pricing</th><th>Qty</th><th>Status</th><th>Notes</th><th>Action</th></tr></thead>
          <tbody><tr><td colspan="5">Loading...</td></tr></tbody>
        </table>
    </div>

    <div class="card" style="margin-top:16px;">
        <details id="historyPane">
          <summary style="font-size:1.5em;font-weight:bold;">View Order History</summary>
          <div class="toolbar">
            <button class="btn hist active" data-days="30">Last 30 Days</button>
            <button class="btn hist" data-days="60">Last 60 Days</button>
            <button class="btn hist" data-days="90">Last 90 Days</button>
            <input id="historySearch" placeholder="Search history..." style="width:auto;flex:1;">
          </div>
          <table id="historyTable">
            <thead><tr><th>Item</th><th>Received</th><th>Notes</th></tr></thead>
            <tbody><tr><td colspan="3">Select a date range to view history.</td></tr></tbody>
          </table>
        </details>
    </div>
</div>

<div id="requestModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>New Supply Request</h2>
            <span class="close-btn">&times;</span>
        </div>
        <div class="modal-body">
            <label for="itemSearch">Item from Catalog</label>
            <select id="itemSearch" placeholder="Search for an item..."></select>

            <div style="margin:8px 0;">
                <input type="checkbox" id="isOther" style="width:auto;">
                <label for="isOther" style="display:inline;font-weight:normal;">Or, request an item not in the list</label>
            </div>

            <input id="otherItem" placeholder="Enter unlisted item name..." style="display:none;">

            <label for="qty">Quantity (Optional)</label>
            <input id="qty" type="text" placeholder="e.g., 1 Box or 5 EA">

            <label for="notes">Notes (Optional)</label>
            <input id="notes" placeholder="e.g., For Unit 31">

            <button id="submitBtn" class="btn primary" style="margin-top:12px; width: 100%;">Submit Request</button>
            <div id="msg" class="muted" style="margin-top:8px;"></div>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, serverTimestamp, updateDoc, doc, onSnapshot, initializeFirestore, persistentLocalCache } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD7pMc-AHXb1cApzSfImkWvIjM9iwCoym4",
    authDomain: "supplies-ems.firebaseapp.com",
    projectId: "supplies-ems"
  };
  const app = initializeApp(firebaseConfig);
  const db = initializeFirestore(app, {
      cache: persistentLocalCache({ synchronizeTabs: true })
  });

  const state = {
    catalog: [],
    requests: [],
    vendorPricing: [],
    vendors: [],
    catalogMap: new Map(),
    vendorMap: new Map()
  };
  
  let itemSelectChoices; 

  const $ = (sel) => document.querySelector(sel);
  const escapeHtml = (s = "") => String(s).replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
  const money = (v) => { const n = Number(v); return Number.isFinite(n) ? `$${n.toFixed(2)}` : "N/A"; };
  const toDate = (maybeTs) => {
    if (!maybeTs) return null;
    if (maybeTs.seconds) return new Date(maybeTs.seconds * 1000);
    const d = new Date(String(maybeTs));
    return isNaN(d) ? null : d;
  };

  let currentHistoryDays = 30;
  let currentHistoryQuery = "";

  async function initializeStaticData() {
    try {
      const [catSnap, priceSnap, vendorSnap] = await Promise.all([
        getDocs(collection(db, "catalog")),
        getDocs(collection(db, "vendorPricing")),
        getDocs(collection(db, "vendors"))
      ]);
      state.catalog = catSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
      state.vendorPricing = priceSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
      state.vendors = vendorSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
      state.catalogMap = new Map(state.catalog.map((c) => [c.id, c]));
      state.vendorMap = new Map(state.vendors.map((v) => [v.id, v.name]));
      
      populateChoices();
    } catch (err) {
      console.error("Failed to load static data", err);
      $('#pendingTable tbody').innerHTML = '<tr><td colspan="5" style="color:#a00;font-weight:700;">Error: Could not load data. Check security rules.</td></tr>';
    }
  }
  
  function setupRequestsListener() {
      onSnapshot(collection(db, "requests"), (reqSnap) => {
          state.requests = reqSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
          renderPending();
          renderHistory();
      }, (error) => {
          console.error("Error with requests listener: ", error);
          $('#pendingTable tbody').innerHTML = '<tr><td colspan="5" style="color:#a00;font-weight:700;">Error listening to requests.</td></tr>';
      });
  }

  function populateChoices() {
    const itemElement = document.getElementById('itemSearch');
    if (itemSelectChoices) {
        itemSelectChoices.destroy();
    }
    itemSelectChoices = new Choices(itemElement, {
        searchEnabled: true,
        placeholderValue: 'Search for an item...',
        allowHTML: false,
    });
    
    const options = state.catalog
        .filter(c => c.isActive !== false)
        .sort((a,b) => (a.itemName || "").localeCompare(b.itemName || ""))
        .map(item => ({ value: item.id, label: item.itemName }));
    itemSelectChoices.setChoices(options, 'value', 'label', true);
  }

  function formatRequestName(request) {
    const itemId = request.catalogId || request.ItemID;
    const catalogItem = itemId ? state.catalogMap.get(itemId) : null;
    const primary = request.otherItemName || catalogItem?.itemName || "Unknown Item";
    const alt = catalogItem?.itemNameAlt && catalogItem?.itemNameAlt !== primary ? catalogItem.itemNameAlt : "";
    return { primary, alt };
  }

  function renderPending() {
    const tbody = $('#pendingTable tbody');
    const pending = state.requests.filter((r) => !['received', 'fulfilled', 'complete', 'completed', 'closed'].includes(String(r.status || 'open').toLowerCase()));
    if (!pending.length) {
      tbody.innerHTML = '<tr><td colspan="5">No pending requests.</td></tr>';
      return;
    }
    const sortOrder = { "Open": 1, "Backordered": 2, "Pending": 2, "Ordered": 3 };
    tbody.innerHTML = pending.sort((a, b) => {
        const aStatus = a.status || "Open";
        const bStatus = b.status || "Open";
        return (sortOrder[aStatus] || 99) - (sortOrder[bStatus] || 99) || (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)
    }).map((request) => {
        const { primary, alt } = formatRequestName(request);
        const itemId = request.catalogId || request.ItemID;
        const pricing = (itemId ? state.vendorPricing.filter((vp) => vp.catalogId === itemId) : []).sort((a, b) => (parseFloat(a.unitPrice) || Infinity) - (parseFloat(b.unitPrice) || Infinity));
        const pricingHTML = pricing.length ? pricing.map(vp => `<tr><td>${escapeHtml(state.vendorMap.get(vp.vendorId)?.name || vp.vendorId || '')}</td><td>${money(vp.unitPrice)}</td><td>${escapeHtml(vp.vendorItemNo || '')}</td></tr>`).join("") : '<tr><td colspan="3">No pricing info</td></tr>';
        const status = escapeHtml(request.status || 'Requested');
        return `
          <tr data-request-id="${request.id}">
            <td><details><summary>${escapeHtml(primary)} ${alt ? `<span class="muted">${escapeHtml(alt)}</span>` : ''}</summary><table class="vendor-table"><thead><tr><th>Vendor</th><th>Price</th><th>Item#</th></tr></thead><tbody>${pricingHTML}</tbody></table></details></td>
            <td>${escapeHtml(request.qty || '')}</td>
            <td><strong class="status-${status.toLowerCase()}">${status}</strong></td>
            <td class="notes" data-note="${escapeHtml(request.notes || '')}">${escapeHtml(request.notes || '')}</td>
            <td><button class="btn" data-receive-id="${request.id}">Mark Received</button></td>
          </tr>`;
    }).join("");

    tbody.querySelectorAll('[data-receive-id]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const requestId = btn.dataset.receiveId;
        if (!requestId) return;
        btn.disabled = true;
        btn.textContent = 'Saving...';
        try {
            await updateDoc(doc(db, "requests", requestId), { 
                status: 'Received',
                receivedAt: serverTimestamp()
            });
        } catch(e) {
            console.error("Failed to mark as received:", e);
            alert("Error: Could not update status. You may not have permission.");
            btn.disabled = false;
            btn.textContent = 'Mark Received';
        }
      });
    });

    tbody.querySelectorAll('.notes').forEach((noteCell) => {
        noteCell.addEventListener('click', (e) => {
            const currentCell = e.target;
            const originalNote = currentCell.dataset.note;
            const requestId = currentCell.parentElement.dataset.requestId;

            currentCell.innerHTML = `
                <input type="text" value="${originalNote}" style="width: 100%;">
                <button class="btn save-note">Save</button>
                <button class="btn cancel-note">Cancel</button>
            `;

            currentCell.querySelector('.save-note').addEventListener('click', async () => {
                const newNote = currentCell.querySelector('input').value;
                await updateDoc(doc(db, "requests", requestId), { notes: newNote });
                currentCell.innerHTML = escapeHtml(newNote);
                currentCell.dataset.note = newNote;
            });

            currentCell.querySelector('.cancel-note').addEventListener('click', () => {
                currentCell.innerHTML = escapeHtml(originalNote);
            });
        }, { once: true });
    });
  }

  function renderHistory(days = 30, queryText = "") {
    currentHistoryDays = Number.isFinite(+days) ? +days : 30;
    currentHistoryQuery = queryText;
    const tbody = $('#historyTable tbody');
    const now = new Date();
    const cutoff = new Date(now.getTime() - currentHistoryDays * 24 * 60 * 60 * 1000);
    const received = state.requests.filter((r) => {
        const status = String(r.status || '').toLowerCase();
        if (!['received', 'completed'].includes(status)) return false;
        const ts = toDate(r.receivedAt || r.updatedAt || r.createdAt);
        return ts && ts >= cutoff;
    });
    const filtered = received.filter((req) => {
        if (!queryText) return true;
        const { primary } = formatRequestName(req);
        return `${primary} ${req.notes || ''}`.toLowerCase().includes(queryText.toLowerCase());
    });
    if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="3">No history in the last ${currentHistoryDays} days.</td></tr>`;
        return;
    }
    tbody.innerHTML = filtered.sort((a, b) => (toDate(b.receivedAt || b.updatedAt) || 0) - (toDate(a.receivedAt || a.updatedAt) || 0)).map((req) => {
        const { primary } = formatRequestName(req);
        const ts = toDate(req.receivedAt || req.updatedAt || req.createdAt);
        return `<tr><td>${escapeHtml(primary)}</td><td>${ts ? ts.toLocaleDateString() : ''}</td><td>${escapeHtml(req.notes || '')}</td></tr>`;
    }).join("");
  }
  
  function setupForm() {
    $('#isOther').addEventListener('change', () => {
        const on = $('#isOther').checked;
        const choicesEl = document.querySelector('#requestModal .choices');
        if(choicesEl) choicesEl.style.display = on ? 'none' : 'block';
        $('#otherItem').style.display = on ? 'block' : 'none';
        if(itemSelectChoices) itemSelectChoices.clearInput();
        $('#otherItem').value = '';
    });

    $('#submitBtn').addEventListener('click', async () => {
        const msg = $('#msg');
        const onOther = $('#isOther').checked;
        const otherName = $('#otherItem').value.trim();
        const catalogId = itemSelectChoices.getValue(true);
        
        const data = {
            qty: $('#qty').value.trim() || '',
            notes: $('#notes').value.trim() || '',
            status: 'Open',
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            requesterEmail: 'Public Request'
        };

        if (onOther) {
            if (!otherName) { msg.textContent = 'Please enter the item name.'; return; }
            data.otherItemName = otherName;
            data.catalogId = null;
        } else {
            if (!catalogId) { msg.textContent = 'Please select a valid item from the list.'; return; }
            data.catalogId = catalogId;
        }

        msg.textContent = 'Submitting…';
        try {
            await addDoc(collection(db, 'requests'), data);
            msg.textContent = 'Request submitted successfully!';
            if(itemSelectChoices) itemSelectChoices.clearInput();
            $('#otherItem').value = '';
            $('#qty').value = '';
            $('#notes').value = '';
            $('#requestModal').style.display = "none";
        } catch (err) {
            console.error('Failed to submit request', err);
            msg.textContent = 'An error occurred submitting the request.';
        }
    });
  }

  function setupHistoryControls() {
    document.querySelectorAll('button.hist').forEach((btn) => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('button.hist').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderHistory(Number(btn.dataset.days) || 30, currentHistoryQuery);
        });
    });
    $('#historySearch').addEventListener('input', (e) => {
        renderHistory(currentHistoryDays, e.target.value);
    });
    $('#historyPane').addEventListener('toggle', (e) => {
        if (e.target.open) {
            renderHistory(currentHistoryDays, currentHistoryQuery);
        }
    });
  }
  
  function setupRequestModal() {
    const modal = $('#requestModal');
    const btn = $('#showRequestModalBtn');
    const span = modal.querySelector('.close-btn');

    btn.onclick = function() {
      modal.style.display = "block";
    }
    span.onclick = function() {
      modal.style.display = "none";
    }
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }
  }

  async function boot() {
    await initializeStaticData();
    setupRequestsListener();
    setupForm();
    setupHistoryControls();
    setupRequestModal();
  }
  
  boot();
</script>
</body>
</html>