<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EMS Supply Update</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f7f7}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
  h1{margin:0 0 12px}
  label{display:block;margin:10px 0 6px;font-weight:600}
  input,select,button,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .chip{padding:6px 10px;border:1px solid #ddd;border-radius:999px;background:#fafafa;cursor:pointer}
  .ok{color:green} .err{color:#b00020}
  .muted{color:#666;font-size:.9rem}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Supply Replace / Move</h1>
    <div class="muted">Pick the exact row (Unit × Item × Compartment × Lot), set Qty/Expiry, and submit.</div>

    <div class="row">
      <div>
        <label for="item">Item (search)</label>
        <input id="item" list="items" placeholder="Start typing..." autocomplete="off">
        <datalist id="items"></datalist>
      </div>
      <div>
        <label for="unit">Unit</label>
        <select id="unit"></select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="compartment">Compartment</label>
        <input id="compartment" list="comps" placeholder="Airway drawer, Drug box...">
        <datalist id="comps"></datalist>
      </div>
      <div>
        <label for="lot">Lot</label>
        <select id="lot"></select>
      </div>
    </div>

    <h3>Matching rows</h3>
    <table id="matches"><thead>
      <tr><th>Pick</th><th>Item</th><th>Unit</th><th>Compartment</th><th>Lot</th><th>Qty</th><th>Expiry</th></tr>
    </thead><tbody></tbody></table>

    <div class="row" style="margin-top:12px">
      <div>
        <label for="qty">Quantity (now)</label>
        <input id="qty" type="number" min="0" step="1" placeholder="e.g., 2">
      </div>
      <div>
        <label for="expiry">Expiry (stored)</label>
        <input id="expiry" type="date" />
        <div class="chips" id="quick-expiry" style="margin-top:6px"></div>
        <div class="muted">Quick buttons show “Sep-25 / Oct-25 / Nov-25” but store the first day of the following month, e.g., 2025‑10‑01.</div>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="action">Action</label>
        <select id="action">
          <option>Replaced</option>
          <option>Moved</option>
          <option>Out of service</option>
          <option>Update</option>
        </select>
      </div>
      <div>
        <label for="notes">Notes</label>
        <input id="notes" placeholder="Brief note..." />
      </div>
    </div>

    <input type="hidden" id="row">

    <div style="margin-top:12px">
      <button id="submit">Submit</button>
      <span id="msg" style="margin-left:10px"></span>
    </div>
  </div>
</div>

<script>
/*** CONFIG: replace these three constants ***/
const CSV_INVENTORY = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=0&single=true&output=csv';
const CSV_CATALOG   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsY8xyyVE4V7e39KHEB5Y5fg64JGK7Aslg6s7dF8-QfpM8myyR1henDuhzyorR8pjPjcj5aJJY9Q3T/pub?gid=1603897332&single=true&output=csv';
const WEBAPP_URL    = 'https://script.google.com/macros/s/AKfycbypxL0KxxXMVRieHHuvX98m9Jx6fYJWTdrMLQNkt99Sgt0vNzRDeyGiDz5fILlORP8wFQ/exec';
const TOKEN         = '9mB4zR7kP2fW6vNqE1jH8aLcV5gT_sYx0uI-oZ3pD9bX4wK7eS6hF-EMS';
const UNITS = ["31","36","37","33","35","38","39","847","Fire Command","Fire Trucks"];

/*** CSV + helpers ***/
let head=[], data=[];
const idx = n => head.indexOf(n);
function parseCSV(text){
  return text.trim().split(/\r?\n/).map(line=>{
    const m = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
    return m.map(s=>s.replace(/^"|"$/g,''));
  });
}
function uniqueSorted(a){ return [...new Set(a.filter(Boolean))].sort((x,y)=>x.localeCompare(y)); }

function monthLabel(d){ return d.toLocaleString('en-US',{month:'short'}) + '-' + String(d.getFullYear()).slice(-2); }
function firstOfNextMonth(y,m){ return new Date(Date.UTC(y,m+1,1)).toISOString().slice(0,10); }
function buildQuickExpiryButtons(){
  const today = new Date();
  const baseY = today.getUTCFullYear();
  const baseM = today.getUTCMonth();
  const buttons = [];
  for (let k=0; k<3; k++) {
    const labelDate = new Date(Date.UTC(baseY, baseM+k, 1));
    const label = monthLabel(labelDate);      // e.g., "Sep-25"
    const store = firstOfNextMonth(labelDate.getUTCFullYear(), labelDate.getUTCMonth()); // yyyy-mm-01 next month
    buttons.push({label, store});
  }
  const wrap = document.getElementById('quick-expiry');
  wrap.innerHTML = buttons.map(b=>`<button type="button" class="chip" data-date="${b.store}">${b.label}</button>`).join(' ')
    + ' <button type="button" class="chip other">Other…</button>';
  wrap.querySelectorAll('button.chip').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if (btn.classList.contains('other')) { document.getElementById('expiry').showPicker?.(); return; }
      document.getElementById('expiry').value = btn.dataset.date;
    });
  });
}

/*** UI wiring ***/
function renderLists(){
  const items = uniqueSorted(data.map(r=>r[idx('ItemName')]));
  const comps = uniqueSorted(data.map(r=>r[idx('Compartment')]));
  document.getElementById('items').innerHTML = items.map(v=>`<option value="${v}">`).join('');
  document.getElementById('comps').innerHTML = comps.map(v=>`<option value="${v}">`).join('');
  document.getElementById('unit').innerHTML = [''].concat(UNITS).map(u=>`<option value="${u}">${u||'-- any --'}</option>`).join('');
}

function searchMatches(){
  const item = (document.getElementById('item').value||'').toLowerCase();
  const unit = (document.getElementById('unit').value||'').toLowerCase();
  const comp = (document.getElementById('compartment').value||'').toLowerCase();
  let rows = data.filter(r=>{
    const i=(r[idx('ItemName')]||'').toLowerCase();
    const u=(r[idx('Unit')]||'').toLowerCase();
    const c=(r[idx('Compartment')]||'').toLowerCase();
    return (!item || i.includes(item)) && (!unit || u===unit) && (!comp || c.includes(comp));
  });
  // Lots dropdown
  const lots = uniqueSorted(rows.map(r=>r[idx('Lot')]));
  document.getElementById('lot').innerHTML = lots.map(v=>`<option value="${v}">${v}</option>`).join('');

  // table
  const tbody = document.querySelector('#matches tbody');
  tbody.innerHTML = rows.slice(0,150).map((r,i)=>{
    const rowNum = r[idx('RowNumber')] || (data.indexOf(r)+2);
    return `<tr>
      <td><input type="radio" name="pick" value="${rowNum}" ${i===0?'checked':''} onclick="document.getElementById('row').value='${rowNum}'"></td>
      <td>${r[idx('ItemName')]||''}</td>
      <td>${r[idx('Unit')]||''}</td>
      <td>${r[idx('Compartment')]||''}</td>
      <td>${r[idx('Lot')]||''}</td>
      <td>${r[idx('Qty')]||''}</td>
      <td>${r[idx('Expiry')]||''}</td>
    </tr>`;
  }).join('') || '<tr><td colspan="7">No matches</td></tr>';

  if (rows.length) document.getElementById('row').value = rows[0][idx('RowNumber')] || (data.indexOf(rows[0])+2);
}

document.getElementById('item').addEventListener('input', searchMatches);
document.getElementById('unit').addEventListener('change', searchMatches);
document.getElementById('compartment').addEventListener('input', searchMatches);

document.getElementById('submit').addEventListener('click', async ()=>{
  const payload = {
    token: TOKEN,
    actionType: 'updateInventory',
    row: Number(document.getElementById('row').value||0),
    qty: document.getElementById('qty').value,
    expiry: document.getElementById('expiry').value,
    action: document.getElementById('action').value,
    notes: document.getElementById('notes').value
  };
  const msg = document.getElementById('msg');
  msg.textContent = 'Submitting…';
  try {
    await fetch(WEBAPP_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(payload) });
    msg.innerHTML = '<span class="ok">Submitted ✔</span>';
    document.getElementById('qty').value = '';
    document.getElementById('notes').value = '';
  } catch(e){
    msg.innerHTML = '<span class="err">Submit failed</span>';
  }
});

function boot(){
  buildQuickExpiryButtons();
  Promise.all([fetch(CSV_INVENTORY).then(r=>r.text()), fetch(CSV_CATALOG).then(r=>r.text())])
    .then(([inv,catalog])=>{
      const rows = parseCSV(inv);
      head = rows.shift();
      // Ensure RowNumber column exists
      if (!head.includes('RowNumber')) { head.push('RowNumber'); }
      data = rows.map((r,i)=> (r.length=head.length-1, r.push(String(i+2)), r)); // add row number if missing
      renderLists();
      searchMatches();
      // Pre-filters via ?unit= & ?item=
      const params = new URLSearchParams(location.search);
      const pfItem = params.get('item'); if (pfItem) document.getElementById('item').value = pfItem;
      const pfUnit = params.get('unit'); if (pfUnit) document.getElementById('unit').value = pfUnit;
      searchMatches();
    });
}
boot();
</script>
</body>
</html>
