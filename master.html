<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>EMS Supplies â€” Admin Dashboard</title>
  <script src="https://kwelch2.github.io/Inventory/quagga.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50' font-size='50'%3EðŸš‘%3C/text%3E%3C/svg%3E">
  <style>
    :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666;--ink:#111;--accent:#0a66ff;--bad:#b00020;--ok:#137333}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    #auth-container { display: flex; flex-direction: column; gap: 10px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px; max-width: 400px; }
    #app-container { display: none; }
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--b);position:sticky;top:0;background:var(--bg);padding-bottom:8px;z-index:5}
    .tab{padding:10px 14px;border:1px solid var(--b);border-bottom:none;border-top-left-radius:10px;border-top-right-radius:10px;background:#eee;color:#333;cursor:pointer}
    .tab.active{background:var(--card);color:#000;border-bottom:1px solid var(--card)}
    .panel{display:none;background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;margin-top:-1px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .panel.active{display:block}
    h1,h2{margin:0 0 10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 10px;border:1px solid var(--b);border-radius:10px;background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-top:1px solid var(--b);text-align:left;vertical-align:top}
    th{background:#fafafa}
    input,select{padding:8px;border:1px solid var(--b);border-radius:8px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>EMS Supplies â€” Admin Dashboard</h1>

  <div id="auth-container">
    <h2>Login</h2>
    <button id="googleLoginBtn" class="btn primary">Sign in with Google</button>
    <button id="logoutBtn" class="btn" style="display: none;">Logout</button>
    <p id="auth-status" class="muted">Please sign in to continue.</p>
  </div>

  <div id="app-container">
    <div class="tabs" id="tabs"></div>
      <section id="panel-catalog" class="panel">
      <h2>Catalog Manager <span class="kvd" id="kvCatalog"></span></h2>
      <div class="row">
        <input id="catName" placeholder="Item name"/>
        <input id="catCategory" placeholder="Category"/>
        <button class="btn primary" id="catAddBtn">Add / Upsert</button>
        <div style="display:flex; gap: 8px; align-items:center;">
          <input id="catSearch" placeholder="Search itemsâ€¦" style="min-width:240px"/>
        </div>
      </div>
      <div id="catalogTable" style="margin-top:10px"></div>
    </section>

    <section id="panel-pricing" class="panel">
      <h2>Vendor Pricing <span class="kvd" id="kvPricing"></span></h2>
      <div id="pricingTable"></div>
    </section>

    <section id="panel-planner" class="panel">
      <h2>Order Planner <span class="kvd" id="kvPlan"></span></h2>
      <div id="planTable"></div>
    </section>

    <section id="panel-orders" class="panel">
      <h2>Orders <span class="kvd" id="kvOrders"></span></h2>
      <div id="ordersTable"></div>
    </section>

    <section id="panel-log" class="panel">
      <h2>Activity Log <span class="kvd" id="kvLog"></span></h2>
      <div id="logTable"></div>
    </section>
  </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        signOut,
        GoogleAuthProvider,
        signInWithRedirect,
        getRedirectResult
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD7pMc-AHXb1cApzSfImkWvIjM9iwCoym4",
        authDomain: "supplies-ems.firebaseapp.com",
        projectId: "supplies-ems",
        storageBucket: "supplies-ems.firebasestorage.app",
        messagingSenderId: "649560661195",
        appId: "1:649560661195:web:f389f3e620c0c36559cf4e",
        measurementId: "G-EN8MDYD571"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const state = { user: null, userRole: null, catalog: [], vendors: [], pricingAll: [], orders: [] };
    const $ = id => document.getElementById(id);

    // --- AUTHENTICATION & ROLE CHECKING ---
    async function checkUserRole(user) {
        if (user) {
            $("auth-status").textContent = "Verifying role...";
            try {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    state.userRole = userDocSnap.data().role;
                } else {
                    await setDoc(userDocRef, { email: user.email, role: "User" });
                    state.userRole = "User";
                }

                $("auth-status").textContent = `Logged in as ${user.email} (${state.userRole})`;
                $("app-container").style.display = "block";
                $("logoutBtn").style.display = "block";
                $("googleLoginBtn").style.display = "none";
                
                boot(); // Initialize the main application
            } catch (error) {
                console.error("Error checking user role:", error);
                $("auth-status").textContent = "Error: Could not verify user role.";
            }
        } else {
            state.userRole = null;
            $("auth-status").textContent = "Logged out.";
            $("app-container").style.display = "none";
            $("logoutBtn").style.display = "none";
            $("googleLoginBtn").style.display = "block";
        }
    }

    getRedirectResult(auth).then((result) => {
        if (result) checkUserRole(result.user);
    }).catch((error) => console.error("Redirect Error:", error));

    onAuthStateChanged(auth, (user) => {
        if (!auth.currentUser && !state.user) { // Prevent double-runs on redirect
             checkUserRole(user);
        }
    });

    $("googleLoginBtn").addEventListener("click", () => {
        signInWithRedirect(auth, new GoogleAuthProvider());
    });

    $("logoutBtn").addEventListener("click", () => signOut(auth));


    // --- APPLICATION LOGIC ---

    async function loadAllData() {
        const [catalogSnap, vendorsSnap, pricingSnap, ordersSnap] = await Promise.all([
            getDocs(collection(db, "catalog")),
            getDocs(collection(db, "vendors")),
            getDocs(collection(db, "vendorPricing")),
            getDocs(collection(db, "Orders"))
        ]);
        state.catalog = catalogSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        state.vendors = vendorsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        state.pricingAll = pricingSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        state.orders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    function renderCatalog() {
        const list = state.catalog;
        $('kvCatalog').textContent = `(${list.length})`;
        const rows = list.map(i => `
            <tr>
                <td>${i.name || ''}</td>
                <td>${(i.altNames || []).join(', ')}</td>
                <td>${i.category || ''}</td>
                <td><button class="btn" data-edit="${i.id}">Edit</button></td>
            </tr>`).join('');
        $('catalogTable').innerHTML = `<table><thead><tr><th>Name</th><th>Alt Names</th><th>Category</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderAll() {
        renderCatalog();
        // Add other render functions here as you build them out
        // renderPricing();
        // renderOrders();
    }
    
    function mountTabs() {
      const tabs = [
        { id:'catalog', label:'Catalog' }, { id:'pricing', label:'Pricing' },
        { id:'planner', label:'Planner' }, { id:'orders',  label:'Orders' },
        { id:'log', label:'Log' }
      ];
      const el = $('tabs');
      el.innerHTML = tabs.map((t,i) => `<button class="tab ${i===0?'active':''}" data-tab="${t.id}">${t.label}</button>`).join('');
      el.addEventListener('click', (ev) => {
        const btn = ev.target.closest('.tab');
        if(!btn) return;
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        $(`panel-${btn.dataset.tab}`).classList.add('active');
      });
    }

    async function boot() {
        mountTabs();
        await loadAllData();
        renderAll();
    }

</script>
</body>
</html>