<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>EMS Supplies — Master Admin Dashboard</title>
  <script src="https://kwelch2.github.io/Inventory/quagga.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666;--ink:#111;--accent:#0a66ff;--bad:#b00020;--ok:#137333; --ok-light: #e7f7ee;}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1400px;margin:0 auto;padding:16px}
    #login-container { max-width: 400px; margin: 2rem auto; }
    #app-container, #loading-container { display: none; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;}
    .auth-info { display: flex; align-items: center; gap: 1rem; }
    .nav-links { font-size: 0.9rem; }
    .nav-links a { color: #007bff; text-decoration: none; margin-left: 1rem; }
    .tabs{display:flex; flex-wrap: wrap; gap:8px;border-bottom:1px solid var(--b);position:sticky;top:0;background:var(--bg);padding:8px 0;z-index:5}
    .tab{padding:10px 14px;border:1px solid var(--b);border-bottom:none;border-radius:8px 8px 0 0;background:#eee;color:#333;cursor:pointer}
    .tab.active{background:var(--card);color:#000;border-bottom:1px solid var(--card)}
    .panel{display:none;background:var(--card);border:1px solid var(--b);border-radius:0 12px 12px 12px;padding:16px;margin-top:-1px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .panel.active{display:block}
    h1,h2,h3{margin:0 0 10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap; margin-bottom: 1rem;}
    .btn{padding:8px 10px;border:1px solid var(--b);border-radius:10px;background:#fff;cursor:pointer; font-size: 0.9rem;}
    .btn:disabled { background: #eee; cursor: not-allowed; }
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.danger{background:var(--bad); color: white; border-color: var(--bad);}
    .btn.ok { background-color: var(--ok-light); border-color: var(--ok); color: var(--ok); }
    .btn-small { padding: 4px 8px; font-size: 0.8rem; }
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-top:1px solid var(--b);text-align:left;vertical-align:top}
    th{background:#fafafa}
    tr.catalog-row:hover { background-color: #f9f9f9; }
    input,select{padding:8px;border:1px solid var(--b);border-radius:8px; font-size: 1rem; background: #fff;}
    .kvd{font-size:12px;color:#555}
    /* Stack modals correctly */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center;}
    #pricingModal { z-index: 1010; } 
    #changeVendorModal { z-index: 1010; }
    
    .modal-content { background-color: #fefefe; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 12px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .modal-body { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
    .modal-footer { margin-top: 1.5rem; text-align: right; }
    .list-item { display: flex; justify-content: space-between; align-items: center; background: #f0f0f0; padding: 4px 8px; border-radius: 6px; margin-bottom: 4px; }
    .viewport { position: relative; }
    .viewport video, .viewport .drawingBuffer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .price-info { font-size: 0.8rem; color: #555; }
    .price-tag { display: block; white-space: nowrap; margin-bottom: 2px; font-size: 0.9rem; }
    .price-tag.best-price { font-weight: bold; color: var(--ok); }
    .price-tag.preferred-price { font-weight: bold; color: var(--accent); }
    .details-row { display: none; }
    .details-row.visible { display: table-row; background-color: #f9f9f9 !important; }
    .details-cell { padding: 1rem; }
    .details-cell h4 { margin: 0 0 8px; }
    .details-cell .price-table { font-size: 0.9rem; margin-bottom: 1rem; }
    .details-cell .price-table th, .details-cell .price-table td { padding: 4px 6px; }
    .status-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
    .edit-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
    .btn-status.active { background-color: var(--accent); color: #fff; font-weight: bold; border-color: #005fa3; }
    .btn-status-receive { background-color: #f0fff0; border-color: #c0f0c0; }
    .btn-status-receive:hover { background-color: #dffde0; }
    .vendor-group { margin-bottom: 1.5rem; border: 1px solid var(--b); border-radius: 12px; background: var(--card); }
    .vendor-group-header { background: #fafafa; padding: 12px 16px; border-bottom: 1px solid var(--b); display: flex; justify-content: space-between; align-items: center; border-radius: 12px 12px 0 0;}
    .vendor-group-header h3 { margin: 0; }
    .vendor-group-table { margin: 0; }
    .vendor-group-table tr:last-child td { border-bottom: none; }
    .vendor-group-table .details-row td { border-top: 1px dashed var(--b); }
    .close-btn { font-size: 28px; font-weight: bold; cursor: pointer; color: #888; }
    .close-btn:hover { color: #000; }
    
    .view-toggle-wrap .btn { border-radius: 0; border-right-width: 0; }
    .view-toggle-wrap .btn:first-child { border-radius: 10px 0 0 10px; }
    .view-toggle-wrap .btn:last-child { border-radius: 0 10px 10px 0; border-right-width: 1px; }
    .view-toggle-wrap .btn.active { background: var(--accent); color: white; }
    
    .quick-qty-edit {
        transition: background-color 0.2s, border-color 0.2s;
    }
    .quick-qty-edit.success { 
        background-color: var(--ok-light); 
        border-color: var(--ok); 
    }
    .quick-qty-edit.error {
        background-color: #fdecea;
        border-color: var(--bad);
    }
    
    #printOrderModal table { font-size: 12px; }
    #printOrderModal th, #printOrderModal td { padding: 6px 8px; border: 1px solid #ccc; }
    @media print {
      body, .modal-content { margin: 0; padding: 0; box-shadow: none; border: none; }
      .modal-header button, .modal-footer { display: none; }
      #printOrderModal { display: block !important; position: static; width: 100%; height: auto; overflow: visible; background: #fff; }
    }
  </style>
</head>
<body>
<div class="wrap">
  
  <div id="loading-container" style="text-align: center; margin-top: 3rem;">
      <p class="muted">Initializing...</p>
  </div>

  <div id="login-container" style="display: none;">
    <div class="card">
        <h2>Admin Login</h2>
        <button id="googleLoginBtn" class="btn primary" style="width: 100%;">Sign in with Google</button>
        <p id="auth-status-login" class="muted" style="text-align: center; margin-top: 1rem;">Please sign in with a gemfireems.org account.</p>
    </div>
  </div>

  <div id="app-container" style="display: none;">
    <div classs="header">
        <h1>EMS Supplies — Master Admin</h1>
        <div class="nav-links">
            <a href="https://supplies-ems.web.app/">Home</a>
            <a href="requests.html">Supply Requests</a>
            <a href="expiry.html">Expiring</a>
            <a href="https://chores-ems.gemfireems.org/">Chores</a>
            <a href="https://chores-ems.gemfireems.org/issues">Issues</a>
        </div>
    </div>
    <div class="auth-info" style="margin-bottom: 1rem;">
        <span id="auth-status-main" class="muted"></span>
        <button id="logoutBtn" class="btn">Logout</button>
    </div>
    <div class="tabs" id="tabs"></div>

      <section id="panel-orders" class="panel">
        <h2>Orders & Requests</h2>
        <div class="row">
            <button class="btn primary" id="showAddItemModal">+ Add Item to Order</button>
            <span class="spacer" style="flex: 1;"></span>
            <div class="view-toggle-wrap" style="margin-left: 1rem;">
                <button class="btn view-btn active" data-view="vendor">View by Vendor</button>
                <button class="btn view-btn" data-view="item">View by Item</button>
            </div>
            <strong style="margin-left: 2rem;">Filter by Status:</strong>
            <button class="btn filter-btn active" data-status="All">All Active</button>
            <button class="btn filter-btn" data-status="Open">Open</button>
            <button class="btn filter-btn" data-status="Ordered">Ordered</button>
            <button class="btn filter-btn" data-status="Backordered">Backordered</button>
            <label style="margin-left:1rem; font-weight:normal;"><input type="checkbox" id="showHistoryToggle"> Show History</label>
        </div>
        <div id="ordersGroupContainer"></div>
      </section>
      
      <section id="panel-catalog" class="panel">
        <h2>Catalog Manager <span class="kvd" id="kvCatalog"></span></h2>
        <div class="row"><button class="btn" id="refreshCatalog">Refresh</button><button class="btn primary" id="showCatalogModal">Add New Item</button><span style="flex: 1;"></span><input id="catSearch" placeholder="Search..."/></div>
        <div id="catalogTableContainer"></div>
      </section>
      
      <section id="panel-units" class="panel">
        <h2>Unit Management <span class="kvd" id="kvUnits"></span></h2>
        <div class="row"><button class="btn" id="refreshUnits">Refresh</button></div>
        <div id="unitsTable"></div>
      </section>

      <section id="panel-compartments" class="panel">
        <h2>Compartment Management <span class="kvd" id="kvCompartments"></span></h2>
        <div class="row"><button class="btn" id="refreshCompartments">Refresh</button></div>
        <div id="compartmentsTable"></div>
      </section>

      <section id="panel-categories" class="panel">
        <h2>Category Management <span class="kvd" id="kvCategories"></span></h2>
        <div class="row"><button class="btn" id="refreshCategories">Refresh</button></div>
        <div id="categoriesTable"></div>
      </section>
  </div>
</div>

<div id="addItemToOrderModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h2>Add Item to Order List</h2><span class="close-btn" data-close-modal="addItemToOrderModal">&times;</span></div>
    <div class="modal-body">
      <label>Item <select id="addItemSelect"></select></label>
      <label>Quantity <input id="addItemQty" type="text" placeholder="e.g., 1 Box or 5"></label>
    </div>
    <div class="modal-footer">
      <button class="btn" data-close-modal="addItemToOrderModal">Cancel</button>
      <button class="btn primary" id="saveAddItemBtn">Add Item</button>
    </div>
  </div>
</div>

<div id="catalogModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header"><h2 id="catalogModalTitle">Edit Catalog Item</h2><span class="close-btn" data-close-modal="catalogModal">&times;</span></div>
    <div class="modal-body" style="grid-template-columns: 2fr 1fr;">
      
      <label style="grid-column: 1 / -1;">Item Name <input id="editItemName"></label>
      
      <label>Category <select id="editCategorySelect"><option value="">Loading...</option></select></label>
      <label>Item Ref # <input id="editItemRef"></label>
      
      <label>Unit (e.g., Box, Each)
        <select id="editUnit">
            <option value="">-- Select Unit --</option>
            <option value="Box">Box</option>
            <option value="Each">Each</option>
            <option value="Case">Case</option>
            <option value-"Kit">Kit</option>
        </select>
      </label>
      <label>Qty per Unit <input id="editPackSize" type="number" min="1"></label>

      <label>PAR Level <input id="editParLevel" type="number" min="0" value="0"></label>
      
      <div style="grid-column: 1 / -1; margin-top: 1rem;">
        <label>Alt Names (for search)</label>
        <div id="altNameList" class="list-container"></div>
        <div class="row" style="margin-bottom: 0;">
          <input id="newAltName" placeholder="Add alternate name..." style="flex: 1;">
          <button id="addNewAltNameBtn" class="btn primary">Add</button>
        </div>
      </div>
      
      <div style="grid-column: 1 / -1;">
        <label>Barcodes</label>
        <div id="barcodeList" class="list-container" style="max-height: 120px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; border-radius: 8px;"></div>
        <div class="row" style="margin-bottom: 0;">
          <input id="newBarcode" placeholder="Add new barcode..." style="flex: 1;">
          <button id="scanNewBarcodeBtn" class="btn">Scan</button>
          <button id="addNewBarcodeBtn" class="btn primary">Add</button>
        </div>
        <div id="barcodeScannerViewport" class="viewport" style="display:none; width:100%; height:240px; border:1px solid #ccc; background:#000; margin-top:1rem;"></div>
      </div>

      <div style="grid-column: 1 / -1; margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem;">
        <h3 style="margin-bottom: 8px;">Vendor Pricing</h3>
        <div id="catalogItemPricingTable" style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:8px; max-height: 200px; overflow-y: auto;"></div>
        <button id="addPriceInModalBtn" class="btn primary btn-small">+ Add Vendor Price</button>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn" data-close-modal="catalogModal">Cancel</button>
      <button class="btn" id="toggleActiveBtn" style="float: left;">Inactivate</button>
      <button class="btn primary" id="saveCatalogEdit">Save Changes</button>
    </div>
  </div>
</div>

<div id="pricingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h2 id="pricingModalTitle">Add/Edit Vendor Price</h2><span class="close-btn" data-close-modal="pricingModal">&times;</span></div>
    <div class="modal-body">
      <label>Item <select id="priceItemSelect"></select></label>
      <label>Vendor <select id="priceVendorSelect"></select></label>
      <label>Vendor Order # <input id="priceSku"></label>
      <label>Unit Price <input id="priceUnitPrice" type="number" step="0.01"></label>
      <label>Vendor Status
        <select id="priceVendorStatus">
          <option value="In Stock">In Stock</option>
          <option value="Backordered">Backordered</option>
          <option value="Out of Stock">Out of Stock</option>
        </select>
      </label>
    </div>
    <div class="modal-footer">
      <button class="btn" data-close-modal="pricingModal">Cancel</button>
      <button class="btn primary" id="savePricingEdit">Save Price</button>
    </div>
  </div>
</div>

<div id="changeVendorModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header"><h2 id="changeVendorTitle">Override Vendor</h2><span class="close-btn" data-close-modal="changeVendorModal">&times;</span></div>
    <div class="modal-body" style="grid-template-columns: 1fr;">
      <p>Move request for <strong id="changeVendorItemName">...</strong> to a different vendor for this order.</p>
      <label>New Vendor
        <select id="changeVendorSelect"></select>
      </label>
    </div>
    <div class="modal-footer">
      <button class="btn" data-close-modal="changeVendorModal">Cancel</button>
      <button class="btn primary" id="saveVendorOverrideBtn">Save</button>
    </div>
  </div>
</div>

<div id="printOrderModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h2 id="printOrderTitle">Order List</h2>
      <span class="close-btn" data-close-modal="printOrderModal">&times;</span>
    </div>
    <div class="modal-body" style="display: block;" id="printOrderBody">
      </div>
    <div class="modal-footer">
      <button class="btn" data-close-modal="printOrderModal">Close</button>
      <button class="btn primary" id="printOrderBtn">Print</button>
    </div>
  </div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { 
  initializeFirestore, 
  collection, getDocs, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, 
  writeBatch, serverTimestamp, query, where, orderBy, onSnapshot,
  persistentLocalCache, persistentMultipleTabManager, deleteField
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD7pMc-AHXb1cApzSfImkWvIjM9iwCoym4",
  authDomain: "supplies-ems.firebaseapp.com",
  projectId: "supplies-ems",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Auto Logout after 24 Hours of Inactivity
const INACTIVITY_LIMIT = 24 * 60 * 60 * 1000; // 24 hours
let inactivityTimeout;

function resetInactivityTimer() {
    clearTimeout(inactivityTimeout);
    if (state.user) {
        inactivityTimeout = setTimeout(() => {
            console.log("Inactivity timeout. Logging out.");
            alert("Session expired due to inactivity. Please log in again.");
            signOut(auth);
        }, INACTIVITY_LIMIT);
    }
}
['mousemove', 'keydown', 'click', 'touchstart'].forEach(evt => window.addEventListener(evt, resetInactivityTimer));

const db = initializeFirestore(app, {
  localCache: persistentLocalCache({
    tabManager: persistentMultipleTabManager(),
  }),
});

let state = { 
    user: null, 
    userRole: null, 
    catalog: [], 
    vendors: [], 
    categories: [], 
    pricingAll: [], 
    requests: [], 
    units: [], 
    compartments: [], 
    catalogMap: new Map(), 
    vendorMap: new Map(), 
    categoryMap: new Map(), 
    pricingMap: new Map(),
    orderViewMode: 'vendor' // 'vendor' or 'item'
};
let addItemChoices;
const $ = id => document.getElementById(id);
let appInitialized = false;
let isScannerActive = false;
let currentRequestIdToChange = null; // For vendor override modal

$("loading-container").style.display = "block";

    const escapeHtml = (s = "") => String(s).replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));

    onAuthStateChanged(auth, async (user) => {
        if (user) await handleUserSignedIn(user);
        else handleUserSignedOut();
    });

    $("googleLoginBtn").addEventListener("click", () => {
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({
            'hd': 'gemfireems.org',
            'oauth_web_client_id': '649560661195-m4c2sa1bncop9jnhajpvfum5dal3iqha.apps.googleusercontent.com'
        });
        signInWithPopup(auth, provider).catch((error) => console.error("Popup Sign-in Error:", error));
    });

    async function handleUserSignedIn(user) {
        if (!user.email.endsWith('@gemfireems.org')) {
            alert("Access denied. Please use a valid gemfireems.org email account.");
            return signOut(auth);
        }
        try {
            const userDocSnap = await getDoc(doc(db, "users", user.uid));
            state.userRole = userDocSnap.exists() ? userDocSnap.data().role : "Staff";
            if (!userDocSnap.exists()) await setDoc(doc(db, "users", user.uid), { email: user.email, role: "Staff" });
            
            state.user = user;
            resetInactivityTimer(); // Start timer on login
            $("auth-status-main").textContent = `${user.email} (${state.userRole})`;
            $("app-container").style.display = "block";
            $("login-container").style.display = "none";
            $("loading-container").style.display = "none";
            
            if (!appInitialized) {
                appInitialized = true;
                await boot();
            }
            applyPermissions(state.userRole);
        } catch (error) {
            console.error("Error handling signed-in user:", error);
            alert("Permission Error: Could not read user data.");
            signOut(auth);
        }
    }
    
    function applyPermissions(role) {
        const isAdmin = (role === 'Admin');
        document.querySelectorAll('.btn.danger').forEach(btn => {
            btn.style.display = isAdmin ? 'inline-block' : 'none';
        });
    }

    function handleUserSignedOut() {
        state.user = null;
        clearTimeout(inactivityTimeout); // Stop timer
        $("app-container").style.display = "none";
        $("login-container").style.display = "block";
        $("loading-container").style.display = "none";
        appInitialized = false;
    }

    $("logoutBtn").addEventListener("click", () => signOut(auth));

    async function initializeStaticData() {
        try {
            const [catSnap, venSnap, unitSnap, compSnap, catMgmtSnap] = await Promise.all([
                getDocs(collection(db, "catalog")),
                getDocs(collection(db, "vendors")),
                getDocs(collection(db, "units")),
                getDocs(collection(db, "compartments")),
                getDocs(collection(db, "categories"))
            ]);
            
            state.catalog = catSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            state.vendors = venSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            state.units = unitSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            state.compartments = compSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            state.categories = catMgmtSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            state.catalogMap = new Map(state.catalog.map(c => [c.id, c]));
            state.vendorMap = new Map(state.vendors.map(v => [v.id, v.name]));
            state.categoryMap = new Map(state.categories.map(c => [c.id, c.name]));
            
            renderCatalog();
            renderUnits();
            renderCompartments();
            renderCategories();
        } catch(e) {
            console.error("Static Data Load Failed:", e);
            alert("Static Data Load Failed: " + e.message);
        }
    }

    function setupRealtimeListeners() {
        onSnapshot(collection(db, "requests"), (reqSnap) => {
            state.requests = reqSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderOrders();
        });

        onSnapshot(collection(db, "vendorPricing"), (priceSnap) => {
            state.pricingAll = priceSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            state.pricingMap.clear();
            state.pricingAll.forEach(p => {
                if (!state.pricingMap.has(p.catalogId)) state.pricingMap.set(p.catalogId, []);
                state.pricingMap.get(p.catalogId).push(p);
            });
            renderOrders(); 
            renderCatalog();
        });
    }

    // This function now respects `overrideVendorId` first
    function findBestVendor(catalogId, preferredVendorId, overrideVendorId) {
        const prices = (state.pricingMap.get(catalogId) || [])
            .map(p => ({...p, vendorName: state.vendorMap.get(p.vendorId) || 'Unknown Vendor' }))
            .sort((a,b) => (a.unitPrice || Infinity) - (b.unitPrice || Infinity));

        // 1. Check for manual override
        if (overrideVendorId) {
            const overridePrice = prices.find(p => p.vendorId === overrideVendorId);
            if (overridePrice) {
                 return {
                    vendorId: overridePrice.vendorId,
                    vendorName: overridePrice.vendorName,
                    vendorItemNo: overridePrice.vendorItemNo || 'N/A',
                    unitPrice: overridePrice.unitPrice,
                    status: 'Manual Override'
                };
            }
            // Fallback if override vendor has no price info (but still use it)
            return {
                vendorId: overrideVendorId,
                vendorName: state.vendorMap.get(overrideVendorId) || 'Unknown Vendor',
                vendorItemNo: 'N/A',
                unitPrice: 0,
                status: 'Manual Override'
            };
        }
        
        const preferredPrice = preferredVendorId ? prices.find(p => p.vendorId === preferredVendorId) : null;
        
        // 2. Try Preferred Vendor if in stock
        if (preferredPrice && (preferredPrice.vendorStatus === 'In Stock' || !preferredPrice.vendorStatus)) {
            return {
                vendorId: preferredPrice.vendorId,
                vendorName: preferredPrice.vendorName,
                vendorItemNo: preferredPrice.vendorItemNo || 'N/A',
                unitPrice: preferredPrice.unitPrice,
                status: 'Preferred'
            };
        }
        
        // 3. Find cheapest vendor that is "In Stock"
        const cheapestInStock = prices.find(p => p.vendorStatus === 'In Stock' || !p.vendorStatus);
        if (cheapestInStock) {
            return {
                vendorId: cheapestInStock.vendorId,
                vendorName: cheapestInStock.vendorName,
                vendorItemNo: cheapestInStock.vendorItemNo || 'N/A',
                unitPrice: cheapestInStock.unitPrice,
                status: 'Cheapest'
            };
        }

        // 4. Fallback: Use preferred vendor (even if backordered)
        if (preferredPrice) {
            return {
                vendorId: preferredPrice.vendorId,
                vendorName: preferredPrice.vendorName,
                vendorItemNo: preferredPrice.vendorItemNo || 'N/A',
                unitPrice: preferredPrice.unitPrice,
                status: `Preferred (${preferredPrice.vendorStatus || 'N/A'})`
            };
        }
        
        // 5. Fallback: Use cheapest vendor (even if backordered/out of stock)
        const cheapestOverall = prices[0];
        if (cheapestOverall) {
            return {
                vendorId: cheapestOverall.vendorId,
                vendorName: cheapestOverall.vendorName,
                vendorItemNo: cheapestOverall.vendorItemNo || 'N/A',
                unitPrice: cheapestOverall.unitPrice,
                status: `Cheapest (${cheapestOverall.vendorStatus || 'N/A'})`
            };
        }

        // 6. No pricing info
        return { vendorId: 'unassigned', vendorName: 'Unassigned / No Pricing', vendorItemNo: 'N/A', unitPrice: 0, status: 'No Pricing' };
    }
    
    // Main render function, decides which view to show
    function renderOrders() {
        if (state.orderViewMode === 'vendor') {
            renderOrdersByVendor();
        } else {
            renderOrdersByItem();
        }
    }

    function getFilteredRequests() {
        const showHistory = $('showHistoryToggle').checked;
        const activeFilter = document.querySelector('.filter-btn.active')?.dataset.status || 'All';
        
        return state.requests.filter(r => {
            const status = r.status || 'Open';
            const isHistoryStatus = ['Received', 'Completed', 'Closed'].includes(status);
            
            if (showHistory) return isHistoryStatus;
            if (isHistoryStatus) return false; 
            if (activeFilter === 'All') return true;
            return status === activeFilter;
        });
    }

    function renderOrdersByItem() {
        const container = $('ordersGroupContainer');
        const requestsToProcess = getFilteredRequests();
        
        const sortOrder = { "Open": 1, "Backordered": 2, "Pending": 2, "Ordered": 3 };
        requestsToProcess.sort((a, b) => {
            const itemA = (state.catalogMap.get(a.catalogId)?.itemName || a.otherItemName || 'Z').toLowerCase();
            const itemB = (state.catalogMap.get(b.catalogId)?.itemName || b.otherItemName || 'Z').toLowerCase();
            if (itemA !== itemB) return itemA.localeCompare(itemB);
            const aStatus = a.status || "Open";
            const bStatus = b.status || "Open";
            return (sortOrder[aStatus] || 99) - (sortOrder[bStatus] || 99);
        });

        if (requestsToProcess.length === 0) {
            const msg = $('showHistoryToggle').checked ? 'No history found.' : 'No active requests found.';
            container.innerHTML = `<p class="muted">${msg}</p>`;
            return;
        }

        if ($('showHistoryToggle').checked) {
             container.innerHTML = renderHistoryTable(requestsToProcess);
             return;
        }
        
        const tableRows = requestsToProcess.map(r => {
            const status = r.status || 'Open';
            const catItem = state.catalogMap.get(r.catalogId);
            if (!catItem) return ''; // Skip items not in catalog

            const vendorInfo = findBestVendor(r.catalogId, catItem.preferredVendorId, r.overrideVendorId);
            const allPrices = (state.pricingMap.get(catItem.id) || [])
                .map(p => ({...p, vendorName: state.vendorMap.get(p.vendorId) || 'N/A'}))
                .sort((a,b) => (a.unitPrice || Infinity) - (b.unitPrice || Infinity));
            const cheapestPrice = allPrices[0];
            
            const allPricesHtml = allPrices.length > 0 ? allPrices.map(p => {
                let classes = 'price-tag';
                if (p.vendorId === catItem.preferredVendorId) classes += ' preferred-price';
                if (p.vendorId === cheapestPrice?.vendorId) classes += ' best-price';
                
                return `<div class="${classes}">
                    ${escapeHtml(p.vendorName)}: $${(p.unitPrice || 0).toFixed(2)} (#${escapeHtml(p.vendorItemNo)}) - <em>${escapeHtml(p.vendorStatus || 'In Stock')}</em>
                </div>`;
            }).join('') : '<div class="muted">No prices found.</div>';
            
            return `
                <tr data-request-id="${r.id}">
                    <td>
                        <strong>${escapeHtml(catItem.itemName)}</strong>
                        <button class="btn" data-toggle-details style="margin-left: 8px; padding: 2px 6px;">▼</button>
                        <br>
                        <span class="muted">${escapeHtml(vendorInfo.vendorName)} (${escapeHtml(vendorInfo.status)})</span>
                    </td>
                    <td>
                        <input class="quick-qty-edit" type="text" value="${escapeHtml(r.qty)}" 
                               data-request-id="${r.id}" 
                               data-original-value="${escapeHtml(r.qty)}" 
                               style="width: 70px; text-align: right; padding-right: 5px;">
                        <span class="muted" style="margin-left: 5px;">${escapeHtml(catItem.unit || 'Each')}</span>
                    </td>
                    <td>${vendorInfo.vendorItemNo || 'N/A'}</td>
                    <td>${vendorInfo.unitPrice ? `$${vendorInfo.unitPrice.toFixed(2)}` : 'N/A'}</td>
                    <td>
                        <div class="status-buttons">
                            <button class="btn btn-status ${status === 'Open' ? 'active' : ''}" data-status="Open">Open</button>
                            <button class="btn btn-status ${status === 'Ordered' ? 'active' : ''}" data-status="Ordered">Ordered</button>
                            <button class="btn btn-status ${status === 'Backordered' ? 'active' : ''}" data-status="Backordered">Backordered</button>
                            <button class="btn btn-status-receive" data-status="Received">Received</button>
                        </div>
                        <div class="edit-buttons" style="margin-top: 4px;">
                            ${status === 'Open' ? `<button class="btn btn-small" data-change-vendor-id="${r.id}">Change Vendor</button>` : ''}
                        </div>
                    </td>
                </tr>
                <tr class="details-row" data-details-for="${r.id}">
                    <td colspan="5" class="details-cell">
                        <h4>All Vendor Pricing for ${escapeHtml(catItem.itemName)}</h4>
                        ${allPricesHtml}
                    </td>
                </tr>`;
        }).join('');

        container.innerHTML = `
            <table class="vendor-group-table">
                <thead>
                    <tr>
                        <th>Item/Vendor</th>
                        <th>Qty</th>
                        <th>Vendor #</th>
                        <th>Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>${tableRows}</tbody>
            </table>`;
    }

    function renderOrdersByVendor() {
        const container = $('ordersGroupContainer');
        const requestsToProcess = getFilteredRequests();

        const sortOrder = { "Open": 1, "Backordered": 2, "Pending": 2, "Ordered": 3 };
        requestsToProcess.sort((a, b) => {
            const aStatus = a.status || "Open";
            const bStatus = b.status || "Open";
            return (sortOrder[aStatus] || 99) - (sortOrder[bStatus] || 99) || (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
        });
        
        if ($('showHistoryToggle').checked) {
            container.innerHTML = renderHistoryTable(requestsToProcess);
            return;
        }

        const requestsByGroup = new Map();
        for (const r of requestsToProcess) {
            const catItem = state.catalogMap.get(r.catalogId);
            if (!catItem) continue; // Skip items not in catalog

            // Pass overrideVendorId to findBestVendor
            const vendorInfo = findBestVendor(r.catalogId, catItem.preferredVendorId, r.overrideVendorId);
            const augmentedRequest = { ...r, vendorInfo, catItem };

            let groupId, groupName;
            
            // If status is 'Open', group by vendor. Otherwise, group by status.
            if (r.status === 'Open' || !r.status) {
                groupId = vendorInfo.vendorId;
                groupName = vendorInfo.vendorName;
            } else {
                groupId = r.status; // "Ordered" or "Backordered"
                groupName = r.status;
            }

            if (!requestsByGroup.has(groupId)) {
                requestsByGroup.set(groupId, {
                    groupName: groupName,
                    requests: []
                });
            }
            requestsByGroup.get(groupId).requests.push(augmentedRequest);
        }
        
        container.innerHTML = ''; // Clear container
        
        // Render groups: Vendor groups first, then unassigned, then status groups
        requestsByGroup.forEach((group, groupId) => {
            if (groupId !== 'unassigned' && groupId !== 'Ordered' && groupId !== 'Backordered' && groupId !== 'Open') {
                renderVendorGroup(container, group, groupId);
            }
        });
        renderVendorGroup(container, requestsByGroup.get('unassigned'), 'unassigned');
        renderVendorGroup(container, requestsByGroup.get('Ordered'), 'Ordered');
        renderVendorGroup(container, requestsByGroup.get('Backordered'), 'Backordered');

        if (requestsToProcess.length === 0) {
             container.innerHTML = `<p class="muted">No active requests found.</p>`;
        }
    }

    function renderHistoryTable(requests) {
        if (requests.length === 0) return `<p class="muted">No history found.</p>`;
        
        requests.sort((a,b) => (b.receivedAt?.seconds || b.updatedAt?.seconds || 0) - (a.receivedAt?.seconds || a.updatedAt?.seconds || 0));

        const rows = requests.map(r => {
            const catItem = state.catalogMap.get(r.catalogId);
            const itemName = catItem ? catItem.itemName : (r.otherItemName || 'Unknown');
            const receivedDate = r.receivedAt ? new Date(r.receivedAt.seconds * 1000).toLocaleDateString() : (r.updatedAt ? new Date(r.updatedAt.seconds * 1000).toLocaleDateString() : 'N/A');
            return `
                <tr>
                    <td><strong>${escapeHtml(itemName)}</strong><br><span class="muted">${escapeHtml(r.requesterEmail)}</span></td>
                    <td>${escapeHtml(r.qty)}</td>
                    <td>${escapeHtml(r.status)}</td>
                    <td>${receivedDate}</td>
                </tr>`;
        }).join('');
        
        return `
            <table>
                <thead><tr><th>Item/Requester</th><th>Qty</th><th>Status</th><th>Date Received</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>`;
    }

    function renderVendorGroup(container, group, vendorId) {
        if (!group || group.requests.length === 0) return;

        const isOrderableGroup = vendorId && vendorId !== 'Open' && vendorId !== 'Ordered' && vendorId !== 'Backordered' && vendorId !== 'unassigned';
        const groupTitle = group.groupName || 'Unknown Group';

        const tableRows = group.requests.map(r => {
            const status = r.status || 'Open';
            const catItem = r.catItem;
            
            // --- Logic for Price Comparison Details ---
            const allPrices = (state.pricingMap.get(catItem.id) || [])
                .map(p => ({...p, vendorName: state.vendorMap.get(p.vendorId) || 'N/A'}))
                .sort((a,b) => (a.unitPrice || Infinity) - (b.unitPrice || Infinity));
            const cheapestPrice = allPrices[0];
            
            const allPricesHtml = allPrices.length > 0 ? allPrices.map(p => {
                let classes = 'price-tag';
                if (p.vendorId === catItem.preferredVendorId) classes += ' preferred-price';
                if (p.vendorId === cheapestPrice?.vendorId) classes += ' best-price';
                
                return `<div class="${classes}">
                    ${escapeHtml(p.vendorName)}: $${(p.unitPrice || 0).toFixed(2)} (#${escapeHtml(p.vendorItemNo)}) - <em>${escapeHtml(p.vendorStatus || 'In Stock')}</em>
                </div>`;
            }).join('') : '<div class="muted">No prices found.</div>';
            // --- End Details Logic ---
            
            return `
                <tr data-request-id="${r.id}">
                    ${isOrderableGroup ? `<td><input type="checkbox" class="order-item-checkbox" data-request-id="${r.id}"></td>` : ''}
                    <td>
                        <strong>${escapeHtml(r.catItem.itemName)}</strong>
                        <button class="btn" data-toggle-details style="margin-left: 8px; padding: 2px 6px;">▼</button>
                        <br>
                        <span class="muted">${escapeHtml(r.vendorInfo.vendorName)} (${escapeHtml(r.vendorInfo.status)})</span>
                    </td>
                    <td>
                        <input class="quick-qty-edit" type="text" value="${escapeHtml(r.qty)}" 
                               data-request-id="${r.id}" 
                               data-original-value="${escapeHtml(r.qty)}" 
                               style="width: 70px; text-align: right; padding-right: 5px;">
                        <span class="muted" style="margin-left: 5px;">${escapeHtml(catItem.unit || 'Each')}</span>
                    </td>
                    <td>${escapeHtml(r.vendorInfo.vendorItemNo || 'N/A')}</td>
                    <td>${r.vendorInfo.unitPrice ? `$${r.vendorInfo.unitPrice.toFixed(2)}` : 'N/A'}</td>
                    <td>
                        <div class="status-buttons">
                            <button class="btn btn-status ${status === 'Open' ? 'active' : ''}" data-status="Open">Open</button>
                            <button class="btn btn-status ${status === 'Ordered' ? 'active' : ''}" data-status="Ordered">Ordered</button>
                            <button class="btn btn-status ${status === 'Backordered' ? 'active' : ''}" data-status="Backordered">Backordered</button>
                            <button class="btn btn-status-receive" data-status="Received">Received</button>
                        </div>
                        <div class="edit-buttons" style="margin-top: 4px;">
                            ${status === 'Open' ? `<button class="btn btn-small" data-change-vendor-id="${r.id}">Change Vendor</button>` : ''}
                        </div>
                    </td>
                </tr>
                <tr class="details-row" data-details-for="${r.id}">
                    <td colspan="${isOrderableGroup ? 7 : 6}" class="details-cell">
                        <h4>All Vendor Pricing for ${escapeHtml(r.catItem.itemName)}</h4>
                        ${allPricesHtml}
                    </td>
                </tr>`;
        }).join('');

        const headerActions = isOrderableGroup ? `
            <div class="row" style="margin-bottom: 0;">
                <label style="font-weight: normal; font-size: 0.9rem; margin-right: 1rem;">
                    <input type="checkbox" class="vendor-select-all" data-vendor-id="${vendorId}"> Select All
                </label>
                <button class="btn primary btn-small generate-order-btn" data-vendor-id="${vendorId}" data-vendor-name="${escapeHtml(groupTitle)}">Generate Order for ${escapeHtml(groupTitle)}</button>
            </div>` : '';

        container.innerHTML += `
            <div class="vendor-group" data-group-vendor-id="${vendorId}">
                <div class="vendor-group-header">
                    <h3>${escapeHtml(groupTitle)} (${group.requests.length})</h3>
                    ${headerActions}
                </div>
                <table class="vendor-group-table">
                    <thead>
                        <tr>
                            ${isOrderableGroup ? `<th><input type="checkbox" class="vendor-select-all" data-vendor-id="${vendorId}"></th>` : ''}
                            <th>Item/Vendor</th>
                            <th>Qty</th>
                            <th>Vendor #</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>`;
    }

    function renderCatalog() {
        const container = $('catalogTableContainer');
        const query = $('catSearch').value.toLowerCase();
        const filtered = state.catalog.filter(i => 
            (i.itemName || '').toLowerCase().includes(query) || 
            (Array.isArray(i.itemNameAlt) ? i.itemNameAlt.join(' ') : (i.itemNameAlt || '')).toLowerCase().includes(query)
        );
        $('kvCatalog').textContent = `(${filtered.length})`;

        const rows = filtered.map(item => {
            const categoryName = state.categoryMap.get(item.category) || item.category || 'N/A';
            
            // --- Pricing Info Logic ---
            const allPrices = (state.pricingMap.get(item.id) || [])
                .map(p => ({...p, vendorName: state.vendorMap.get(p.vendorId) || 'N/A'}))
                .sort((a,b) => (a.unitPrice || Infinity) - (b.unitPrice || Infinity));
            
            const cheapestPrice = allPrices[0];
            
            const pricesHtml = allPrices.length > 0 ? allPrices.map(p => {
                let classes = 'price-tag';
                if (p.vendorId === item.preferredVendorId) classes += ' preferred-price';
                if (p.vendorId === cheapestPrice?.vendorId) classes += ' best-price';
                
                return `<span class="${classes}">
                    ${escapeHtml(p.vendorName)}: $${(p.unitPrice || 0).toFixed(2)}
                    <button class="btn btn-small" data-edit-price-id="${p.id}" style="margin-left: 8px; padding: 2px 6px; font-size: 0.7rem;">Edit</button>
                </span>`;
            }).join('') : '<span class="muted">No pricing</span>';
            // --- End Pricing Info Logic ---
            
            return `
                <tr class="catalog-row" data-catalog-id="${item.id}" style="${item.isActive === false ? 'opacity: 0.5; text-decoration: line-through;' : ''}">
                    <td><strong>${escapeHtml(item.itemName)}</strong></td>
                    <td>${escapeHtml(categoryName)}</td>
                    <td>${escapeHtml(item.parLevel || 0)}</td>
                    <td>${pricesHtml}</td>
                    <td>
                        <button class="btn btn-small" data-edit-item-id="${item.id}">Edit Item</button>
                        <button class="btn primary btn-small" data-add-price-for-id="${item.id}">+ Add Price</button>
                    </td>
                </tr>
            `;
        }).join('');

        container.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th>PAR</th>
                        <th style="width: 35%;">Vendor Pricing</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>`;
    }

    function renderUnits() {
        $('kvUnits').textContent = `(${state.units.length})`;
        const rows = state.units.map(u => `<tr><td>${u.name}</td><td>${u.id}</td><td><button class="btn danger" data-delete-unit-id="${u.id}">Delete</button></td></tr>`).join('');
        $('unitsTable').innerHTML = `<div class="row"><input id="newUnitName" placeholder="New Unit Name"><button id="addUnitBtn" class="btn primary">Add Unit</button></div><table><thead><tr><th>Name</th><th>ID</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderCompartments() {
        $('kvCompartments').textContent = `(${state.compartments.length})`;
        const rows = state.compartments.map(c => `<tr><td>${c.name}</td><td><button class="btn danger" data-delete-comp-id="${c.id}">Delete</button></td></tr>`).join('');
        $('compartmentsTable').innerHTML = `<div class="row"><input id="newCompName" placeholder="New Compartment Name"><button id="addCompBtn" class="btn primary">Add Compartment</button></div><table><thead><tr><th>Name</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderCategories() {
        $('kvCategories').textContent = `(${state.categories.length})`;
        const rows = state.categories.map(c => `<tr><td>${c.name}</td><td><button class="btn danger" data-delete-category-id="${c.id}">Delete</button></td></tr>`).join('');
        $('categoriesTable').innerHTML = `<div class="row"><input id="newCategoryName" placeholder="New Category Name"><button id="addCategoryBtn" class="btn primary">Add Category</button></div><table><thead><tr><th>Name</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function startScanner(targetInput, viewportElement) {
        if (isScannerActive) {
            Quagga.stop();
            isScannerActive = false;
            viewportElement.style.display = 'none';
            return;
        }
        viewportElement.style.display = 'block';
        Quagga.init({ inputStream: { name: "Live", type: "LiveStream", target: viewportElement, constraints: { facingMode: "environment" } }, decoder: { readers: ["code_128_reader", "ean_reader", "upc_reader"] }}, (err) => {
            if (err) { console.error("Quagga Error:", err); viewportElement.style.display = 'none'; return; }
            Quagga.start();
            isScannerActive = true;
        });
        Quagga.onDetected(result => {
            Quagga.stop();
            isScannerActive = false;
            viewportElement.style.display = 'none';
            if (result && result.codeResult) targetInput.value = result.codeResult.code;
        });
    }

    function showPrintModal(vendorName, selectedRequests) {
        const modal = $('printOrderModal');
        $('printOrderTitle').textContent = `Order List for ${vendorName}`;
        
        const rows = selectedRequests.map(r => {
            const catItem = state.catalogMap.get(r.catalogId);
            const vendorInfo = findBestVendor(r.catalogId, catItem.preferredVendorId, r.overrideVendorId);
            return `
                <tr>
                    <td>${escapeHtml(catItem.itemName)}</td>
                    <td>${escapeHtml(vendorInfo.vendorItemNo || 'N/A')}</td>
                    <td>${escapeHtml(r.qty)} ${escapeHtml(catItem.unit || 'Each')}</td>
                </tr>
            `;
        }).join('');

        $('printOrderBody').innerHTML = `
            <p><strong>Vendor:</strong> ${escapeHtml(vendorName)}</p>
            <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
            <p><strong>Requested By:</strong> ${escapeHtml(state.user.email)}</p>
            <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                <thead>
                    <tr style="background-color: #f0f0f0;">
                        <th>Item Name</th>
                        <th>Vendor Item #</th>
                        <th>Quantity Needed</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                </tbody>
            </table>`;
        
        modal.style.display = 'flex';
    }
    
    function setupAllModalsAndActions() {
        setupCatalogModal(); 
        setupPricingModal(); 
        setupAddItemToOrderModal();
        setupChangeVendorModal();

        // Close modal buttons
        document.querySelectorAll('[data-close-modal]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modalId = e.currentTarget.dataset.closeModal;
                if(modalId === 'catalogModal') closeCatalogModal();
                else if (modalId) $(modalId).style.display = 'none';
            });
        });

        $('printOrderBtn').addEventListener('click', () => window.print());

        // Listener for Order filtering
        document.querySelector('#panel-orders .row').addEventListener('click', e => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderOrders();
            }
            if (e.target.classList.contains('view-btn')) {
                document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                state.orderViewMode = e.target.dataset.view;
                renderOrders();
            }
        });
        $('showHistoryToggle').addEventListener('change', renderOrders);
        
        // Event delegation for Orders panel CLICK actions
        $('ordersGroupContainer').addEventListener('click', async e => {
            const target = e.target;
            
            if (target.classList.contains('vendor-select-all')) {
                const groupContainer = target.closest('.vendor-group');
                const isChecked = target.checked;
                groupContainer.querySelectorAll('.order-item-checkbox').forEach(cb => cb.checked = isChecked);
                return;
            }

            if (target.classList.contains('generate-order-btn')) {
                const vendorName = target.dataset.vendorName;
                const groupContainer = target.closest('.vendor-group');
                
                const selectedCheckboxes = groupContainer.querySelectorAll('.order-item-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    alert("Please select at least one item to order.");
                    return;
                }
                
                const selectedRequestIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.requestId);
                const selectedRequests = state.requests.filter(r => selectedRequestIds.includes(r.id));
                
                showPrintModal(vendorName, selectedRequests);
                return;
            }
            
            const tr = target.closest('tr[data-request-id]');
            if (!tr) return; 
            
            const requestId = tr.dataset.requestId;

            if (target.dataset.toggleDetails !== undefined) {
                const detailsRow = tr.nextElementSibling;
                if (detailsRow && detailsRow.dataset.detailsFor === requestId) {
                    detailsRow.classList.toggle('visible');
                }
                return;
            }

            if (target.dataset.status) {
                await updateRequestStatus(requestId, target.dataset.status);
                return;
            }
            
            // Vendor Override Button
            if (target.dataset.changeVendorId) {
                openChangeVendorModal(requestId);
                return;
            }
        });

        // NEW listener for Qty changes (blur)
        $('ordersGroupContainer').addEventListener('blur', e => {
            if (e.target.classList.contains('quick-qty-edit')) {
                handleQuickQtyUpdate(e.target);
            }
        }, true); // Use capture phase to catch blur

        // NEW listener for Qty changes (Enter key)
        $('ordersGroupContainer').addEventListener('keydown', e => {
            if (e.key === 'Enter' && e.target.classList.contains('quick-qty-edit')) {
                handleQuickQtyUpdate(e.target);
                e.target.blur(); // Unfocus the input
            }
        });

        // NEW function to handle the update
        async function handleQuickQtyUpdate(target) {
            const requestId = target.dataset.requestId;
            const newQty = target.value.trim();
            const originalQty = target.dataset.originalValue;

            if (!newQty) {
                target.classList.add('error');
                alert("Quantity cannot be empty.");
                target.value = originalQty; // Reset to original
                setTimeout(() => target.classList.remove('error'), 1000);
                return;
            }

            if (newQty === originalQty) {
                return; // No change
            }

            try {
                await updateDoc(doc(db, 'requests', requestId), {
                    qty: newQty,
                    updatedAt: serverTimestamp()
                });
                target.dataset.originalValue = newQty; // Set new original value
                target.classList.add('success');
                setTimeout(() => target.classList.remove('success'), 1500);
            } catch (e) {
                console.error("Failed to update quantity:", e);
                target.classList.add('error');
                alert("Error saving quantity.");
                target.value = originalQty; // Reset to original
                setTimeout(() => target.classList.remove('error'), 1500);
            }
        }


        // Click listener for Catalog panel (edit item, add/edit price)
        $('catalogTableContainer').addEventListener('click', e => {
            const target = e.target;
            
            if (target.dataset.editItemId) {
                openCatalogModal(target.dataset.editItemId);
                return;
            }
            
            if (target.dataset.addPriceForId) {
                openPricingModal(null, target.dataset.addPriceForId);
                return;
            }

            if (target.dataset.editPriceId) {
                openPricingModal(target.dataset.editPriceId);
                return;
            }
        });

        setupUnitActions(); 
        setupCompartmentActions();
        setupCategoryActions();
    }

    async function updateRequestStatus(requestId, newStatus) {
        if (!requestId || !newStatus) return;
        
        const updatePayload = { status: newStatus, updatedAt: serverTimestamp() };
        
        if (newStatus === 'Received' || newStatus === 'Completed') {
            updatePayload.receivedAt = serverTimestamp();
            updatePayload.overrideVendorId = deleteField(); // Clear override when received
        } 
        else if (newStatus === 'Open') {
             updatePayload.overrideVendorId = deleteField(); // Clear override if sent back to Open
        }
        else if (newStatus === 'Ordered') {
            updatePayload.lastOrdered = serverTimestamp();
        }
        
        try {
            await updateDoc(doc(db, 'requests', requestId), updatePayload);
        } catch(e) {
            console.error("Status update failed:", e);
            alert("Could not update status.");
        }
    }
    
    function setupAddItemToOrderModal() {
        const modal = $('addItemToOrderModal');
        const itemElement = $('addItemSelect');
        if (addItemChoices) addItemChoices.destroy();
        addItemChoices = new Choices(itemElement, { 
            searchEnabled: true, 
            placeholderValue: 'Select an item to add...',
            searchResultLimit: 100 
        });

        $('showAddItemModal').addEventListener('click', () => {
            const options = state.catalog.filter(c=>c.isActive !== false).map(c=>({value: c.id, label: c.itemName}));
            addItemChoices.setChoices(options, 'value', 'label', true);
            modal.style.display = 'flex';
        });

        $('saveAddItemBtn').addEventListener('click', async () => {
            const catalogId = addItemChoices.getValue(true);
            const qty = $('addItemQty').value;
            if (!catalogId || !qty) return alert('Please select an item and quantity.');
            if (!state.user || !state.user.email) return alert('Cannot add item: user is not properly logged in.');
            const payload = { catalogId, qty, status: 'Open', createdAt: serverTimestamp(), updatedAt: serverTimestamp(), requesterEmail: state.user.email };
            await addDoc(collection(db, 'requests'), payload);
            modal.style.display = 'none';
            $('addItemQty').value = '';
        });
    }

    // --- Helper for list items (Barcodes, Alt Names) ---
    function setupListInput(listContainerEl, inputEl, addBtnEl, listArray) {
        listContainerEl.innerHTML = '';
        (listArray || []).forEach(item => addListItem(listContainerEl, item));
        
        addBtnEl.onclick = () => { // Use onclick to replace any existing
            const value = inputEl.value.trim();
            if (value) {
                addListItem(listContainerEl, value);
                inputEl.value = '';
            }
        };
        
        listContainerEl.onclick = (e) => { // Use onclick to replace any existing
            if (e.target.tagName === 'BUTTON' && e.target.classList.contains('danger')) {
                 e.target.parentElement.remove();
            }
        };
    }
    
    function addListItem(listContainerEl, value) {
        const el = document.createElement('div');
        el.className = 'list-item';
        el.innerHTML = `<span class="list-item-text">${escapeHtml(value)}</span><button type="button" class="btn danger" style="padding: 2px 6px;">&times;</button>`;
        listContainerEl.appendChild(el);
        applyPermissions(state.userRole);
    }

    function getListItems(listContainerEl) {
        return Array.from(listContainerEl.querySelectorAll('.list-item-text')).map(el => el.textContent);
    }
    // --- End Helper ---

    let currentCatalogItemId = null;
    let currentCatalogItem = null;
    function openCatalogModal(itemId = null) {
        currentCatalogItemId = itemId; 
        currentCatalogItem = itemId ? state.catalog.find(i => i.id === itemId) : { isActive: true }; // Default new item to active
        const item = currentCatalogItem;
        
        $('catalogModalTitle').textContent = itemId ? 'Edit Catalog Item' : 'Add New Catalog Item';
        $('editItemName').value = item.itemName || ''; 
        $('editItemRef').value = item.itemRef || '';
        $('editUnit').value = item.unit || ''; 
        $('editPackSize').value = item.packSize || 1;
        $('editParLevel').value = item.parLevel || 0;
        
        // --- Activation Button ---
        const activeBtn = $('toggleActiveBtn');
        if (item.isActive === false) {
            activeBtn.textContent = 'Re-Activate Item';
            activeBtn.classList.add('ok');
            activeBtn.classList.remove('danger');
        } else {
            activeBtn.textContent = 'Inactivate Item';
            activeBtn.classList.add('danger');
            activeBtn.classList.remove('ok');
        }
        activeBtn.style.display = itemId ? 'inline-block' : 'none'; // Hide on "new item"
        
        // Populate Categories Dropdown
        const catSelect = $('editCategorySelect');
        catSelect.innerHTML = '<option value="">-- Select Category --</option>' + state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        catSelect.value = item.category || '';
        
        // Setup Alt Names
        const altNameArray = Array.isArray(item.itemNameAlt) ? item.itemNameAlt : (item.itemNameAlt ? [item.itemNameAlt] : []);
        setupListInput($('altNameList'), $('newAltName'), $('addNewAltNameBtn'), altNameArray);
        
        // Setup Barcodes
        const barcodeArray = Array.isArray(item.barcode) ? item.barcode : (item.barcode ? [item.barcode] : []);
        setupListInput($('barcodeList'), $('newBarcode'), $('addNewBarcodeBtn'), barcodeArray);
        
        // --- Render Pricing in Modal ---
        const pricingContainer = $('catalogItemPricingTable');
        const addPriceBtn = $('addPriceInModalBtn');
        if (itemId) {
            addPriceBtn.style.display = 'inline-block';
            addPriceBtn.onclick = () => openPricingModal(null, itemId);

            const prices = (state.pricingMap.get(itemId) || []).map(p => ({...p, vendorName: state.vendorMap.get(p.vendorId) || 'Unknown'}));
            if (prices.length > 0) {
                const rows = prices.map(p => {
                    const isPreferred = p.vendorId === item.preferredVendorId;
                    return `
                    <tr style="${isPreferred ? 'background-color: #dbeafe;' : ''}">
                        <td>${escapeHtml(p.vendorName)}</td>
                        <td>${escapeHtml(p.vendorItemNo)}</td>
                        <td>$${(p.unitPrice||0).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-small" data-edit-price-id-modal="${p.id}">Edit</button>
                            <button class="btn btn-small ${isPreferred ? 'primary' : ''}" 
                                    data-set-preferred-vendor="${p.vendorId}" 
                                    data-item-id="${itemId}" 
                                    ${isPreferred ? 'disabled' : ''}>
                                ${isPreferred ? 'Preferred' : 'Set'}
                            </button>
                        </td>
                    </tr>
                `}).join('');
                pricingContainer.innerHTML = `<table style="font-size:0.9rem; width: 100%;"><thead><tr><th>Vendor</th><th>Vendor Order #</th><th>Price</th><th>Action</th></tr></thead><tbody>${rows}</tbody></table>`;
                
                // Add listeners for edit buttons inside the modal
                pricingContainer.querySelectorAll('[data-edit-price-id-modal]').forEach(btn => {
                    btn.onclick = () => openPricingModal(btn.dataset.editPriceIdModal);
                });
                pricingContainer.querySelectorAll('[data-set-preferred-vendor]').forEach(btn => {
                    btn.onclick = async () => {
                        const vendorId = btn.dataset.setPreferredVendor;
                        const catId = btn.dataset.itemId;
                        await updateDoc(doc(db, "catalog", catId), { preferredVendorId: vendorId, updatedAt: serverTimestamp() });
                        await initializeStaticData(); // Easiest way to refresh state
                        openCatalogModal(catId); // Re-open/refresh modal
                    };
                });
            } else {
                pricingContainer.innerHTML = '<p class="muted">No vendor pricing recorded.</p>';
            }
        } else {
            pricingContainer.innerHTML = '<p class="muted">Save item first to add pricing.</p>';
            addPriceBtn.style.display = 'none';
        }
        
        applyPermissions(state.userRole);
        $('catalogModal').style.display = 'flex';
    }

    function closeCatalogModal() {
        if (isScannerActive) Quagga.stop(); 
        isScannerActive = false; 
        $('barcodeScannerViewport').style.display = 'none'; 
        $('catalogModal').style.display = 'none'; 
        currentCatalogItemId = null;
        currentCatalogItem = null;
    }

    function setupCatalogModal() {
        $('showCatalogModal').addEventListener('click', () => openCatalogModal());
        $('scanNewBarcodeBtn').addEventListener('click', () => startScanner($('newBarcode'), $('barcodeScannerViewport')));
        
        $('saveCatalogEdit').addEventListener('click', async () => {
            const data = { 
                itemName: $('editItemName').value, 
                itemRef: $('editItemRef').value, 
                unit: $('editUnit').value, 
                packSize: Number($('editPackSize').value) || 1, 
                parLevel: Number($('editParLevel').value) || 0,
                category: $('editCategorySelect').value,
                itemNameAlt: getListItems($('altNameList')), 
                barcode: getListItems($('barcodeList')), 
                isActive: currentCatalogItem.isActive, // Preserve existing state (only toggled by button)
                updatedAt: serverTimestamp() 
            };
            
            // Note: preferredVendorId is now saved via its own button
            
            if (currentCatalogItemId) { 
                await updateDoc(doc(db, "catalog", currentCatalogItemId), data); 
            } else { 
                data.createdAt = serverTimestamp();
                data.isActive = true; // New items are active by default
                await addDoc(collection(db, "catalog"), data); 
            }
            
            closeCatalogModal();
            await initializeStaticData(); // Refresh data
        });
        
        $('toggleActiveBtn').addEventListener('click', async () => {
            if (currentCatalogItemId && currentCatalogItem) {
                const newState = !currentCatalogItem.isActive;
                const action = newState ? 'activate' : 'inactivate';
                if (confirm(`Are you sure you want to ${action} this item?`)) {
                    await updateDoc(doc(db, "catalog", currentCatalogItemId), { isActive: newState });
                    closeCatalogModal();
                    await initializeStaticData();
                }
            }
        });
    }

    let currentPriceId = null;
    let currentCatalogIdForPricing = null;
    function openPricingModal(priceId = null, catalogId = null) {
        currentPriceId = priceId; 
        const price = priceId ? state.pricingAll.find(p => p.id === priceId) : {};
        currentCatalogIdForPricing = catalogId || price.catalogId; // Get ID from new item or existing price
        
        const itemSelect = $('priceItemSelect');
        const vendorSelect = $('priceVendorSelect');
        
        itemSelect.innerHTML = state.catalog.map(i => `<option value="${i.id}">${escapeHtml(i.itemName)}</option>`).join('');
        vendorSelect.innerHTML = state.vendors.map(v => `<option value="${v.id}">${escapeHtml(v.name)}</option>`).join('');
        
        if (priceId) { // Editing existing price
            itemSelect.value = price.catalogId;
            itemSelect.disabled = false;
            vendorSelect.value = price.vendorId;
            $('priceSku').value = price.vendorItemNo || ''; 
            $('priceUnitPrice').value = price.unitPrice || '';
            $('priceVendorStatus').value = price.vendorStatus || 'In Stock';
            $('pricingModalTitle').textContent = 'Edit Vendor Price';
        } else if (catalogId) { // Adding new price for a specific item
            itemSelect.value = catalogId;
            itemSelect.disabled = true; // Lock the item
            vendorSelect.value = '';
            $('priceSku').value = ''; 
            $('priceUnitPrice').value = '';
            $('priceVendorStatus').value = 'In Stock';
            $('pricingModalTitle').textContent = 'Add New Price';
        }
        
        $('pricingModal').style.display = 'flex';
    }

    function setupPricingModal() {
        $('savePricingEdit').addEventListener('click', async () => {
            const itemSelect = $('priceItemSelect');
            const vendorId = $('priceVendorSelect').value;
            const catalogId = itemSelect.value;
            
            const data = { 
                catalogId: catalogId, 
                vendorId: vendorId, 
                vendorItemNo: $('priceSku').value, 
                unitPrice: Number($('priceUnitPrice').value) || 0,
                vendorStatus: $('priceVendorStatus').value
            };
            
            if (!data.catalogId || !data.vendorId) {
                return alert("Please select an item and vendor.");
            }

            try {
                if (currentPriceId) { 
                    await updateDoc(doc(db, "vendorPricing", currentPriceId), data); 
                } else { 
                    await addDoc(collection(db, "vendorPricing"), data); 
                }
                
                $('pricingModal').style.display = 'none';
                itemSelect.disabled = false; // Always re-enable on close
                
                // Refresh catalog modal pricing if it's open
                if ($('catalogModal').style.display === 'flex' && currentCatalogIdForPricing) {
                     await initializeStaticData(); // Refresh state
                     openCatalogModal(currentCatalogIdForPricing); // Re-render modal
                }

            } catch (e) {
                console.error("Error saving price:", e);
                alert("Error saving. See console.");
            }
        });
    }

    function openChangeVendorModal(requestId) {
        currentRequestIdToChange = requestId;
        const request = state.requests.find(r => r.id === requestId);
        if (!request) return;
        
        const catItem = state.catalogMap.get(request.catalogId);
        $('changeVendorItemName').textContent = catItem ? catItem.itemName : 'This item';

        const vendorSelect = $('changeVendorSelect');
        vendorSelect.innerHTML = '<option value="">-- Select New Vendor --</option>' + 
                                 state.vendors.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
        
        $('changeVendorModal').style.display = 'flex';
    }

    function setupChangeVendorModal() {
        $('saveVendorOverrideBtn').addEventListener('click', async () => {
            const newVendorId = $('changeVendorSelect').value;
            if (!newVendorId || !currentRequestIdToChange) {
                return alert("Please select a vendor.");
            }
            
            try {
                await updateDoc(doc(db, 'requests', currentRequestIdToChange), {
                    overrideVendorId: newVendorId,
                    updatedAt: serverTimestamp()
                });
                $('changeVendorModal').style.display = 'none';
                currentRequestIdToChange = null;
            } catch (e) {
                console.error("Failed to override vendor:", e);
                alert("Error saving override.");
            }
        });
    }
    
    // Explicit management setup to avoid pluralization bugs
    function setupUnitActions() {
        $('unitsTable').addEventListener('click', async e => {
            if (e.target.id === 'addUnitBtn') {
                const name = $('newUnitName').value.trim();
                if (name) { 
                    await addDoc(collection(db, 'units'), { name }); 
                    $('newUnitName').value = ''; 
                    await initializeStaticData(); 
                }
            }
            if (e.target.dataset.deleteUnitId && confirm('Are you sure you want to delete this unit?')) {
                await deleteDoc(doc(db, 'units', e.target.dataset.deleteUnitId)); 
                await initializeStaticData();
            }
        });
    }
    function setupCompartmentActions() {
        $('compartmentsTable').addEventListener('click', async e => {
            if (e.target.id === 'addCompBtn') {
                const name = $('newCompName').value.trim();
                if (name) { 
                    await addDoc(collection(db, 'compartments'), { name }); 
                    $('newCompName').value = ''; 
                    await initializeStaticData(); 
                }
            }
            if (e.target.dataset.deleteCompId && confirm('Are you sure you want to delete this compartment?')) {
                await deleteDoc(doc(db, 'compartments', e.target.dataset.deleteCompId)); 
                await initializeStaticData();
            }
        });
    }
    function setupCategoryActions() {
        $('categoriesTable').addEventListener('click', async e => {
            if (e.target.id === 'addCategoryBtn') {
                const name = $('newCategoryName').value.trim();
                if (name) { 
                    await addDoc(collection(db, 'categories'), { name }); 
                    $('newCategoryName').value = ''; 
                    await initializeStaticData(); 
                }
            }
            if (e.target.dataset.deleteCategoryId && confirm('Are you sure you want to delete this category?')) {
                await deleteDoc(doc(db, 'categories', e.target.dataset.deleteCategoryId)); 
                await initializeStaticData();
            }
        });
    }
    
    function mountTabs() {
        const TABS = ['Orders', 'Catalog', 'Units', 'Compartments', 'Categories'];
        $('tabs').innerHTML = TABS.map(t => `<button class="tab" data-tab="${t.toLowerCase().replace(' ', '_')}">${t}</button>`).join('');
        $('tabs').addEventListener('click', (ev) => {
            const tabId = ev.target.dataset.tab; if (!tabId) return;
            document.querySelectorAll('.tab, .panel').forEach(el => el.classList.remove('active'));
            ev.target.classList.add('active'); $(`panel-${tabId}`).classList.add('active');
        });
        $('tabs').querySelector('[data-tab="orders"]').click();
    }

    async function boot() {
        mountTabs();
        setupAllModalsAndActions();
        
        ['refreshCatalog', 'refreshUnits', 'refreshCompartments', 'refreshCategories'].forEach(id => {
            const btn = $(id); if (btn) btn.addEventListener('click', initializeStaticData);
        });

        $('catSearch').addEventListener('input', renderCatalog);
        
        await initializeStaticData();
        setupRealtimeListeners();
    }
</script>
</body>
</html>