<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>EMS Supplies — Master Admin Dashboard</title>
  <script src="https://kwelch2.github.io/Inventory/quagga.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666;--ink:#111;--accent:#0a66ff;--bad:#b00020;--ok:#137333}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1400px;margin:0 auto;padding:16px}
    #login-container { max-width: 400px; margin: 2rem auto; }
    #app-container, #loading-container { display: none; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;}
    .auth-info { display: flex; align-items: center; gap: 1rem; }
    .nav-links { font-size: 0.9rem; }
    .nav-links a { color: #007bff; text-decoration: none; margin-left: 1rem; }
    .tabs{display:flex; flex-wrap: wrap; gap:8px;border-bottom:1px solid var(--b);position:sticky;top:0;background:var(--bg);padding:8px 0;z-index:5}
    .tab{padding:10px 14px;border:1px solid var(--b);border-bottom:none;border-radius:8px 8px 0 0;background:#eee;color:#333;cursor:pointer}
    .tab.active{background:var(--card);color:#000;border-bottom:1px solid var(--card)}
    .panel{display:none;background:var(--card);border:1px solid var(--b);border-radius:0 12px 12px 12px;padding:16px;margin-top:-1px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .panel.active{display:block}
    h1,h2{margin:0 0 10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap; margin-bottom: 1rem;}
    .btn{padding:8px 10px;border:1px solid var(--b);border-radius:10px;background:#fff;cursor:pointer; font-size: 0.9rem;}
    .btn:disabled { background: #eee; cursor: not-allowed; }
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.danger{background:var(--bad); color: white; border-color: var(--bad);}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-top:1px solid var(--b);text-align:left;vertical-align:top}
    th{background:#fafafa}
    input,select{padding:8px;border:1px solid var(--b);border-radius:8px; font-size: 1rem;}
    .kvd{font-size:12px;color:#555}
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center;}
    .modal-content { background-color: #fefefe; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 12px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .modal-body { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
    .modal-footer { margin-top: 1.5rem; text-align: right; }
    .barcode-item { display: flex; justify-content: space-between; align-items: center; background: #f0f0f0; padding: 4px 8px; border-radius: 6px; margin-bottom: 4px; }
    .viewport { position: relative; }
    .viewport video, .viewport .drawingBuffer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .price-info { font-size: 0.8rem; color: #555; }
    .best-price { color: var(--ok); font-weight: bold; }
    .details-row { display: none; }
    .details-row.visible { display: table-row; }
    .details-cell { padding: 1rem; background-color: #f9f9f9; }
  </style>
</head>
<body>
<div class="wrap">
  
  <div id="loading-container" style="text-align: center; margin-top: 3rem;">
      <p class="muted">Initializing...</p>
  </div>

  <div id="login-container" style="display: none;">
    <div class="card">
        <h2>Admin Login</h2>
        <button id="googleLoginBtn" class="btn primary" style="width: 100%;">Sign in with Google</button>
        <p id="auth-status-login" class="muted" style="text-align: center; margin-top: 1rem;">Please sign in with a gemfireems.org account.</p>
    </div>
  </div>

  <div id="app-container" style="display: none;">
    <div class="header">
        <h1>EMS Supplies — Master Admin</h1>
        <div class="nav-links">
            <a href="https://supplies-ems.web.app/">Home</a>
            <a href="requests.html">Supply Requests</a>
            <a href="expiry3.html">Expiring</a>
            <a href="https://chores-ems.gemfireems.org/">Chores</a>
            <a href="https://chores-ems.gemfireems.org/issues">Issues</a>
        </div>
    </div>
    <div class="auth-info" style="margin-bottom: 1rem;">
        <span id="auth-status-main" class="muted"></span>
        <button id="logoutBtn" class="btn">Logout</button>
    </div>
    <div class="tabs" id="tabs"></div>

      <section id="panel-orders" class="panel">
        <h2>Orders & Requests</h2>
        <div class="row">
            <button class="btn primary" id="showAddItemModal">+ Add Item to Order</button>
            <span class="spacer"></span>
            <strong style="margin-left: 2rem;">Filter by Status:</strong>
            <button class="btn filter-btn active" data-status="Open">Open</button>
            <button class="btn filter-btn" data-status="Ordered">Ordered</button>
            <button class="btn filter-btn" data-status="Backordered">Backordered</button>
            <label style="margin-left:1rem; font-weight:normal;"><input type="checkbox" id="showHistoryToggle"> Show History</label>
        </div>
        <div id="ordersTableContainer"></div>
      </section>
      
      <section id="panel-catalog" class="panel">
        <h2>Catalog Manager <span class="kvd" id="kvCatalog"></span></h2>
        <div class="row"><button class="btn" id="refreshCatalog">Refresh</button><button class="btn primary" id="showCatalogModal">Add New Item</button><span style="flex: 1;"></span><input id="catSearch" placeholder="Search..."/></div>
        <div id="catalogTable"></div>
      </section>
      
      <section id="panel-pricing" class="panel">
        <h2>Vendor Pricing <span class="kvd" id="kvPricing"></span></h2>
        <div class="row"><button class="btn" id="refreshPricing">Refresh</button><button class="btn primary" id="showPricingModal">Add New Price</button></div>
        <div id="pricingTable"></div>
      </section>

      <section id="panel-units" class="panel">
        <h2>Unit Management <span class="kvd" id="kvUnits"></span></h2>
        <div class="row"><button class="btn" id="refreshUnits">Refresh</button></div>
        <div id="unitsTable"></div>
      </section>

      <section id="panel-compartments" class="panel">
        <h2>Compartment Management <span class="kvd" id="kvCompartments"></span></h2>
        <div class="row"><button class="btn" id="refreshCompartments">Refresh</button></div>
        <div id="compartmentsTable"></div>
      </section>
  </div>
</div>

<div id="addItemToOrderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Add Item to Order List</h2></div>
      <div class="modal-body">
        <label>Item <select id="addItemSelect"></select></label>
        <label>Quantity <input id="addItemQty" type="text" placeholder="e.g., 1 Box or 5"></label>
      </div>
      <div class="modal-footer">
        <button class="btn" id="cancelAddItemBtn">Cancel</button>
        <button class="btn primary" id="saveAddItemBtn">Add Item</button>
      </div>
    </div>
</div>

<div id="catalogModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h2 id="catalogModalTitle">Edit Catalog Item</h2></div>
    <div class="modal-body">
      <label>Item Name <input id="editItemName"></label>
      <label>Alt Names <input id="editItemNameAlt"></label>
      <label>Category <input id="editCategory"></label>
      <label>Item Ref # <input id="editItemRef"></label>
      <label>Unit <input id="editUnit"></label>
      <label>Pack Size <input id="editPackSize" type="number" min="1"></label>
      <label style="display: flex; align-items: center; gap: 8px;"><input id="editIsActive" type="checkbox"> Is Active</label>
      <div style="grid-column: 1 / -1;">
        <label>Barcodes</label>
        <div id="barcodeList" style="margin-bottom: 8px; max-height: 120px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; border-radius: 8px;"></div>
        <div class="row" style="margin-bottom: 0;">
            <input id="newBarcode" placeholder="Add new barcode..." style="flex: 1;">
            <button id="scanNewBarcodeBtn" class="btn">Scan</button>
            <button id="addNewBarcodeBtn" class="btn primary">Add</button>
        </div>
        <div id="barcodeScannerViewport" class="viewport" style="display:none; width:100%; height:240px; border:1px solid #ccc; background:#000; margin-top:1rem;"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="cancelCatalogEdit">Cancel</button>
      <button class="btn danger" id="inactivateCatalogItem" style="float: left;">Inactivate</button>
      <button class="btn primary" id="saveCatalogEdit">Save Changes</button>
    </div>
  </div>
</div>

<div id="pricingModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="pricingModalTitle">Add/Edit Vendor Price</h2></div>
      <div class="modal-body">
        <label>Item <select id="priceItemSelect"></select></label>
        <label>Vendor <select id="priceVendorSelect"></select></label>
        <label>Vendor SKU <input id="priceSku"></label>
        <label>Unit Price <input id="priceUnitPrice" type="number" step="0.01"></label>
      </div>
      <div class="modal-footer">
        <button class="btn" id="cancelPricingEdit">Cancel</button>
        <button class="btn primary" id="savePricingEdit">Save Price</button>
      </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, writeBatch, serverTimestamp, query, where, orderBy, onSnapshot, initializeFirestore, persistentLocalCache } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD7pMc-AHXb1cApzSfImkWvIjM9iwCoym4",
        authDomain: "supplies-ems.firebaseapp.com",
        projectId: "supplies-ems",
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = initializeFirestore(app, { 
        localCache: persistentLocalCache({ tabManager: "PRIMARY" }) 
    });

    let state = { user: null, userRole: null, catalog: [], vendors: [], pricingAll: [], requests: [], units: [], compartments: [], catalogMap: new Map(), vendorMap: new Map(), pricingMap: new Map() };
    let addItemChoices;
    const $ = id => document.getElementById(id);
    let appInitialized = false;
    let isScannerActive = false;

    $("loading-container").style.display = "block";

    onAuthStateChanged(auth, async (user) => {
        if (user) await handleUserSignedIn(user);
        else handleUserSignedOut();
    });

    $("googleLoginBtn").addEventListener("click", () => {
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({
            'hd': 'gemfireems.org',
            'oauth_web_client_id': '649560661195-m4c2sa1bncop9jnhajpvfum5dal3iqha.apps.googleusercontent.com'
        });
        signInWithPopup(auth, provider).catch((error) => console.error("Popup Sign-in Error:", error));
    });

    async function handleUserSignedIn(user) {
        if (!user.email.endsWith('@gemfireems.org')) {
            alert("Access denied. Please use a valid gemfireems.org email account.");
            return signOut(auth);
        }
        try {
            const userDocSnap = await getDoc(doc(db, "users", user.uid));
            state.userRole = userDocSnap.exists() ? userDocSnap.data().role : "Staff";
            if (!userDocSnap.exists()) await setDoc(doc(db, "users", user.uid), { email: user.email, role: "Staff" });
            
            state.user = user;
            $("auth-status-main").textContent = `${user.email} (${state.userRole})`;
            $("app-container").style.display = "block";
            $("login-container").style.display = "none";
            $("loading-container").style.display = "none";
            
            if (!appInitialized) {
                appInitialized = true;
                await boot();
            }
            applyPermissions(state.userRole);
        } catch (error) {
            console.error("Error handling signed-in user:", error);
            alert("Permission Error: Could not read user data.");
            signOut(auth);
        }
    }
    
    function applyPermissions(role) {
        const isAdmin = (role === 'Admin');
        document.querySelectorAll('.btn.danger').forEach(btn => {
            btn.style.display = isAdmin ? 'inline-block' : 'none';
        });
    }

    function handleUserSignedOut() {
        state.user = null;
        $("app-container").style.display = "none";
        $("login-container").style.display = "block";
        $("loading-container").style.display = "none";
        appInitialized = false;
    }

    $("logoutBtn").addEventListener("click", () => signOut(auth));

    async function initializeStaticData() {
        try {
            const [catSnap, venSnap, unitSnap, compSnap] = await Promise.all([
                getDocs(collection(db, "catalog")),
                getDocs(collection(db, "vendors")),
                getDocs(collection(db, "units")),
                getDocs(collection(db, "compartments"))
            ]);
            
            state.catalog = catSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            state.vendors = venSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            state.units = unitSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            state.compartments = compSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            state.catalogMap = new Map(state.catalog.map(c => [c.id, c]));
            state.vendorMap = new Map(state.vendors.map(v => [v.id, v.name]));
            
            renderCatalog();
            renderUnits();
            renderCompartments();
        } catch(e) {
            console.error("Static Data Load Failed:", e);
            alert("Could not load static data. Check Firestore rules and collection names.");
        }
    }

    function setupRealtimeListeners() {
        onSnapshot(collection(db, "requests"), (reqSnap) => {
            state.requests = reqSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderOrders();
        });

        onSnapshot(collection(db, "vendorPricing"), (priceSnap) => {
            state.pricingAll = priceSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            state.pricingMap.clear();
            state.pricingAll.forEach(p => {
                if (!state.pricingMap.has(p.catalogId)) state.pricingMap.set(p.catalogId, []);
                state.pricingMap.get(p.catalogId).push(p);
            });
            renderPricing();
            renderOrders(); 
        });
    }
    
     function renderOrders() {
        const container = $('ordersTableContainer');
        const showHistory = $('showHistoryToggle').checked;
        const activeFilter = document.querySelector('.filter-btn.active')?.dataset.status || 'Open';
        
        const requestsToShow = state.requests.filter(r => {
            const status = r.status || 'Open';
            if (showHistory) {
                return status === 'Received' || status === 'Completed';
            }
            return status === activeFilter;
        });
        
        const rows = requestsToShow.map(r => {
            const catItem = state.catalogMap.get(r.catalogId);
            if (!catItem) return ''; 

            const prices = (state.pricingMap.get(r.catalogId) || []).sort((a,b) => a.unitPrice - b.unitPrice);
            const bestPrice = prices[0];
            
            const otherPricesHtml = prices.slice(1).map(p => `<div>${state.vendorMap.get(p.vendorId)}: $${p.unitPrice.toFixed(2)} (SKU: ${p.vendorItemNo || 'N/A'})</div>`).join('');

            return `
                <tr data-request-id="${r.id}">
                    <td>
                        <strong>${catItem.itemName}</strong><br>
                        <span class="muted">${r.requesterEmail || 'N/A'}</span>
                    </td>
                    <td>${r.qty}</td>
                    <td>
                        <div class="price-info ${bestPrice ? 'best-price' : ''}">
                            ${bestPrice ? `${state.vendorMap.get(bestPrice.vendorId)}: $${bestPrice.unitPrice.toFixed(2)}` : 'No pricing'}
                            <button class="btn" data-toggle-details style="margin-left: 8px; padding: 2px 6px;">▼</button>
                        </div>
                    </td>
                    <td>${bestPrice?.vendorItemNo || 'N/A'}</td>
                    <td>
                        <button class="btn" data-status="Ordered">Ordered</button>
                        <button class="btn" data-status="Received">Received</button>
                        <select data-status-more>
                            <option value="">More...</option>
                            <option value="Backordered">Backordered</option>
                            <option value="Open">Reset to Open</option>
                        </select>
                    </td>
                </tr>
                <tr class="details-row" data-details-for="${r.id}">
                    <td colspan="5" class="details-cell">
                        <strong>All Prices:</strong>
                        ${otherPricesHtml || '<div class="muted">No other prices found.</div>'}
                        <div style="margin-top: 8px;">
                            <strong>Last Ordered:</strong> <span class="muted">${r.lastOrdered ? new Date(r.lastOrdered.seconds * 1000).toLocaleDateString() : 'N/A'}</span>
                        </div>
                        <div style="margin-top: 8px;">
                            <input type="number" step="0.01" placeholder="New Price" class="edit-price-input" style="width: 100px;"/>
                            <select class="edit-price-vendor-select">${state.vendors.map(v => `<option value="${v.id}">${v.name}</option>`).join('')}</select>
                            <button class="btn primary" data-edit-price>Update Price</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        container.innerHTML = `
            <table>
                <thead><tr><th>Item/Requester</th><th>Qty</th><th>Vendor (Lowest Price)</th><th>SKU</th><th>Actions</th></tr></thead>
                <tbody>${rows || `<tr><td colspan="5" class="muted">No requests found.</td></tr>`}</tbody>
            </table>`;
    }

    $('ordersTableContainer').addEventListener('click', async e => {
        const target = e.target;
        const row = target.closest('tr[data-request-id]');
        if (!row) return;
        const requestId = row.dataset.requestId;

        if (target.dataset.toggleDetails) {
            const detailsRow = document.querySelector(`[data-details-for="${requestId}"]`);
            if (detailsRow) {
                detailsRow.classList.toggle('visible');
            }
        }

        if (target.dataset.status) {
            await updateRequestStatus(requestId, target.dataset.status);
        }
        
        if (target.dataset.editPrice) {
            const detailsCell = target.closest('.details-cell');
            const priceInput = detailsCell.querySelector('.edit-price-input');
            const vendorSelect = detailsCell.querySelector('.edit-price-vendor-select');
            const newPrice = parseFloat(priceInput.value);
            const vendorId = vendorSelect.value;
            const request = state.requests.find(r => r.id === requestId);
            
            if (!request || !vendorId || isNaN(newPrice)) {
                return alert('Please select a vendor and enter a valid price.');
            }
            
            const pricingDoc = state.pricingAll.find(p => p.catalogId === request.catalogId && p.vendorId === vendorId);
            if (pricingDoc) {
                await updateDoc(doc(db, 'vendorPricing', pricingDoc.id), { unitPrice: newPrice });
                alert('Price updated!');
            } else {
                alert('No existing price document for this item/vendor combo. Please add it in the "Vendor Pricing" tab.');
            }
        }
    });

    function renderCatalog() {
        const query = $('catSearch').value.toLowerCase();
        const filtered = state.catalog.filter(i => (i.itemName || '').toLowerCase().includes(query) || (i.itemNameAlt || '').toLowerCase().includes(query));
        $('kvCatalog').textContent = `(${filtered.length})`;
        const rows = filtered.map(i => `<tr style="${i.isActive === false ? 'opacity: 0.5; text-decoration: line-through;' : ''}"><td>${i.itemName || ''}</td><td>${i.itemNameAlt || ''}</td><td>${i.category || ''}</td><td>${i.itemRef || ''}</td><td><button class="btn" data-edit-id="${i.id}">Edit</button></td></tr>`).join('');
        $('catalogTable').innerHTML = `<table><thead><tr><th>Name</th><th>Alt Name</th><th>Category</th><th>Ref #</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
    }
    
    function renderPricing() {
        $('kvPricing').textContent = `(${state.pricingAll.length})`;
        const rows = state.pricingAll.map(p => `<tr><td>${state.catalogMap.get(p.catalogId)?.itemName || ''}</td><td>${state.vendorMap.get(p.vendorId) || ''}</td><td>${p.vendorItemNo || ''}</td><td>$${Number(p.unitPrice || 0).toFixed(2)}</td><td><button class="btn" data-edit-price-id="${p.id}">Edit</button></td></tr>`).join('');
        $('pricingTable').innerHTML = `<table><thead><tr><th>Item</th><th>Vendor</th><th>SKU</th><th>Price</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderUnits() {
        $('kvUnits').textContent = `(${state.units.length})`;
        const rows = state.units.map(u => `<tr><td>${u.name}</td><td>${u.id}</td><td><button class="btn danger" data-delete-unit-id="${u.id}">Delete</button></td></tr>`).join('');
        $('unitsTable').innerHTML = `<div class="row"><input id="newUnitName" placeholder="New Unit Name"><button id="addUnitBtn" class="btn primary">Add Unit</button></div><table><thead><tr><th>Name</th><th>ID</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderCompartments() {
        $('kvCompartments').textContent = `(${state.compartments.length})`;
        const rows = state.compartments.map(c => `<tr><td>${c.name}</td><td><button class="btn danger" data-delete-comp-id="${c.id}">Delete</button></td></tr>`).join('');
        $('compartmentsTable').innerHTML = `<div class="row"><input id="newCompName" placeholder="New Compartment Name"><button id="addCompBtn" class="btn primary">Add Compartment</button></div><table><thead><tr><th>Name</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function startScanner(targetInput, viewportElement) {
        if (isScannerActive) {
            Quagga.stop();
            isScannerActive = false;
            viewportElement.style.display = 'none';
            return;
        }
        viewportElement.style.display = 'block';
        Quagga.init({ inputStream: { name: "Live", type: "LiveStream", target: viewportElement, constraints: { facingMode: "environment" } }, decoder: { readers: ["code_128_reader", "ean_reader", "upc_reader"] }}, (err) => {
            if (err) { console.error("Quagga Error:", err); viewportElement.style.display = 'none'; return; }
            Quagga.start();
            isScannerActive = true;
        });
        Quagga.onDetected(result => {
            Quagga.stop();
            isScannerActive = false;
            viewportElement.style.display = 'none';
            if (result && result.codeResult) targetInput.value = result.codeResult.code;
        });
    }
    
    function setupAllModalsAndActions() {
        setupCatalogModal(); 
        setupPricingModal(); 
        setupAddItemToOrderModal();

        document.querySelector('#panel-orders .row').addEventListener('click', e => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderOrders();
            }
        });

        $('showHistoryToggle').addEventListener('change', renderOrders);
        
        $('ordersTableContainer').addEventListener('change', async e => {
            const target = e.target;
            if (target.dataset.statusMore) {
                const newStatus = target.value;
                const requestId = target.closest('tr').dataset.requestId;
                if (newStatus && requestId) {
                    await updateRequestStatus(requestId, newStatus);
                }
                target.value = ''; // Reset dropdown
            }
        });

        setupUnitActions(); 
        setupCompartmentActions();
    }

    async function updateRequestStatus(requestId, newStatus) {
        if (!requestId || !newStatus) return;
        const updatePayload = { status: newStatus, updatedAt: serverTimestamp() };
        if (newStatus === 'Received') updatePayload.receivedAt = serverTimestamp();
        if (newStatus === 'Ordered') updatePayload.lastOrdered = serverTimestamp();
        
        try {
            await updateDoc(doc(db, 'requests', requestId), updatePayload);
        } catch(e) {
            console.error("Status update failed:", e);
            alert("Could not update status.");
        }
    }
    
    function setupAddItemToOrderModal() {
        const modal = $('addItemToOrderModal');
        const itemElement = $('addItemSelect');
        if (addItemChoices) addItemChoices.destroy();
        addItemChoices = new Choices(itemElement, { searchEnabled: true, placeholderValue: 'Select an item to add...' });

        $('showAddItemModal').addEventListener('click', () => {
            const options = state.catalog.filter(c=>c.isActive !== false).map(c=>({value: c.id, label: c.itemName}));
            addItemChoices.setChoices(options, 'value', 'label', true);
            modal.style.display = 'flex';
        });

        $('cancelAddItemBtn').addEventListener('click', () => modal.style.display = 'none');
        $('saveAddItemBtn').addEventListener('click', async () => {
            const catalogId = addItemChoices.getValue(true);
            const qty = $('addItemQty').value;
            if (!catalogId || !qty) {
                return alert('Please select an item and quantity.');
            }
            if (!state.user || !state.user.email) {
                return alert('Cannot add item: user is not properly logged in.');
            }
            const payload = {
                catalogId,
                qty,
                status: 'Open',
                createdAt: serverTimestamp(),
                requesterEmail: state.user.email,
            };
            await addDoc(collection(db, 'requests'), payload);
            modal.style.display = 'none';
        });
    }
    
    function setupCatalogModal() {
        let currentItemId = null; const barcodeList = $('barcodeList');
        const renderBarcodeList = (barcodes = []) => {
            barcodeList.innerHTML = ''; const barcodeArray = Array.isArray(barcodes) ? barcodes : (barcodes ? [barcodes] : []);
            barcodeArray.forEach(code => {
                const item = document.createElement('div'); item.className = 'barcode-item';
                item.innerHTML = `<span class="barcode-item-text">${code}</span><button class="btn danger" style="padding: 2px 6px;">&times;</button>`;
                barcodeList.appendChild(item);
            });
        };
        const openModal = (itemId = null) => {
            currentItemId = itemId; const item = itemId ? state.catalog.find(i => i.id === itemId) : {};
            $('catalogModalTitle').textContent = itemId ? 'Edit Catalog Item' : 'Add New Catalog Item';
            $('editItemName').value = item.itemName || ''; $('editItemNameAlt').value = item.itemNameAlt || '';
            $('editCategory').value = item.category || ''; $('editItemRef').value = item.itemRef || '';
            $('editUnit').value = item.unit || ''; $('editPackSize').value = item.packSize || 1;
            $('editIsActive').checked = item.isActive !== false;
            $('inactivateCatalogItem').style.display = itemId ? 'inline-block' : 'none';
            renderBarcodeList(item.barcode);
            applyPermissions(state.userRole);
            $('catalogModal').style.display = 'flex';
        };
        $('showCatalogModal').addEventListener('click', () => openModal());
        $('catalogTable').addEventListener('click', e => { const id = e.target.dataset.editId; if (id) openModal(id); });
        $('cancelCatalogEdit').addEventListener('click', () => { if (isScannerActive) Quagga.stop(); isScannerActive = false; $('barcodeScannerViewport').style.display = 'none'; $('catalogModal').style.display = 'none'; });
        $('addNewBarcodeBtn').addEventListener('click', () => {
            const newCode = $('newBarcode').value.trim();
            if (newCode) { const item = document.createElement('div'); item.className = 'barcode-item'; item.innerHTML = `<span class="barcode-item-text">${newCode}</span><button class="btn danger" style="padding: 2px 6px;">&times;</button>`; barcodeList.appendChild(item); $('newBarcode').value = ''; }
        });
        barcodeList.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') e.target.parentElement.remove(); });
        $('scanNewBarcodeBtn').addEventListener('click', () => startScanner($('newBarcode'), $('barcodeScannerViewport')));
        $('saveCatalogEdit').addEventListener('click', async () => {
            const barcodes = Array.from(document.querySelectorAll('#barcodeList .barcode-item-text')).map(el => el.textContent);
            const data = { itemName: $('editItemName').value, itemNameAlt: $('editItemNameAlt').value, category: $('editCategory').value, itemRef: $('editItemRef').value, unit: $('editUnit').value, packSize: Number($('editPackSize').value) || 1, barcode: barcodes, isActive: $('editIsActive').checked, updatedAt: serverTimestamp() };
            if (currentItemId) { await updateDoc(doc(db, "catalog", currentItemId), data); } else { await addDoc(collection(db, "catalog"), data); }
            $('catalogModal').style.display = 'none'; await initializeStaticData();
        });
        $('inactivateCatalogItem').addEventListener('click', async () => {
            if (currentItemId && confirm('Are you sure you want to mark this item as inactive?')) {
                await updateDoc(doc(db, "catalog", currentItemId), { isActive: false });
                $('catalogModal').style.display = 'none';
                await initializeStaticData();
            }
        });
    }
    function setupPricingModal() {
        let currentPriceId = null;
        const openModal = (priceId = null) => {
            currentPriceId = priceId; const price = priceId ? state.pricingAll.find(p => p.id === priceId) : {};
            $('priceItemSelect').innerHTML = state.catalog.map(i => `<option value="${i.id}" ${price.catalogId === i.id ? 'selected' : ''}>${i.itemName}</option>`).join('');
            $('priceVendorSelect').innerHTML = state.vendors.map(v => `<option value="${v.id}" ${price.vendorId === v.id ? 'selected' : ''}>${v.name}</option>`).join('');
            $('priceSku').value = price.vendorItemNo || ''; $('priceUnitPrice').value = price.unitPrice || '';
            $('pricingModalTitle').textContent = priceId ? 'Edit Vendor Price' : 'Add New Price';
            $('pricingModal').style.display = 'flex';
        };
        $('showPricingModal').addEventListener('click', () => openModal());
        $('pricingTable').addEventListener('click', e => { const id = e.target.dataset.editPriceId; if (id) openModal(id); });
        $('cancelPricingEdit').addEventListener('click', () => $('pricingModal').style.display = 'none');
        $('savePricingEdit').addEventListener('click', async () => {
            const data = { catalogId: $('priceItemSelect').value, vendorId: $('priceVendorSelect').value, vendorItemNo: $('priceSku').value, unitPrice: Number($('priceUnitPrice').value) || 0 };
            if (currentPriceId) { await updateDoc(doc(db, "vendorPricing", currentPriceId), data); } else { await addDoc(collection(db, "vendorPricing"), data); }
            $('pricingModal').style.display = 'none';
        });
    }
    function setupUnitActions() {
        $('unitsTable').addEventListener('click', async e => {
            if (e.target.id === 'addUnitBtn') { const name = $('newUnitName').value.trim(); if (name) { await addDoc(collection(db, "units"), { name }); $('newUnitName').value = ''; await initializeStaticData(); }}
        });
    }
    function setupCompartmentActions() {
        $('compartmentsTable').addEventListener('click', async e => {
            if (e.target.id === 'addCompBtn') { const name = $('newCompName').value.trim(); if (name) { await addDoc(collection(db, "compartments"), { name }); $('newCompName').value = ''; await initializeStaticData(); }}
        });
    }
    
    function mountTabs() {
        const TABS = ['Orders', 'Catalog', 'Pricing', 'Units', 'Compartments'];
        $('tabs').innerHTML = TABS.map(t => `<button class="tab" data-tab="${t.toLowerCase().replace(' ', '_')}">${t}</button>`).join('');
        $('tabs').addEventListener('click', (ev) => {
            const tabId = ev.target.dataset.tab; if (!tabId) return;
            document.querySelectorAll('.tab, .panel').forEach(el => el.classList.remove('active'));
            ev.target.classList.add('active'); $(`panel-${tabId}`).classList.add('active');
        });
        $('tabs').querySelector('[data-tab="orders"]').click();
    }
    async function boot() {
        mountTabs();
        setupAllModalsAndActions();
        
        ['refreshCatalog', 'refreshPricing', 'refreshUnits', 'refreshCompartments'].forEach(id => {
            const btn = $(id); if (btn) btn.addEventListener('click', initializeStaticData);
        });

        $('catSearch').addEventListener('input', renderCatalog);
        
        await initializeStaticData();
        setupRealtimeListeners();
    }
</script>
</body>
</html>