<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Expiring Supplies – GC EMS</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--b:#ddd;--muted:#666;--ok:#e7f7ee;--warn:#fff7e6;--bad:#fdecea}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
  h1{margin:0 0 6px}
  .muted{color:var(--muted);font-size:.9rem}
  .toolbar{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
  select,button,input{padding:8px 10px;border:1px solid var(--b);border-radius:10px;background:#fff}
  button{cursor:pointer}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  th{font-weight:600;background:#fafafa}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--b);font-size:.8rem}
  .ok{background:var(--ok)} .warn{background:var(--warn)} .bad{background:var(--bad)}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .btn{padding:6px 10px;border:1px solid var(--b);border-radius:10px;background:#fafafa}
  .btn.red{border-color:#c00} .btn.yellow{border-color:#c90} .btn.green{border-color:#090}
  .right{text-align:right}
  .spacer{flex:1}
  .modal{display:none;position:fixed;z-index:99;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.35)}
  .modal-content{background:#fff;margin:10% auto;padding:16px;border:1px solid var(--b);width:min(540px,92%);border-radius:12px}
  .close-btn{float:right;font-size:24px;cursor:pointer}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .chipbar{display:flex;gap:6px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Expiring Supplies</h1>
    <div class="muted">Typed JSON from Apps Script; no CSV parsing. Server computes Days to Expire.</div>
    <div class="toolbar">
      <label>Window
        <select id="rangeSel">
          <option value="30">30 days</option>
          <option value="60">60 days</option>
          <option value="90" selected>90 days</option>
          <option value="120">120 days</option>
        </select>
      </label>
      <label>Unit
        <select id="unitSel"><option value="ALL">ALL</option></select>
      </label>
          <input id="searchBox" placeholder="Search item, compartment…"/>
      <button class="btn" id="refreshBtn">Refresh</button>
      <span class="spacer"></span>
      <button class="btn" id="showAddItemModal">+ Add Item</button>
      <span id="count" class="muted"></span>
    </div>
  </div>

  <div id="content" class="card"></div>
</div>

<!-- Add Item Modal -->
<div id="addItemModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h3>Add Item to Inventory</h3>
    <div class="grid2">
      <div>
        <label>Item</label>
        <input id="addItemInput" list="itemsDatalist" placeholder="Start typing name…" />
        <datalist id="itemsDatalist"></datalist>
      </div>
      <div>
        <label>Compartment</label>
        <select id="addCompartmentSelect">
          <option value="">Select…</option>
          <option>Wall</option>
          <option>Bag</option>
          <option>Supply RM</option>
        </select>
      </div>
      <div>
        <label>Expiry Month</label>
        <div id="addExpiryChips" class="chipbar"></div>
      </div>
      <div>
        <label>Quantity</label>
        <input id="addQty" type="number" min="1" step="1" value="1"/>
      </div>
    </div>
    <button id="saveNewItemBtn" class="btn" style="width:100%;margin-top:12px;">Save Item</button>
  </div>
</div>

<script>
// ===== CONFIG =====
const PROXY_URL = 'https://ems-inventory-proxy.kylewelch33.workers.dev'; // no trailing slash
const TOKEN     = '9mB4zR7kP2fW6vNqE1jH8aLcV5gT_sYx0uI-oZ3pD9bX4wK7eS6hF-EMS';

// ===== UTIL =====
const $ = s => document.querySelector(s);
const escapeHtml = s => (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

// Row class from days + status (Pending highlighted; OK/Replaced filtered out server-side)
function rowClass(days, status){
  if ((status||'').toLowerCase()==='pending') return 'warn';
  if (days != null){
    if (days < 0) return 'bad';
    if (days <= 30) return 'warn';
  }
  return 'ok';
}

// ===== STATE =====
let units=[], rows=[], catalog=[]; // catalog used for Add Item search

// ===== DATA LOAD =====
function readWithin(){
  const sel = $('#rangeSel').value;
  if (sel === 'CUSTOM') {
    const v = parseInt($('#customDays').value || '0', 10);
    return isNaN(v) || v < 0 ? 0 : v;
  }
  return sel === 'ALL' ? 'ALL' : parseInt(sel, 10);
}

async function loadAll() {
  const within = readWithin();
  const unit   = $('#unitSel')?.value || 'ALL';

  // Build expiring URL
  const url = new URL(PROXY_URL);
  url.searchParams.set('action','expiring');
  url.searchParams.set('within', within === 'ALL' ? 'ALL' : String(within));
  url.searchParams.set('unit', unit);
  url.searchParams.set('showResolved','false');

  const [inv, un, cat] = await Promise.all([
    fetch(url.toString()).then(r=>r.json()),
    fetch(`${PROXY_URL}?action=listunits`).then(r=>r.json()),
    fetch(`${PROXY_URL}?action=listcatalog`).then(r=>r.json())
  ]);
  if (!inv.ok) throw new Error(inv.error || 'expiring failed');
  if (!un.ok)  throw new Error(un.error  || 'units failed');
  if (!cat.ok) throw new Error(cat.error || 'catalog failed');

  rows    = inv.rows || [];
  units   = un.rows  || [];
  catalog = cat.rows || [];
}

// ===== RENDER =====
function fillUnitSelect() {
  const sel = $('#unitSel'); if (!sel) return;
  const prev = sel.value || 'ALL';
  const unitIds   = Array.from(new Set(rows.map(r => String(r.Unit||'').trim()))).filter(Boolean);
  const unitNames = new Map(units.map(u => [String(u.Unit||'').trim(), String(u.Display||'').trim()]));
  const unique = Array.from(new Set([...unitIds, ...units.map(u=>String(u.Unit||'').trim())])).filter(Boolean).sort();
  const options = ['ALL', ...unique].map(u => `<option value="${u}">${u==='ALL'?'ALL':(unitNames.get(u)||u)}</option>`).join('');
  sel.innerHTML = options;
  sel.value = options.includes(`value="${prev}"`) ? prev : 'ALL';
}

function render() {
  const q = ($('#searchBox').value||'').toLowerCase();
  const unitFilter = $('#unitSel').value;

  // Filter
  let list = rows.filter(r=>{
    if (unitFilter !== 'ALL' && String(r.Unit).toUpperCase() !== String(unitFilter).toUpperCase()) return false;
    const hay = `${r.ItemName||''} ${r.ItemRef||''} ${r.Category||''} ${r.Compartment||''}`.toLowerCase();
    if (q && !hay.includes(q)) return false;
    return true;
  });

  // Sort: Days ASC → UnitDisplay (when ALL) → ItemName
  list = list.sort((a,b)=>{
    const ax=a.DaysToExpire??1e9, bx=b.DaysToExpire??1e9;
    if (ax!==bx) return ax-bx;
    const ua=a.UnitDisplay||a.Unit||'', ub=b.UnitDisplay||b.Unit||'';
    if ($('#unitSel').value==='ALL' && ua!==ub) return ua.localeCompare(ub);
    return (a.ItemName||'').localeCompare(b.ItemName||'');
  });

  $('#count').textContent = `${list.length} item(s)`;

  const showUnitCol = ($('#unitSel').value === 'ALL');
  const html = `
    <table>
      <thead><tr>
        <th style="width:30%">Item</th>
        ${showUnitCol?'<th>Unit</th>':''}
        <th>Compartment</th>
        <th>Qty</th>
        <th>Expiry</th>
        <th class="right">Days</th>
        <th>Actions</th>
      </tr></thead>
      <tbody>
        ${list.map(r=>{
          const cls = rowClass(r.DaysToExpire, r.Status);
          const ref = r.ItemRef ? `<span class="muted">${escapeHtml(r.ItemRef)}</span>` : '';
          const unitDisp = r.UnitDisplay || r.Unit || '';
          const note = r.CrewStatus || '';
          return `
            <tr class="${cls}" data-id="${encodeURIComponent(r.InventoryID)}">
              <td><strong>${escapeHtml(r.ItemName||'')}</strong><br>${ref}</td>
              ${showUnitCol?`<td>${escapeHtml(unitDisp)}</td>`:''}
              <td>${escapeHtml(r.Compartment||'')}</td>
              <td>${(r.Qty??'')!==''?escapeHtml(String(r.Qty)):'—'}</td>
              <td>${escapeHtml(r.Expiry||'')}</td>
              <td class="right">${r.DaysToExpire??''}</td>
              <td>
                <div class="actions" style="gap:8px;align-items:center;">
                  <input type="text" class="crew-note" placeholder="note…" value="${escapeHtml(note)}" style="min-width:140px;">
                  <button class="btn pending">Pending</button>
                  <button class="btn green ok">OK</button>
                  <button class="btn red replaced">Replaced</button>
                </div>
              </td>
            </tr>`;
        }).join('')}
      </tbody>
    </table>`;
  $('#content').innerHTML = html;

  // Wire row actions
  $('#content').querySelectorAll('tr[data-id]').forEach(tr=>{
    const id = decodeURIComponent(tr.dataset.id);
    const noteInput = tr.querySelector('.crew-note');
    const doUpdate = async (status) => {
      const crewStatus = noteInput.value.trim();
      try{
        await postUpdate({ inventoryId: id, status, crewStatus });
        if (status==='OK' || status==='Replaced'){
          tr.remove();
          $('#count').textContent = `${$('#content tbody').children.length} item(s)`;
        } else {
          tr.classList.add('warn');
        }
      }catch(e){
        console.error(e);
        alert('Update failed');
      }
    };
    tr.querySelector('button.pending')  .addEventListener('click', ()=>doUpdate('Pending'));
    tr.querySelector('button.ok')       .addEventListener('click', ()=>doUpdate('OK'));
    tr.querySelector('button.replaced') .addEventListener('click', ()=>doUpdate('Replaced'));
  });
}

function updateDatalist(){
  // Prefer distinct ItemName, but allow alt names; the input stores the visible name only.
  const names = new Set();
  const opts = [];
  for (const r of catalog){
    const nm = String(r.ItemName||'').trim();
    const alt= String(r.ItemNameAlt||'').trim();
    if (nm && !names.has(nm)) { names.add(nm); opts.push(nm); }
    if (alt && !names.has(alt)) { names.add(alt); opts.push(alt); }
  }
  $('#itemsDatalist').innerHTML = opts.map(v => `<option value="${escapeHtml(v)}">`).join('');
}

// ===== UI wiring (including Add Item modal) =====
function wireUI(){
  // Range options: add Custom + All
  const rangeSel = $('#rangeSel');
  if (![...rangeSel.options].some(o=>o.value==='CUSTOM')) {
    rangeSel.insertAdjacentHTML('beforeend', `<option value="CUSTOM">Custom…</option><option value="ALL">All</option>`);
  }

  // custom input
  const customInput = document.createElement('input');
  customInput.type = 'number'; customInput.min = '0'; customInput.placeholder = 'days';
  customInput.id = 'customDays';
  customInput.style.display = 'none';
  customInput.style.width = '80px';
  rangeSel.parentElement.appendChild(customInput);

  const onRangeChange = ()=>{
    const v = rangeSel.value;
    customInput.style.display = (v==='CUSTOM') ? '' : 'none';
    if (v!=='CUSTOM') customInput.value = '';
    init();
  };
  rangeSel.addEventListener('change', onRangeChange);
  customInput.addEventListener('input', debounce(init, 400));

  $('#refreshBtn').addEventListener('click', init);
  $('#unitSel').addEventListener('change', init);
  $('#searchBox').addEventListener('input', debounce(render, 250));

  // ===== Add Item modal wiring =====
 const modal = $('#addItemModal');
const showBtn = $('#showAddItemModal');
const closeBtn = $('.close-btn');
const chipBar = $('#addExpiryChips');
const compSel = $('#addCompartmentSelect');
const qtyInp  = $('#addQty');
const itemInp = $('#addItemInput');
let selectedExp = '';

function endOfMonthISO(year, monthIndexZeroBased){
  const last = new Date(year, monthIndexZeroBased + 1, 0); // day 0 -> last day prev month
  const y = last.getFullYear();
  const m = String(last.getMonth()+1).padStart(2,'0');
  const d = String(last.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

function buildChips(){
  // Create 3 month chips (this + next 2) + a "Custom…" chip
  const now = new Date();
  const chips = [];
  for (let i=0;i<3;i++){
    const d = new Date(now.getFullYear(), now.getMonth()+i, 1);
    const label = d.toLocaleString(undefined,{month:'short',year:'2-digit'});
    const iso   = endOfMonthISO(d.getFullYear(), d.getMonth());
    chips.push({label, iso});
  }
  chipBar.innerHTML = chips.map(c=>`<button class="btn exp-chip" data-exp="${c.iso}">${c.label}</button>`).join('') +
                      `<button class="btn exp-chip custom" data-exp="">Custom…</button>`;

  // Insert custom pickers (hidden until "Custom…" is clicked)
  let customWrap = document.getElementById('customExpiryWrap');
  if (!customWrap){
    customWrap = document.createElement('div');
    customWrap.id = 'customExpiryWrap';
    customWrap.style.display = 'none';
    customWrap.style.marginTop = '8px';
    customWrap.innerHTML = `
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label style="display:flex; align-items:center; gap:6px;">
          <span style="min-width:70px;">Month</span>
          <input id="customMonth" type="month">
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <span style="min-width:70px;">Exact date</span>
          <input id="customDate" type="date">
        </label>
        <button id="applyCustomExp" class="btn">Apply</button>
      </div>`;
    chipBar.insertAdjacentElement('afterend', customWrap);
  }

  // Wire the chips
  chipBar.querySelectorAll('button.exp-chip').forEach(b=>{
    b.addEventListener('click', ()=>{
      // reset borders
      chipBar.querySelectorAll('button.exp-chip').forEach(x=>x.style.borderColor='#ddd');
      b.style.borderColor='blue';

      if (b.classList.contains('custom')){
        // Show custom inputs
        document.getElementById('customExpiryWrap').style.display = '';
        selectedExp = ''; // wait for Apply
      } else {
        // Hide custom inputs and set selectedExp from chip (end-of-month ISO)
        document.getElementById('customExpiryWrap').style.display = 'none';
        selectedExp = b.dataset.exp || '';
      }
    });
  });

  // Apply custom picks:
  document.getElementById('applyCustomExp').onclick = ()=>{
    const monthVal = document.getElementById('customMonth').value; // "YYYY-MM" or ""
    const dateVal  = document.getElementById('customDate').value;  // "YYYY-MM-DD" or ""

    if (dateVal){
      selectedExp = dateVal; // exact date chosen
    } else if (monthVal){
      const [y,m] = monthVal.split('-').map(v=>parseInt(v,10));
      if (y && m){
        selectedExp = endOfMonthISO(y, m-1); // month-only => end-of-month
      }
    } else {
      alert('Pick a month or an exact date.');
      return;
    }
    // Visual feedback
    chipBar.querySelectorAll('button.exp-chip').forEach(x=>x.style.borderColor='#ddd');
    document.getElementById('customExpiryWrap').style.display = 'none';
  };
}

showBtn.addEventListener('click', ()=>{
  selectedExp = '';
  itemInp.value = '';
  compSel.value = '';
  qtyInp.value = '1';
  buildChips();
  updateDatalist();
  modal.style.display='block';
});
closeBtn.addEventListener('click', ()=> modal.style.display='none');
window.addEventListener('click', e=>{ if(e.target===modal) modal.style.display='none'; });

// Save button stays the same, but will now use selectedExp set above:
$('#saveNewItemBtn').addEventListener('click', async ()=>{
  const visibleName = itemInp.value.trim();
  if (!visibleName) { alert('Pick an item name.'); return; }

  // Resolve ItemID by ItemName or ItemNameAlt
  const row = catalog.find(c => [String(c.ItemName||'').toLowerCase(), String(c.ItemNameAlt||'').toLowerCase()].includes(visibleName.toLowerCase()));
  if (!row || !row.ItemID) { alert('Item not found in Catalog.'); return; }

  let unit = $('#unitSel').value;
  if (unit === 'ALL') {
    unit = prompt('Which unit is this for (e.g., 31, 33, 36)?')?.trim() || '';
    if (!unit) return;
  }

  if (!selectedExp) { alert('Pick an expiry (chip or custom).'); return; }
  const payload = {
    itemId: row.ItemID,
    unit,
    compartment: $('#addCompartmentSelect').value.trim(),
    expiry: selectedExp,                  // ISO yyyy-mm-dd
    qty: Number($('#addQty').value)||1,
    crewStatus: ''
  };

  try{
    await postCreate(payload);
    modal.style.display='none';
    await init(); // refresh list
  }catch(e){
    console.error(e);
    alert('Add failed');
  }
});
}
// ===== POSTs (via proxy) =====
async function postUpdate(payload){
  const r = await fetch(PROXY_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ token: TOKEN, actionType:'updateInventory', ...payload })
  });
  let j;
  try { j = await r.json(); } catch(e){
    const txt = await r.text();
    console.error('POST raw text:', txt);
    throw new Error('Non-JSON response');
  }
  if (!j.ok) throw new Error(j.error||'server');
  return j;
}

async function postCreate(payload){
  const r = await fetch(PROXY_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ token: TOKEN, actionType:'createInventory', ...payload })
  });
  let j;
  try { j = await r.json(); } catch(e){
    const txt = await r.text();
    console.error('POST raw text:', txt);
    throw new Error('Non-JSON response');
  }
  if (!j.ok) throw new Error(j.error||'server');
  return j;
}

// ===== init flow =====
async function init(){
  try{
    await loadAll();
    fillUnitSelect();
    render();
  }catch(e){
    console.error(e);
    $('#content').innerHTML = `<p style="color:#a00;font-weight:700;">Error loading data. Check Worker URL & GAS deployment.</p>`;
  }
}

// boot
wireUI();
init();
</script>
</body>
</html>